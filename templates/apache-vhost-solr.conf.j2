# Apache VirtualHost for Solr - Generic Template
# Generated by ansible-role-solr v3.9.0+
# Domain: {{ solr_app_domain }}

<VirtualHost *:80>
    ServerName {{ solr_app_domain }}
    ServerAdmin admin@{{ solr_app_domain.split('.')[-2:] | join('.') }}

    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

    ErrorLog ${APACHE_LOG_DIR}/{{ customer_name }}-solr-error.log
    CustomLog ${APACHE_LOG_DIR}/{{ customer_name }}-solr-access.log combined
</VirtualHost>

<VirtualHost *:443>
    ServerName {{ solr_app_domain }}
    ServerAdmin admin@{{ solr_app_domain.split('.')[-2:] | join('.') }}

    # SSL Configuration (Let's Encrypt)
    SSLEngine on
    SSLCertificateFile {{ solr_ssl_cert_path }}/fullchain.pem
    SSLCertificateKeyFile {{ solr_ssl_cert_path }}/privkey.pem

    # Modern SSL Settings (Mozilla Intermediate Profile)
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLCompression off
    SSLSessionTickets off

    # HSTS (optional - empfohlen für Production)
    # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Reverse Proxy to Docker Solr Container
    ProxyPreserveHost On
    ProxyRequests Off

    # Pass original protocol to Solr (wichtig für SSL-Awareness!)
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    RequestHeader set X-Forwarded-Host "{{ solr_app_domain }}"

    # Solr Proxy Configuration
    ProxyPass {{ solr_proxy_path }} http://127.0.0.1:{{ solr_port }}{{ solr_proxy_path }}
    ProxyPassReverse {{ solr_proxy_path }} http://127.0.0.1:{{ solr_port }}{{ solr_proxy_path }}

    # WebSocket Support (für Solr Admin UI Live-Updates)
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule {{ solr_proxy_path }}/(.*) ws://127.0.0.1:{{ solr_port }}{{ solr_proxy_path }}/$1 [P,L]

    # Security Headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/{{ customer_name }}-solr-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/{{ customer_name }}-solr-ssl-access.log combined

    # Optional: Rate Limiting (gegen Brute-Force auf Auth)
    # <Location "{{ solr_proxy_path }}">
    #     # Max 100 Requests pro 10 Sekunden pro IP
    #     # Requires: a2enmod ratelimit
    #     SetOutputFilter RATE_LIMIT
    #     SetEnv rate-limit 400
    # </Location>
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
