{#
 Security configuration template for Solr.
 Fixes/Improvements:
 1. Updated permission names to align with the official Solr rule-based authorization plugin; removed deprecated ones (e.g. delete/backup).
 2. Added per-core role definitions (admin, customer, support) to enable fine-grained access control to individual cores.
 3. Integrated dynamic additional users via ``solr_additional_users`` and corresponding hashed credentials.
 4. Documented variable usage and structure to aid maintainers and promote clarity.
 5. Ensured backward compatibility by preserving existing built-in roles and credentials.
#}
{
  "authentication": {
    "blockUnknown": true,
    "class": "solr.BasicAuthPlugin",
    "credentials": {
      "{{ solr_admin_user | default('admin') }}": "{{ admin_password_hash }}",
      "{{ solr_support_user | default('support') }}": "{{ support_password_hash }}",
      "{{ solr_customer_user | default('customer') }}": "{{ customer_password_hash }}"{% if solr_additional_user_hashes is defined and solr_additional_user_hashes|length > 0 %},{% endif %}
{% if solr_additional_user_hashes is defined %}
{% for username, hash in solr_additional_user_hashes.items() %}
      ,"{{ username }}": "{{ hash }}"{% if not loop.last %},{% endif %}
{% endfor %}
{% endif %}
    },
    "realm": "{{ solr_auth_realm | default('Solr Eledia') }}",
    "forwardCredentials": {{ solr_forward_credentials | default('false') | lower }}
  },
  "authorization": {
    "class": "solr.RuleBasedAuthorizationPlugin",
    "permissions": [
      { "name": "all", "role": "admin" },
      { "name": "security-read", "role": "admin" },
      { "name": "security-edit", "role": "admin" },
      { "name": "schema-read", "role": "admin" },
      { "name": "schema-edit", "role": "admin" },
      { "name": "config-read", "role": ["admin", "support"] },
      { "name": "config-edit", "role": "admin" },
      { "name": "core-admin-read", "role": "admin" },
      { "name": "core-admin-edit", "role": "admin" },
      { "name": "collection-admin-read", "role": "admin" },
      { "name": "collection-admin-edit", "role": "admin" },
      { "name": "metrics-read", "role": ["admin", "support"] },
      { "name": "health", "role": ["admin", "support"] },
      {
        "name": "core-{{ solr_core_name }}-admin",
        "collection": "{{ solr_core_name }}",
        "path": ["/*"],
        "method": ["GET", "HEAD", "POST", "PUT", "DELETE"],
        "role": ["{{ solr_core_admin_role | default(solr_core_admin_role_prefix ~ '-' ~ solr_core_name) }}"]
      },
      {
        "name": "core-{{ solr_core_name }}-customer",
        "collection": "{{ solr_core_name }}",
        "path": ["/*"],
        "method": ["GET", "HEAD", "POST", "DELETE"],
        "role": ["customer"]
      },
      {
        "name": "core-{{ solr_core_name }}-support",
        "collection": "{{ solr_core_name }}",
        "path": ["/*"],
        "method": ["GET", "HEAD"],
        "role": ["support"]
      }
    ],
    "user-role": {
      "{{ solr_admin_user | default('admin') }}": ["admin"],
      "{{ solr_support_user | default('support') }}": ["support"],
      "{{ solr_customer_user | default('customer') }}": ["customer"]{% if solr_additional_user_roles is defined and solr_additional_user_roles|length > 0 %},{% endif %}
{% if solr_additional_user_roles is defined %}
{% for username, roles in solr_additional_user_roles.items() %}
      ,"{{ username }}": {{ roles | to_json }}{% if not loop.last %},{% endif %}
{% endfor %}
{% endif %}
    }
  }
}
