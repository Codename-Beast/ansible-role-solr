{#
 Security configuration template for Solr (v3.9.8+)

 IMPORTANT LIMITATION (Standalone Mode):
 According to Apache Solr documentation:
 "You can't limit access to a specific core through security.json -
  if you need to limit which users can access which sets of data,
  you'll have to use SolrCloud and the collections parameter."

 Source: https://solr.apache.org/guide/solr/latest/deployment-guide/rule-based-authorization-plugin.html

 This means:
 - In Standalone mode (without ZooKeeper/SolrCloud), collection-specific
   permissions in security.json do NOT work as expected
 - All authenticated users have access to all cores/collections
 - Fine-grained per-core access control requires SolrCloud setup

 Current Implementation:
 - Global permissions only (admin, support, moodle roles)
 - All users can access all cores (Solr Standalone limitation)
 - Admin has full access to security, schema, config APIs
 - Support has read-only access to configs and metrics
 - Moodle has read/write access to all cores for indexing
#}
{% set multi_core = (solr_cores | default([]) | length) > 0 %}
{
  "authentication": {
    "blockUnknown": true,
    "class": "solr.BasicAuthPlugin",
    "credentials": {
      "{{ solr_admin_user | default('admin') }}": "{{ admin_password_hash }}",
      "{{ solr_support_user | default('support') }}": "{{ support_password_hash }}",
      "{{ solr_moodle_user | default('moodle') }}": "{{ moodle_password_hash }}"
{% if solr_additional_user_hashes is defined %}
{% for username, hash in solr_additional_user_hashes.items() %}
      ,"{{ username }}": "{{ hash }}"
{% endfor %}
{% endif %}
{% if multi_core %}
{# Multi-Core Mode: Add all users from all cores #}
{% for core in solr_cores %}
{% if core.users is defined %}
{% for user in core.users %}
{% if user.password_hash is defined %}
      ,"{{ user.username }}": "{{ user.password_hash }}"
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}
    },
    "realm": "{{ solr_auth_realm | default('Solr Eledia') }}",
    "forwardCredentials": {{ solr_forward_credentials | default('false') | lower }}
  },
  "authorization": {
    "class": "solr.RuleBasedAuthorizationPlugin",
    "permissions": [
      {# Health check endpoints - accessible without auth #}
      { "name": "health-check-ping", "path": "/admin/ping", "role": null },
      { "name": "health-check-detailed", "path": "/admin/health", "role": null },
      { "name": "health-check-simple", "path": "/admin/healthcheck", "role": null },

      {# Admin-only operations #}
      { "name": "security-read", "role": "admin" },
      { "name": "security-edit", "role": "admin" },
      { "name": "schema-read", "role": "admin" },
      { "name": "schema-edit", "role": "admin" },
      { "name": "config-edit", "role": "admin" },
      { "name": "core-admin-edit", "role": "admin" },
      { "name": "collection-admin-edit", "role": "admin" },

      {# Support can read configs and metrics #}
      { "name": "config-read", "role": ["admin", "support"] },
      { "name": "core-admin-read", "role": ["admin", "support"] },
      { "name": "collection-admin-read", "role": ["admin", "support"] },
      { "name": "metrics-read", "role": ["admin", "support"] },
      { "name": "health", "role": ["admin", "support"] },

      {# Global read/write permissions - applies to ALL cores in standalone mode #}
      { "name": "read", "role": ["admin", "support", "moodle"] },
      { "name": "update", "role": ["admin", "moodle"] },

      {# Fallback: admin has access to everything #}
      { "name": "all", "role": "admin" }
    ],
    "user-role": {
      "{{ solr_admin_user | default('admin') }}": ["admin"],
      "{{ solr_support_user | default('support') }}": ["support"],
      "{{ solr_moodle_user | default('moodle') }}": ["moodle"]
{% if solr_additional_user_roles is defined %}
{% for username, roles in solr_additional_user_roles.items() %}
      ,"{{ username }}": {{ roles | to_json }}
{% endfor %}
{% endif %}
{% if multi_core %}
{# Multi-Core Mode: Add user-role mappings from cores #}
{# NOTE: In standalone mode, these users will have access to ALL cores, not just their assigned core #}
{% for core in solr_cores %}
{% if core.users is defined %}
{% for user in core.users %}
      ,"{{ user.username }}": {{ user.roles | default(['moodle']) | to_json }}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}
    }
  }
}
