<?xml version="1.0" encoding="UTF-8" ?>
<!--
  Solr Configuration for Moodle 4.0 - 5.0.3
  Generated by Ansible - Version 2.0.0 (v3.9.0+ Multi-Core Optimized)
  Customer: {{ customer_name | default('default') }}
  Timestamp: {{ ansible_date_time.iso8601 }}

  Optimized for:
  - Moodle Global Search mit File-Indexing
  - Multi-Core deployments (caches sind PER-CORE!)
  - Fast indexing and search response
  - Memory-efficient caching (reduced for multi-core)
  - Auto-commit for real-time updates

  Multi-Core Status: {% if solr_multi_core_mode | default(false) %}AKTIV ({{ solr_cores | default([]) | length }} cores){% else %}Single-Core Mode{% endif %}
-->
<config>
  <!-- Lucene Match Version -->
  <luceneMatchVersion>9.9.0</luceneMatchVersion>

  <!-- Data Directory -->
  <dataDir>${solr.data.dir:}</dataDir>

  <!-- Directory Factory -->
  <directoryFactory name="DirectoryFactory" class="${solr.directoryFactory:solr.NRTCachingDirectoryFactory}"/>

  <!-- Schema Factory - Classic Schema for Moodle -->
  <!--
    Using ClassicIndexSchemaFactory instead of ManagedIndexSchemaFactory
    Reasons for Moodle:
    - Moodle has a fixed schema defined in moodle_schema.xml
    - No need for dynamic field addition (Managed Schema feature)
    - Predictable behavior - schema cannot be modified via API
    - Better performance - no schema modification overhead
    - Deterministic deployments - schema is version controlled
  -->
  <schemaFactory class="ClassicIndexSchemaFactory"/>

  <!-- Index Configuration -->
  <indexConfig>
    <!--
      ramBufferSizeMB: WICHTIG für Multi-Core!
      - Solr 9.x default: 100MB
      - Dieser Wert ist PER-CORE (multipliziert sich!)
      - Best Practice Multi-Core: 50-75MB pro Core
      - Single-Core: 100-256MB OK
      - Hard Limit: ~2GB mit diminishing returns >200MB

      Berechnung für Multi-Core:
      4 Cores × 75MB = 300MB total RAM buffer
      6 Cores × 50MB = 300MB total RAM buffer

      Quelle: Apache Solr Performance Guide 2024
    -->
{% if solr_multi_core_mode | default(false) %}
{%   set core_count = solr_cores | default([]) | length %}
{%   if core_count <= 4 %}
    <ramBufferSizeMB>75</ramBufferSizeMB><!-- Multi-Core: {{ core_count }} cores × 75MB = {{ core_count * 75 }}MB total -->
{%   else %}
    <ramBufferSizeMB>50</ramBufferSizeMB><!-- Multi-Core: {{ core_count }} cores × 50MB = {{ core_count * 50 }}MB total -->
{%   endif %}
{% else %}
    <ramBufferSizeMB>100</ramBufferSizeMB><!-- Single-Core: Solr 9.x default -->
{% endif %}
    <maxBufferedDocs>1000</maxBufferedDocs>
    <useCompoundFile>false</useCompoundFile>
    <mergePolicyFactory class="org.apache.solr.index.TieredMergePolicyFactory">
      <int name="maxMergeAtOnce">10</int>
      <int name="segmentsPerTier">10</int>
    </mergePolicyFactory>
    <mergeScheduler class="org.apache.lucene.index.ConcurrentMergeScheduler"/>
    <lockType>${solr.lock.type:native}</lockType>
    <writeLockTimeout>1000</writeLockTimeout>
  </indexConfig>

  <!-- Update Handler -->
  <updateHandler class="solr.DirectUpdateHandler2">
    <updateLog>
      <str name="dir">${solr.ulog.dir:}</str>
      <int name="numVersionBuckets">65536</int>
    </updateLog>

    <!-- Auto Commit - Optimized for Moodle -->
    <autoCommit>
      <maxTime>${solr.autoCommit.maxTime:{{ solr_auto_commit_time | default(15000) }}}</maxTime>
      <maxDocs>1000</maxDocs>
      <openSearcher>false</openSearcher>
    </autoCommit>

    <!-- Auto Soft Commit - For near real-time search -->
    <autoSoftCommit>
      <maxTime>${solr.autoSoftCommit.maxTime:{{ solr_auto_soft_commit_time | default(1000) }}}</maxTime>
    </autoSoftCommit>
  </updateHandler>

  <!-- Query Configuration -->
  <query>
    <maxBooleanClauses>${solr.max.booleanClauses:{{ solr_max_boolean_clauses | default(2048) }}}</maxBooleanClauses>

    <!--
      CACHE CONFIGURATION - KRITISCH für Multi-Core!
      - Alle Caches sind PER-CORE (nicht geteilt!)
      - filterCache: Bis zu 12.5MB pro Entry möglich
      - Best Practice: Caches bei Multi-Core reduzieren

      Single-Core: 512 entries, autowarmCount 128
      Multi-Core:  256 entries, autowarmCount 64

      Beispiel: 4 Cores × 256 entries = 1024 total cache entries
      Quelle: Apache Solr Memory Tuning (Cloudera 2024)
    -->
{% if solr_multi_core_mode | default(false) %}
    <filterCache class="solr.CaffeineCache"
                 size="256"
                 initialSize="256"
                 autowarmCount="64"/><!-- Multi-Core optimiert -->
    <queryResultCache class="solr.CaffeineCache"
                      size="256"
                      initialSize="256"
                      autowarmCount="64"/><!-- Multi-Core optimiert -->
    <documentCache class="solr.CaffeineCache"
                   size="256"
                   initialSize="256"
                   autowarmCount="0"/><!-- Multi-Core optimiert -->
{% else %}
    <filterCache class="solr.CaffeineCache"
                 size="512"
                 initialSize="512"
                 autowarmCount="128"/><!-- Single-Core default -->
    <queryResultCache class="solr.CaffeineCache"
                      size="512"
                      initialSize="512"
                      autowarmCount="128"/><!-- Single-Core default -->
    <documentCache class="solr.CaffeineCache"
                   size="512"
                   initialSize="512"
                   autowarmCount="0"/><!-- Single-Core default -->
{% endif %}
    <cache name="perSegFilter"
           class="solr.CaffeineCache"
           size="10"
           initialSize="0"
           autowarmCount="10"/>
    <enableLazyFieldLoading>true</enableLazyFieldLoading>
    <queryResultWindowSize>20</queryResultWindowSize>
    <queryResultMaxDocsCached>200</queryResultMaxDocsCached>
    <useColdSearcher>false</useColdSearcher>
  </query>

  <!-- Request Dispatcher -->
  <requestDispatcher>
    <requestParsers enableRemoteStreaming="false"
                    multipartUploadLimitInKB="2048000"
                    formdataUploadLimitInKB="2048"
                    addHttpRequestToContext="false"/>
    <httpCaching never304="true"/>
  </requestDispatcher>

  <!-- Request Handlers -->

  <!-- Standard Request Handler -->
  <requestHandler name="/select" class="solr.SearchHandler">
    <lst name="defaults">
      <str name="echoParams">explicit</str>
      <int name="rows">10</int>
      <str name="df">content</str>
      <str name="wt">json</str>
      <str name="indent">true</str>
    </lst>
  </requestHandler>

  <!-- Update Request Handler -->
  <requestHandler name="/update" class="solr.UpdateRequestHandler"/>

  <!-- Moodle-specific Search Handler -->
  <requestHandler name="/moodle" class="solr.SearchHandler">
    <lst name="defaults">
      <str name="echoParams">explicit</str>
      <str name="wt">json</str>
      <str name="indent">true</str>
      <str name="df">content</str>
      <int name="rows">10</int>
      <str name="q.op">AND</str>
      <str name="qf">title^5.0 content^2.0</str>
      <str name="pf">title^10.0 content^5.0</str>
      <int name="ps">3</int>
      <str name="mm">2&lt;-1 5&lt;-2 6&lt;90%</str>
      <bool name="lowercaseOperators">true</bool>
    </lst>
  </requestHandler>

  <!-- Admin Handlers -->
  <requestHandler name="/admin/ping" class="solr.PingRequestHandler">
    <lst name="invariants">
      <str name="q">solrpingquery</str>
    </lst>
    <lst name="defaults">
      <str name="echoParams">all</str>
    </lst>
  </requestHandler>

  <!-- Schema API Handler -->
  <requestHandler name="/schema" class="solr.SchemaHandler">
    <lst name="defaults">
      <str name="df">content</str>
    </lst>
  </requestHandler>

  <!-- Config API Handler -->
  <requestHandler name="/config" class="solr.ConfigHandler">
    <lst name="invariants">
      <str name="enable">true</str>
    </lst>
  </requestHandler>

  <!-- Analysis Request Handler -->
  <requestHandler name="/analysis/field"
                  startup="lazy"
                  class="solr.FieldAnalysisRequestHandler"/>

  <!-- Admin Request Handler -->
  <admin>
    <defaultQuery>*:*</defaultQuery>
  </admin>

  <!-- ====================================================================== -->
  <!-- SOLR 9.9.0 INTERNAL HEALTH CHECK HANDLER                              -->
  <!-- ====================================================================== -->
  <!--
    Solr 9.9.0 HealthCheckHandler is an IMPLICIT handler - it's available
    by default without configuration in solrconfig.xml.

    Available endpoints:
    - /admin/health - Detailed health check with status information

    Usage with request parameters (examples):
    - /admin/health?requireHealthyCores=true
    - /admin/health?maxGenerationLag=100

    The handler is already configured and available. No explicit configuration
    needed in solrconfig.xml. See Solr 9.9.0 documentation for all available
    request parameters.

    For BasicAuth: The endpoint is allowed without authentication in security.json
    (see: permissions for /admin/health with role: null)
  -->

</config>
