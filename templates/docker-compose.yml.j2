# Generated by Ansible - Version 1.6.0
# Customer: {{ customer_name | default('default') }}
# Timestamp: {{ ansible_date_time.iso8601 }}
# Changelog v1.6.0:
#   - NEW: Intelligent backup rotation (max 3 backups)
#   - ADDED: Backups moved to /var/solr/data/old/ instead of /var/solr/backup/
#   - ADDED: Automatic cleanup of oldest backups when limit reached
#   - ADDED: Timestamp-based backup naming for traceability
#   - FIXED: Unlimited backup accumulation preventing disk space issues
#   - IMPACT: Only most recent 3 versions of security.json are kept
# Changelog v1.4.0:
#   - NEW: SSL-Awareness für Solr WebUI (keine HTTP-Warnung mehr)
#   - ADDED: SOLR_URL_SCHEME=https bei aktiviertem SSL
#   - ADDED: SOLR_HOST={{ solr_app_domain }} für korrekte URL-Generierung
#   - ADDED: SOLR_PORT=443 für HTTPS-Links in der WebUI
#   - IMPACT: Solr weiß, dass es hinter HTTPS-Proxy läuft
# Changelog v1.3.9:
#   - CRITICAL FIX: Removed ALL # comments from command block
#   - REASON: YAML command: > folds lines, # comments break shell syntax
#   - IMPACT: Init-container will execute correctly without syntax errors
# Changelog v1.3.8:
#   - CRITICAL FIX: Changed Alpine image from 3.18 to 3.20 to break Docker cache
#   - REASON: Docker Compose was running cached old container command
#   - IMPACT: Forces complete container rebuild with new script

services:
  solr-init:
    image: alpine:3.20
    container_name: {{ solr_container_name }}_powerinit
    volumes:
      - {{ solr_volume_name }}:/var/solr
      - {{ solr_config_dir }}:/config:ro
    command: >
      sh -c "
      set -e;
      echo '========================================';
      echo 'Eledia PowerInit v1.6.0';
      echo 'Deploying ALL configs BEFORE Solr starts';
      echo 'With intelligent backup rotation';
      echo '========================================';

      echo '[1/7] Installing validation tools...';
      apk add --no-cache jq libxml2-utils coreutils;

      echo '[1.5/7] Verifying tools are available...';
      command -v jq >/dev/null || ( echo 'ERROR: jq not found after installation'; exit 1 );
      command -v xmllint >/dev/null || ( echo 'ERROR: xmllint not found after installation'; exit 1 );
      echo 'Validation tools installed successfully';

      echo '[2/7] Creating directories...';
      mkdir -p /var/solr/data;
      mkdir -p /var/solr/data/configs;
      mkdir -p /var/solr/data/lang;
      mkdir -p /var/solr/data/old;

      echo '[3/7] Rotating backups (max 3 versions)...';
      TIMESTAMP=$$(date +%Y%m%d_%H%M%S);

      if [ -f /var/solr/data/security.json ]; then
        echo '  - Moving current security.json to old/';
        cp /var/solr/data/security.json /var/solr/data/old/security.json.$$TIMESTAMP;

        echo '  - Counting existing backups...';
        BACKUP_COUNT=$$(ls -1 /var/solr/data/old/security.json.* 2>/dev/null | wc -l);
        echo \"  - Found $$BACKUP_COUNT backup(s)\";

        if [ $$BACKUP_COUNT -gt 3 ]; then
          echo '  - Removing oldest backups (keeping 3 most recent)...';
          ls -1t /var/solr/data/old/security.json.* | tail -n +4 | while read oldfile; do
            echo \"    Removing: $$(basename $$oldfile)\";
            rm -f \"$$oldfile\";
          done;
        fi;
      else
        echo '  - No existing security.json to backup';
      fi;

      echo '[3.5/7] Rotating config file backups...';
      for file in /var/solr/data/configs/*; do
        if [ -f \"$$file\" ]; then
          BASENAME=$$(basename \"$$file\");
          echo \"  - Backing up $$BASENAME\";
          mkdir -p /var/solr/data/old/configs;
          cp \"$$file\" \"/var/solr/data/old/configs/$${BASENAME}.$${TIMESTAMP}\";

          BACKUP_COUNT=$$(ls -1 /var/solr/data/old/configs/$${BASENAME}.* 2>/dev/null | wc -l);
          if [ $$BACKUP_COUNT -gt 3 ]; then
            ls -1t /var/solr/data/old/configs/$${BASENAME}.* | tail -n +4 | xargs rm -f 2>/dev/null || true;
          fi;
        fi;
      done;

      echo '[4/7] Validating config files...';
      if [ -f /config/security.json ]; then
        echo '  - Validating security.json (JSON)';
        jq empty /config/security.json || ( echo 'ERROR: security.json validation failed!'; exit 1 );
      fi;
      if [ -f /config/solrconfig.xml ]; then
        echo '  - Validating solrconfig.xml (XML)';
        xmllint --noout /config/solrconfig.xml || ( echo 'WARNING: solrconfig.xml validation failed'; exit 1 );
      fi;
      if [ -f /config/moodle_schema.xml ]; then
        echo '  - Validating moodle_schema.xml (XML)';
        xmllint --noout /config/moodle_schema.xml || ( echo 'WARNING: moodle_schema.xml validation failed'; exit 1 );
      fi;

      echo '[5/7] Deploying FRESH config files from Ansible...';
      if [ -f /config/security.json ]; then
        echo '  - Deploying security.json -> /var/solr/data/';
        cp /config/security.json /var/solr/data/security.json;
      fi;
      if [ -f /config/solrconfig.xml ]; then
        echo '  - Deploying solrconfig.xml -> /var/solr/data/configs/';
        cp /config/solrconfig.xml /var/solr/data/configs/solrconfig.xml;
      fi;
      if [ -f /config/moodle_schema.xml ]; then
        echo '  - Deploying moodle_schema.xml -> /var/solr/data/configs/';
        cp /config/moodle_schema.xml /var/solr/data/configs/moodle_schema.xml;
      fi;
      if [ -f /config/stopwords_de.txt ]; then
        echo '  - Deploying stopwords_de.txt -> /var/solr/data/lang/';
        cp /config/stopwords_de.txt /var/solr/data/lang/stopwords_de.txt;
      fi;
      if [ -f /config/stopwords_en.txt ]; then
        echo '  - Deploying stopwords_en.txt -> /var/solr/data/lang/';
        cp /config/stopwords_en.txt /var/solr/data/lang/stopwords_en.txt;
      fi;
      if [ -f /config/stopwords.txt ]; then
        echo '  - Deploying stopwords.txt -> /var/solr/data/lang/';
        cp /config/stopwords.txt /var/solr/data/lang/stopwords.txt;
      fi;
      if [ -f /config/synonyms.txt ]; then
        echo '  - Deploying synonyms.txt -> /var/solr/data/configs/';
        cp /config/synonyms.txt /var/solr/data/configs/synonyms.txt;
      fi;
      if [ -f /config/protwords.txt ]; then
        echo '  - Deploying protwords.txt -> /var/solr/data/configs/';
        cp /config/protwords.txt /var/solr/data/configs/protwords.txt;
      fi;

      echo '[6/7] Setting permissions (8983:8983)...';
      chown -R 8983:8983 /var/solr;
      chmod 600 /var/solr/data/security.json 2>/dev/null || true;

      echo '[7/7] Deployment verification...';
      echo '========================================';
      echo 'Deployment Summary:';
      echo '========================================';
      echo 'ACTIVE CONFIG:';
      ls -lah /var/solr/data/security.json 2>/dev/null || echo '  security.json: NOT FOUND';
      echo '';
      echo 'CONFIG FILES:';
      ls -lah /var/solr/data/configs/ 2>/dev/null || echo '  configs/: EMPTY';
      echo '';
      echo 'BACKUPS (max 3):';
      BACKUP_COUNT=$$(ls -1 /var/solr/data/old/security.json.* 2>/dev/null | wc -l || echo 0);
      echo \"  Total backups: $$BACKUP_COUNT\";
      ls -1t /var/solr/data/old/security.json.* 2>/dev/null | head -3 | while read backup; do
        SIZE=$$(ls -lh \"$$backup\" | awk '{print $$5}');
        echo \"  - $$(basename $$backup) ($$SIZE)\";
      done;
      echo '========================================';
      echo 'Eledia PowerInit v1.6.0: SUCCESS';
      echo 'Source of Truth: Ansible (/config)';
      echo 'Backup Policy: Keep 3 most recent';
      echo '========================================';
      exit 0;
      "
    networks:
      - {{ solr_network_name }}

  solr:
    image: solr:{{ solr_version }}
    container_name: {{ solr_container_name }}
    depends_on:
      solr-init:
        condition: service_completed_successfully
    ports:
      - "127.0.0.1:{{ solr_port }}:8983"
    volumes:
      - {{ solr_volume_name }}:/var/solr
    environment:
      SOLR_HEAP: {{ solr_heap_size }}
      SOLR_JAVA_MEM: "-Xms{{ solr_heap_size }} -Xmx{{ solr_heap_size }}"
      SOLR_OPTS: "{{ solr_gc_options }} {{ solr_jvm_opts }}"
      GC_LOG_OPTS: "-Xlog:gc*:file=/var/solr/logs/solr_gc.log:time,uptime:filecount=9,filesize=20M"
      SOLR_LOG_LEVEL: {{ solr_log_level }}
{% if solr_ssl_enabled | default(false) %}
      # SSL-Awareness: Solr weiß, dass es hinter HTTPS-Proxy läuft
      SOLR_URL_SCHEME: https
      SOLR_HOST: {{ solr_app_domain | default(ansible_fqdn) }}
      SOLR_PORT: 443
{% endif %}
    networks:
      - {{ solr_network_name }}
    restart: unless-stopped
    healthcheck:
      # Uses /admin/ping which is allowed without authentication (see security.json)
      # This ensures health checks work even with BasicAuth enabled
      test: ["CMD-SHELL", "curl -f http://localhost:8983/solr/admin/ping?wt=json || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s 
    deploy:
      resources:
        limits:
          cpus: '{{ (solr_cpu_quota | int / solr_cpu_period | int) | string }}'
          memory: {{ solr_memory_limit }}
          pids: 4096
        reservations:
          cpus: '{{ ((solr_cpu_quota | int / solr_cpu_period | int) * 0.5) | string }}'
          memory: {{ solr_memory_reservation | default(solr_heap_size) }}
    mem_swappiness: 10  # Prefer RAM over swap
    memswap_limit: {{ solr_memory_swap }}

volumes:
  {{ solr_volume_name }}:
    name: {{ solr_volume_name }}

networks:
  {{ solr_network_name }}:
    name: {{ solr_network_name }}
    driver: bridge