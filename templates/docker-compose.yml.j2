# Generated by Ansible - Version 1.4.1
# Customer: {{ customer_name | default('default') }}
# Timestamp: {{ ansible_date_time.iso8601 }}
# Changelog v1.4.1:
#   - CRITICAL FIX: Removed SOLR_PORT=443 from SSL config
#   - REASON: SOLR_PORT tells Solr which port to listen on, not URL generation
#   - FIX: Solr now correctly listens on internal port 8983
#   - IMPACT: Healthcheck and Ansible can now connect to Solr
#   - SSL URLs still work correctly via SOLR_URL_SCHEME and SOLR_HOST
# Changelog v1.4.0:
#   - NEW: SSL-Awareness für Solr WebUI (keine HTTP-Warnung mehr)
#   - ADDED: SOLR_URL_SCHEME=https bei aktiviertem SSL
#   - ADDED: SOLR_HOST={{ solr_app_domain }} für korrekte URL-Generierung
#   - IMPACT: Solr weiß, dass es hinter HTTPS-Proxy läuft

services:
  solr-init:
    image: alpine:3.20
    container_name: {{ solr_container_name }}_powerinit
    volumes:
      - {{ solr_volume_name }}:/var/solr
      - {{ solr_config_dir }}:/config:ro
    command: >
      sh -c "
      set -e;
      echo '========================================';
      echo 'Eledia PowerInit v1.7.0';
      echo 'Deploying ALL configs BEFORE Solr starts';
      echo 'Checksum verification for security.json';
      echo 'NEW: Auto-deploy to configSets + cores';
      echo '=========================================';

      echo '[1/6] Installing validation tools...';
      apk add --no-cache jq libxml2-utils;

      echo '[1.5/6] Verifying tools are available...';
      command -v jq >/dev/null || ( echo 'ERROR: jq not found after installation'; exit 1 );
      command -v xmllint >/dev/null || ( echo 'ERROR: xmllint not found after installation'; exit 1 );
      echo 'Validation tools installed successfully';

      echo '[2/6] Creating directories...';
      mkdir -p /var/solr/data;
      mkdir -p /var/solr/data/configs;
      mkdir -p /var/solr/data/lang;
      mkdir -p /var/solr/backup/configs;

      echo '[3/6] Backing up existing configs...';
      TIMESTAMP=$$(date +%Y%m%d_%H%M%S);
      if [ -f /var/solr/data/security.json ]; then
        echo '  - Backing up security.json';
        cp /var/solr/data/security.json /var/solr/backup/configs/security.json.$$TIMESTAMP 2>/dev/null || true;
      fi;
      for file in /var/solr/data/configs/*; do
        if [ -f \"$$file\" ]; then
          BASENAME=$$(basename \"$$file\");
          echo \"  - Backing up $$BASENAME\";
          cp \"$$file\" \"/var/solr/backup/configs/$${BASENAME}.$${TIMESTAMP}\" 2>/dev/null || true;
        fi;
      done;

      echo '[4/6] Checksum verification for security.json...';
      DEPLOY_SECURITY=false;
      if [ -f /config/security.json ]; then
        NEW_CHECKSUM=$$(sha256sum /config/security.json | awk '{print $$1}');
        echo \"  - New security.json checksum: $$NEW_CHECKSUM\";

        if [ -f /var/solr/data/security.json ]; then
          OLD_CHECKSUM=$$(sha256sum /var/solr/data/security.json | awk '{print $$1}');
          echo \"  - Current security.json checksum: $$OLD_CHECKSUM\";

          if [ \"$$NEW_CHECKSUM\" != \"$$OLD_CHECKSUM\" ]; then
            echo '  - CHECKSUM MISMATCH: New security.json detected!';
            echo '  - Will deploy updated security.json';
            DEPLOY_SECURITY=true;
          else
            echo '  - Checksums match: security.json is up-to-date';
            DEPLOY_SECURITY=false;
          fi;
        else
          echo '  - No existing security.json found';
          echo '  - Will deploy initial security.json';
          DEPLOY_SECURITY=true;
        fi;
      else
        echo '  - WARNING: No security.json in /config/ directory!';
      fi;

      echo '[5/6] Validating config files...';
      if [ -f /config/security.json ]; then
        echo '  - Validating security.json (JSON)';
        jq empty /config/security.json || ( echo 'ERROR: security.json validation failed!'; exit 1 );
      fi;
      if [ -f /config/solrconfig.xml ]; then
        echo '  - Validating solrconfig.xml (XML)';
        xmllint --noout /config/solrconfig.xml || ( echo 'WARNING: solrconfig.xml validation failed'; exit 1 );
      fi;
      if [ -f /config/moodle_schema.xml ]; then
        echo '  - Validating moodle_schema.xml (XML)';
        xmllint --noout /config/moodle_schema.xml || ( echo 'WARNING: moodle_schema.xml validation failed'; exit 1 );
      fi;

      echo '[6/7] Deploying config files...';
      if [ \"$$DEPLOY_SECURITY\" = \"true\" ]; then
        echo '  - Deploying security.json -> /var/solr/data/ (UPDATED)';
        cp /config/security.json /var/solr/data/security.json;
      else
        echo '  - Skipping security.json (already up-to-date)';
      fi;
      if [ -f /config/solrconfig.xml ]; then
        echo '  - Deploying solrconfig.xml -> /var/solr/data/configs/';
        cp /config/solrconfig.xml /var/solr/data/configs/solrconfig.xml;
        echo '  - Updating solrconfig.xml in configSets...';
        for configset in /var/solr/data/configsets/*/conf; do
          if [ -d \"$$configset\" ]; then
            echo \"    -> $$configset/solrconfig.xml\";
            cp /config/solrconfig.xml \"$$configset/solrconfig.xml\";
          fi;
        done;
        echo '  - Updating solrconfig.xml in existing cores...';
        for core_conf in /var/solr/data/*/conf; do
          if [ -d \"$$core_conf\" ] && [ -f \"$$core_conf/core.properties\" ]; then
            echo \"    -> $$core_conf/solrconfig.xml\";
            cp /config/solrconfig.xml \"$$core_conf/solrconfig.xml\";
          fi;
        done;
      fi;
      if [ -f /config/moodle_schema.xml ]; then
        echo '  - Deploying moodle_schema.xml -> /var/solr/data/configs/';
        cp /config/moodle_schema.xml /var/solr/data/configs/moodle_schema.xml;
      fi;
      if [ -f /config/stopwords_de.txt ]; then
        echo '  - Deploying stopwords_de.txt -> /var/solr/data/lang/';
        cp /config/stopwords_de.txt /var/solr/data/lang/stopwords_de.txt;
      fi;
      if [ -f /config/stopwords_en.txt ]; then
        echo '  - Deploying stopwords_en.txt -> /var/solr/data/lang/';
        cp /config/stopwords_en.txt /var/solr/data/lang/stopwords_en.txt;
      fi;
      if [ -f /config/stopwords.txt ]; then
        echo '  - Deploying stopwords.txt -> /var/solr/data/lang/';
        cp /config/stopwords.txt /var/solr/data/lang/stopwords.txt;
      fi;
      if [ -f /config/synonyms.txt ]; then
        echo '  - Deploying synonyms.txt -> /var/solr/data/configs/';
        cp /config/synonyms.txt /var/solr/data/configs/synonyms.txt;
      fi;
      if [ -f /config/protwords.txt ]; then
        echo '  - Deploying protwords.txt -> /var/solr/data/configs/';
        cp /config/protwords.txt /var/solr/data/configs/protwords.txt;
      fi;

      echo '[7/7] Setting permissions (8983:8983)...';
      chown -R 8983:8983 /var/solr;
      chmod 600 /var/solr/data/security.json 2>/dev/null || true;

      echo '========================================';
      echo 'Deployment Summary:';
      echo '========================================';
      if [ \"$$DEPLOY_SECURITY\" = \"true\" ]; then
        echo 'security.json: DEPLOYED (new or updated)';
      else
        echo 'security.json: SKIPPED (checksum match)';
      fi;
      ls -lah /var/solr/data/security.json 2>/dev/null || echo 'security.json: NOT FOUND';
      echo '---';
      ls -lah /var/solr/data/configs/ 2>/dev/null || echo 'configs/: EMPTY';
      echo '========================================';
      echo 'Eledia PowerInit v1.7.0: SUCCESS';
      echo 'NOTE: Cores will auto-reload new configs';
      echo '========================================';
      exit 0;
      "
    networks:
      - {{ solr_network_name }}

  solr:
    image: solr:{{ solr_version }}
    container_name: {{ solr_container_name }}
    depends_on:
      solr-init:
        condition: service_completed_successfully
    ports:
      - "127.0.0.1:{{ solr_port }}:8983"
    volumes:
      - {{ solr_volume_name }}:/var/solr
    environment:
      SOLR_HEAP: {{ solr_heap_size }}
      SOLR_JAVA_MEM: "-Xms{{ solr_heap_size }} -Xmx{{ solr_heap_size }}"
      SOLR_OPTS: "{{ solr_gc_options }} {{ solr_jvm_opts }}"
      GC_LOG_OPTS: "-Xlog:gc*:file=/var/solr/logs/solr_gc.log:time,uptime:filecount=9,filesize=20M"
      SOLR_LOG_LEVEL: {{ solr_log_level }}
{% if solr_ssl_enabled | default(false) %}
      # SSL-Awareness: Solr generates HTTPS URLs in WebUI
      # IMPORTANT: Solr still listens on internal port 8983
      # Only SOLR_URL_SCHEME and SOLR_HOST affect generated URLs
      SOLR_URL_SCHEME: https
      SOLR_HOST: {{ solr_app_domain | default(ansible_fqdn) }}
{% endif %}
    networks:
      - {{ solr_network_name }}
    restart: unless-stopped
    healthcheck:
      # Uses /admin/ping which is allowed without authentication (see security.json)
      # This ensures health checks work even with BasicAuth enabled
      test: ["CMD-SHELL", "curl -f http://localhost:8983/solr/admin/ping?wt=json || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s 
    deploy:
      resources:
        limits:
          cpus: '{{ (solr_cpu_quota | int / solr_cpu_period | int) | string }}'
          memory: {{ solr_memory_limit }}
          pids: 4096
        reservations:
          cpus: '{{ ((solr_cpu_quota | int / solr_cpu_period | int) * 0.5) | string }}'
          memory: {{ solr_memory_reservation | default(solr_heap_size) }}
    mem_swappiness: 10  # Prefer RAM over swap
    memswap_limit: {{ solr_memory_swap }}

volumes:
  {{ solr_volume_name }}:
    name: {{ solr_volume_name }}

networks:
  {{ solr_network_name }}:
    name: {{ solr_network_name }}
    driver: bridge