# Generated by Ansible - Version 1.7.0
# Customer: {{ customer_name | default('default') }}
# Timestamp: {{ ansible_date_time.iso8601 }}
# Changelog v1.7.0:
#   - NEW: SHA256 checksum verification for security.json
#   - ADDED: Ensures deployed version matches Ansible source
#   - ADDED: Force-deploy flag when checksums differ
#   - ADDED: Deployment verification with checksum comparison
#   - FIXED: Healthcheck with longer start_period (120s)
#   - FIXED: Better healthcheck logging and debugging
#   - IMPACT: Guarantees current security.json is always deployed
# Changelog v1.6.0:
#   - NEW: Intelligent backup rotation (max 3 backups)
#   - ADDED: Backups moved to /var/solr/data/old/ instead of /var/solr/backup/
#   - ADDED: Automatic cleanup of oldest backups when limit reached
#   - ADDED: Timestamp-based backup naming for traceability
#   - FIXED: Unlimited backup accumulation preventing disk space issues
#   - IMPACT: Only most recent 3 versions of security.json are kept
# Changelog v1.4.0:
#   - NEW: SSL-Awareness für Solr WebUI (keine HTTP-Warnung mehr)
#   - ADDED: SOLR_URL_SCHEME=https bei aktiviertem SSL
#   - ADDED: SOLR_HOST={{ solr_app_domain }} für korrekte URL-Generierung
#   - ADDED: SOLR_PORT=443 für HTTPS-Links in der WebUI
#   - IMPACT: Solr weiß, dass es hinter HTTPS-Proxy läuft
# Changelog v1.3.9:
#   - CRITICAL FIX: Removed ALL # comments from command block
#   - REASON: YAML command: > folds lines, # comments break shell syntax
#   - IMPACT: Init-container will execute correctly without syntax errors
# Changelog v1.3.8:
#   - CRITICAL FIX: Changed Alpine image from 3.18 to 3.20 to break Docker cache
#   - REASON: Docker Compose was running cached old container command
#   - IMPACT: Forces complete container rebuild with new script

services:
  solr-init:
    image: alpine:3.20
    container_name: {{ solr_container_name }}_powerinit
    volumes:
      - {{ solr_volume_name }}:/var/solr
      - {{ solr_config_dir }}:/config:ro
    command: >
      sh -c "
      set -e;
      echo '========================================';
      echo 'Eledia PowerInit v1.7.0';
      echo 'Deploying ALL configs BEFORE Solr starts';
      echo 'With checksum verification & backup rotation';
      echo '========================================';

      echo '[1/8] Installing validation tools...';
      apk add --no-cache jq libxml2-utils coreutils;

      echo '[1.5/8] Verifying tools are available...';
      command -v jq >/dev/null || ( echo 'ERROR: jq not found after installation'; exit 1 );
      command -v xmllint >/dev/null || ( echo 'ERROR: xmllint not found after installation'; exit 1 );
      command -v sha256sum >/dev/null || ( echo 'ERROR: sha256sum not found'; exit 1 );
      echo 'Validation tools installed successfully';

      echo '[2/8] Calculating checksums for verification...';
      if [ -f /config/security.json ]; then
        SOURCE_CHECKSUM=$$(sha256sum /config/security.json | awk '{print $$1}');
        echo \"  Source (Ansible): $$SOURCE_CHECKSUM\";
      else
        echo '  ERROR: /config/security.json not found!';
        exit 1;
      fi;

      if [ -f /var/solr/data/security.json ]; then
        DEPLOYED_CHECKSUM=$$(sha256sum /var/solr/data/security.json | awk '{print $$1}');
        echo \"  Deployed (Current): $$DEPLOYED_CHECKSUM\";
      else
        DEPLOYED_CHECKSUM='none';
        echo '  Deployed: NOT EXISTS (first run)';
      fi;

      if [ \"$$SOURCE_CHECKSUM\" = \"$$DEPLOYED_CHECKSUM\" ]; then
        echo '  ✅ MATCH - Deployed version is current';
        FORCE_DEPLOY=false;
      else
        echo '  ⚠️  MISMATCH - Will deploy fresh version';
        FORCE_DEPLOY=true;
      fi;

      echo '[3/8] Creating directories...';
      mkdir -p /var/solr/data;
      mkdir -p /var/solr/data/configs;
      mkdir -p /var/solr/data/lang;
      mkdir -p /var/solr/data/old;

      echo '[4/8] Rotating backups (max 3 versions)...';
      TIMESTAMP=$$(date +%Y%m%d_%H%M%S);

      if [ \"$$FORCE_DEPLOY\" = \"true\" ]; then
        if [ -f /var/solr/data/security.json ]; then
          echo '  - Moving current security.json to old/';
          cp /var/solr/data/security.json /var/solr/data/old/security.json.$$TIMESTAMP;

          echo '  - Counting existing backups...';
          BACKUP_COUNT=$$(ls -1 /var/solr/data/old/security.json.* 2>/dev/null | wc -l);
          echo \"  - Found $$BACKUP_COUNT backup(s)\";

          if [ $$BACKUP_COUNT -gt 3 ]; then
            echo '  - Removing oldest backups (keeping 3 most recent)...';
            ls -1t /var/solr/data/old/security.json.* | tail -n +4 | while read oldfile; do
              echo \"    Removing: $$(basename $$oldfile)\";
              rm -f \"$$oldfile\";
            done;
          fi;
        else
          echo '  - No existing security.json to backup (first deployment)';
        fi;

        echo '[4.5/8] Rotating config file backups...';
        for file in /var/solr/data/configs/*; do
          if [ -f \"$$file\" ]; then
            BASENAME=$$(basename \"$$file\");
            echo \"  - Backing up $$BASENAME\";
            mkdir -p /var/solr/data/old/configs;
            cp \"$$file\" \"/var/solr/data/old/configs/$${BASENAME}.$${TIMESTAMP}\";

            BACKUP_COUNT=$$(ls -1 /var/solr/data/old/configs/$${BASENAME}.* 2>/dev/null | wc -l);
            if [ $$BACKUP_COUNT -gt 3 ]; then
              ls -1t /var/solr/data/old/configs/$${BASENAME}.* | tail -n +4 | xargs rm -f 2>/dev/null || true;
            fi;
          fi;
        done;
      else
        echo '  - Skipping backup (no changes detected)';
      fi;

      echo '[5/8] Validating config files...';
      if [ -f /config/security.json ]; then
        echo '  - Validating security.json (JSON)';
        jq empty /config/security.json || ( echo 'ERROR: security.json validation failed!'; exit 1 );
      fi;
      if [ -f /config/solrconfig.xml ]; then
        echo '  - Validating solrconfig.xml (XML)';
        xmllint --noout /config/solrconfig.xml || ( echo 'WARNING: solrconfig.xml validation failed'; exit 1 );
      fi;
      if [ -f /config/moodle_schema.xml ]; then
        echo '  - Validating moodle_schema.xml (XML)';
        xmllint --noout /config/moodle_schema.xml || ( echo 'WARNING: moodle_schema.xml validation failed'; exit 1 );
      fi;

      echo '[6/8] Deploying FRESH config files from Ansible...';
      if [ \"$$FORCE_DEPLOY\" = \"true\" ]; then
        if [ -f /config/security.json ]; then
          echo '  - Deploying security.json -> /var/solr/data/ (FORCED)';
          cp /config/security.json /var/solr/data/security.json;
        fi;
      else
        echo '  - Skipping deployment (checksums match)';
      fi;
      if [ -f /config/solrconfig.xml ]; then
        echo '  - Deploying solrconfig.xml -> /var/solr/data/configs/';
        cp /config/solrconfig.xml /var/solr/data/configs/solrconfig.xml;
      fi;
      if [ -f /config/moodle_schema.xml ]; then
        echo '  - Deploying moodle_schema.xml -> /var/solr/data/configs/';
        cp /config/moodle_schema.xml /var/solr/data/configs/moodle_schema.xml;
      fi;
      if [ -f /config/stopwords_de.txt ]; then
        echo '  - Deploying stopwords_de.txt -> /var/solr/data/lang/';
        cp /config/stopwords_de.txt /var/solr/data/lang/stopwords_de.txt;
      fi;
      if [ -f /config/stopwords_en.txt ]; then
        echo '  - Deploying stopwords_en.txt -> /var/solr/data/lang/';
        cp /config/stopwords_en.txt /var/solr/data/lang/stopwords_en.txt;
      fi;
      if [ -f /config/stopwords.txt ]; then
        echo '  - Deploying stopwords.txt -> /var/solr/data/lang/';
        cp /config/stopwords.txt /var/solr/data/lang/stopwords.txt;
      fi;
      if [ -f /config/synonyms.txt ]; then
        echo '  - Deploying synonyms.txt -> /var/solr/data/configs/';
        cp /config/synonyms.txt /var/solr/data/configs/synonyms.txt;
      fi;
      if [ -f /config/protwords.txt ]; then
        echo '  - Deploying protwords.txt -> /var/solr/data/configs/';
        cp /config/protwords.txt /var/solr/data/configs/protwords.txt;
      fi;

      echo '[7/8] Setting permissions (8983:8983)...';
      chown -R 8983:8983 /var/solr;
      chmod 600 /var/solr/data/security.json 2>/dev/null || true;

      echo '[8/8] FINAL VERIFICATION with checksum comparison...';
      FINAL_DEPLOYED_CHECKSUM=$$(sha256sum /var/solr/data/security.json | awk '{print $$1}');

      echo '========================================';
      echo 'DEPLOYMENT VERIFICATION';
      echo '========================================';
      echo \"Source (Ansible):  $$SOURCE_CHECKSUM\";
      echo \"Deployed (Active): $$FINAL_DEPLOYED_CHECKSUM\";
      echo '';

      if [ \"$$SOURCE_CHECKSUM\" = \"$$FINAL_DEPLOYED_CHECKSUM\" ]; then
        echo '✅ VERIFICATION PASSED';
        echo '   Deployed version matches Ansible source';
        VERIFICATION_STATUS='PASSED';
      else
        echo '❌ VERIFICATION FAILED';
        echo '   Checksum mismatch detected!';
        echo '   This should never happen - deployment failed!';
        exit 1;
      fi;

      echo '========================================';
      echo 'Deployment Summary:';
      echo '========================================';
      echo 'ACTIVE CONFIG:';
      ls -lah /var/solr/data/security.json 2>/dev/null || echo '  security.json: NOT FOUND';
      echo '';
      echo 'CONFIG FILES:';
      ls -lah /var/solr/data/configs/ 2>/dev/null || echo '  configs/: EMPTY';
      echo '';
      echo 'BACKUPS (max 3):';
      BACKUP_COUNT=$$(ls -1 /var/solr/data/old/security.json.* 2>/dev/null | wc -l || echo 0);
      echo \"  Total backups: $$BACKUP_COUNT\";
      ls -1t /var/solr/data/old/security.json.* 2>/dev/null | head -3 | while read backup; do
        SIZE=$$(ls -lh \"$$backup\" | awk '{print $$5}');
        echo \"  - $$(basename $$backup) ($$SIZE)\";
      done;
      echo '';
      echo 'DEPLOYMENT STATS:';
      echo \"  Force Deploy: $$FORCE_DEPLOY\";
      echo \"  Verification: $$VERIFICATION_STATUS\";
      echo \"  Source Checksum: $$SOURCE_CHECKSUM\";
      echo '========================================';
      echo 'Eledia PowerInit v1.7.0: SUCCESS';
      echo 'Source of Truth: Ansible (/config)';
      echo 'Backup Policy: Keep 3 most recent';
      echo 'Checksum Verified: YES';
      echo '========================================';
      exit 0;
      "
    networks:
      - {{ solr_network_name }}

  solr:
    image: solr:{{ solr_version }}
    container_name: {{ solr_container_name }}
    depends_on:
      solr-init:
        condition: service_completed_successfully
    ports:
      - "127.0.0.1:{{ solr_port }}:8983"
    volumes:
      - {{ solr_volume_name }}:/var/solr
    environment:
      SOLR_HEAP: {{ solr_heap_size }}
      SOLR_JAVA_MEM: "-Xms{{ solr_heap_size }} -Xmx{{ solr_heap_size }}"
      SOLR_OPTS: "{{ solr_gc_options }} {{ solr_jvm_opts }}"
      GC_LOG_OPTS: "-Xlog:gc*:file=/var/solr/logs/solr_gc.log:time,uptime:filecount=9,filesize=20M"
      SOLR_LOG_LEVEL: {{ solr_log_level }}
{% if solr_ssl_enabled | default(false) %}
      # SSL-Awareness: Solr weiß, dass es hinter HTTPS-Proxy läuft
      SOLR_URL_SCHEME: https
      SOLR_HOST: {{ solr_app_domain | default(ansible_fqdn) }}
      SOLR_PORT: 443
{% endif %}
    networks:
      - {{ solr_network_name }}
    restart: unless-stopped
    healthcheck:
      # Uses /admin/ping which is allowed without authentication (see security.json)
      # This ensures health checks work even with BasicAuth enabled
      # Extended start_period (120s) to allow full Solr initialization
      test: ["CMD-SHELL", "curl -sf http://localhost:8983/solr/admin/ping?wt=json 2>&1 | grep -q '\"status\":\"OK\"' || exit 1"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 120s 
    deploy:
      resources:
        limits:
          cpus: '{{ (solr_cpu_quota | int / solr_cpu_period | int) | string }}'
          memory: {{ solr_memory_limit }}
          pids: 4096
        reservations:
          cpus: '{{ ((solr_cpu_quota | int / solr_cpu_period | int) * 0.5) | string }}'
          memory: {{ solr_memory_reservation | default(solr_heap_size) }}
    mem_swappiness: 10  # Prefer RAM over swap
    memswap_limit: {{ solr_memory_swap }}

volumes:
  {{ solr_volume_name }}:
    name: {{ solr_volume_name }}

networks:
  {{ solr_network_name }}:
    name: {{ solr_network_name }}
    driver: bridge