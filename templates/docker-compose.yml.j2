# Generated by Ansible - Version 1.3.4 
# Customer: {{ customer_name | default('default') }}
# Timestamp: {{ ansible_date_time.iso8601 }}
# Changelog v1.3.4: 
#   - Fixed healthcheck to work with BasicAuth enabled 
#   - Changed healthcheck endpoint to /solr without auth requirement 

services:
  solr-init:
    image: alpine:3.18
    container_name: {{ solr_container_name }}_powerinit
    volumes:
      - {{ solr_volume_name }}:/var/solr
      - {{ solr_config_dir }}:/config:ro
    command: >
      sh -c "
      echo 'Eledia PowerInit: Deploying security.json BEFORE Solr starts';
      mkdir -p /var/solr/data;
      cp /config/security.json /var/solr/data/security.json;
      chown -R 8983:8983 /var/solr;
      #chmod 600 /var/solr/data/security.json;
      echo 'Eledia PowerInit: security.json deployed successfully';
      ls -la /var/solr/data/security.json;
      exit 0;
      "
    networks:
      - {{ solr_network_name }}

  solr:
    image: solr:{{ solr_version }}
    container_name: {{ solr_container_name }}
    depends_on:
      solr-init:
        condition: service_completed_successfully
    ports:
      - "127.0.0.1:{{ solr_port }}:8983"
    volumes:
      - {{ solr_volume_name }}:/var/solr
    environment:
      SOLR_HEAP: {{ solr_heap_size }}
      SOLR_JAVA_MEM: "-Xms{{ solr_heap_size }} -Xmx{{ solr_heap_size }}"
      SOLR_LOG_LEVEL: {{ solr_log_level }}
    networks:
      - {{ solr_network_name }}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f -s http://localhost:8983/solr/ | grep -q 'Solr Admin' || exit 1"] 
      interval: 30s 
      timeout: 10s
      retries: 5
      start_period: 60s 
    deploy:
      resources:
        limits:
          memory: {{ solr_memory_limit }}
        reservations:
          memory: {{ solr_heap_size }}

volumes:
  {{ solr_volume_name }}:
    name: {{ solr_volume_name }}

networks:
  {{ solr_network_name }}:
    name: {{ solr_network_name }}
    driver: bridge