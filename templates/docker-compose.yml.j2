# Generated by Ansible - Version 1.3.5
# Customer: {{ customer_name | default('default') }}
# Timestamp: {{ ansible_date_time.iso8601 }}
# Changelog v1.3.5:
#   - CRITICAL FIX: apk add error handling (removed || true trap)
#   - FIXED: Package installation failures now properly detected
#   - IMPROVED: Better error messages for network/DNS issues
# Changelog v1.3.2:
#   - CRITICAL FIX: Corrected shell escaping in backup loop (removed \")
#   - IMPROVED: Better healthcheck (tests actual Solr API)
#   - ADDED: Rollback on init failure
# Changelog v1.3.1:
#   - EXTENDED: Init-container now deploys ALL configs (security.json, schemas, stopwords, etc.)
#   - ADDED: Config backup before deployment (timestamp-based)
#   - ADDED: Detailed logging of all deployed files
#   - ADDED: Config validation (JSON/XML syntax checks) 

services:
  solr-init:
    image: alpine:3.18
    container_name: {{ solr_container_name }}_powerinit
    volumes:
      - {{ solr_volume_name }}:/var/solr
      - {{ solr_config_dir }}:/config:ro
    command: >
      sh -c "
      set -e;
      echo '========================================';
      echo 'Eledia PowerInit v1.4.0';
      echo 'Deploying ALL configs BEFORE Solr starts';
      echo '========================================';

      # Install required tools
      echo '[1/6] Installing validation tools...';
      if ! apk add --no-cache jq libxml2-utils 2>&1; then
        echo 'ERROR: Package installation failed!';
        echo 'Possible causes: network timeout, repository unavailable, DNS failure';
        echo 'Trying to show detailed error:';
        apk update;
        apk add --no-cache jq libxml2-utils;
        exit 1;
      fi;
      echo '[1.5/6] Verifying tools are available...';
      if ! command -v jq >/dev/null || ! command -v xmllint >/dev/null; then
        echo 'ERROR: Validation tools not available after installation';
        echo 'jq available: '$(command -v jq || echo 'NO');
        echo 'xmllint available: '$(command -v xmllint || echo 'NO');
        exit 1;
      fi;
      echo 'Validation tools installed successfully';

      # Create required directories
      echo '[2/6] Creating directories...';
      mkdir -p /var/solr/data;
      mkdir -p /var/solr/data/configs;
      mkdir -p /var/solr/backup/configs;

      # Backup existing configs (if they exist and differ)
      echo '[3/6] Backing up existing configs...';
      TIMESTAMP=$$(date +%Y%m%d_%H%M%S);
      if [ -f /var/solr/data/security.json ]; then
        echo '  - Backing up security.json';
        cp /var/solr/data/security.json /var/solr/backup/configs/security.json.$$TIMESTAMP 2>/dev/null || true;
      fi;
      for file in /var/solr/data/configs/*; do
        if [ -f "$$file" ]; then
          BASENAME=$$(basename "$$file");
          echo "  - Backing up $$BASENAME";
          cp "$$file" "/var/solr/backup/configs/$${BASENAME}.$${TIMESTAMP}" 2>/dev/null || true;
        fi;
      done;

      # Validate config files
      echo '[4/6] Validating config files...';
      if [ -f /config/security.json ]; then
        echo '  - Validating security.json (JSON)';
        jq empty /config/security.json || { echo 'ERROR: security.json validation failed!'; exit 1; };
      fi;
      if [ -f /config/solrconfig.xml ]; then
        echo '  - Validating solrconfig.xml (XML)';
        xmllint --noout /config/solrconfig.xml || { echo 'WARNING: solrconfig.xml validation failed'; };
      fi;
      if [ -f /config/moodle_schema.xml ]; then
        echo '  - Validating moodle_schema.xml (XML)';
        xmllint --noout /config/moodle_schema.xml || { echo 'WARNING: moodle_schema.xml validation failed'; };
      fi;

      # Deploy all config files
      echo '[5/6] Deploying config files...';
      if [ -f /config/security.json ]; then
        echo '  - Deploying security.json -> /var/solr/data/';
        cp /config/security.json /var/solr/data/security.json;
      fi;
      if [ -f /config/solrconfig.xml ]; then
        echo '  - Deploying solrconfig.xml -> /var/solr/data/configs/';
        cp /config/solrconfig.xml /var/solr/data/configs/solrconfig.xml;
      fi;
      if [ -f /config/moodle_schema.xml ]; then
        echo '  - Deploying moodle_schema.xml -> /var/solr/data/configs/';
        cp /config/moodle_schema.xml /var/solr/data/configs/moodle_schema.xml;
      fi;
      if [ -f /config/stopwords_de.txt ]; then
        echo '  - Deploying stopwords_de.txt -> /var/solr/data/configs/';
        cp /config/stopwords_de.txt /var/solr/data/configs/stopwords_de.txt;
      fi;
      if [ -f /config/stopwords_en.txt ]; then
        echo '  - Deploying stopwords_en.txt -> /var/solr/data/configs/';
        cp /config/stopwords_en.txt /var/solr/data/configs/stopwords_en.txt;
      fi;
      if [ -f /config/stopwords.txt ]; then
        echo '  - Deploying stopwords.txt -> /var/solr/data/configs/';
        cp /config/stopwords.txt /var/solr/data/configs/stopwords.txt;
      fi;
      if [ -f /config/synonyms.txt ]; then
        echo '  - Deploying synonyms.txt -> /var/solr/data/configs/';
        cp /config/synonyms.txt /var/solr/data/configs/synonyms.txt;
      fi;
      if [ -f /config/protwords.txt ]; then
        echo '  - Deploying protwords.txt -> /var/solr/data/configs/';
        cp /config/protwords.txt /var/solr/data/configs/protwords.txt;
      fi;

      # Set permissions
      echo '[6/6] Setting permissions (8983:8983)...';
      chown -R 8983:8983 /var/solr;
      chmod 600 /var/solr/data/security.json 2>/dev/null || true;

      # Summary
      echo '========================================';
      echo 'Deployment Summary:';
      echo '========================================';
      ls -lah /var/solr/data/security.json 2>/dev/null || echo 'security.json: NOT FOUND';
      echo '---';
      ls -lah /var/solr/data/configs/ 2>/dev/null || echo 'configs/: EMPTY';
      echo '========================================';
      echo 'Eledia PowerInit: SUCCESS';
      echo '========================================';
      exit 0;
      "
    networks:
      - {{ solr_network_name }}

  solr:
    image: solr:{{ solr_version }}
    container_name: {{ solr_container_name }}
    depends_on:
      solr-init:
        condition: service_completed_successfully
    ports:
      - "127.0.0.1:{{ solr_port }}:8983"
    volumes:
      - {{ solr_volume_name }}:/var/solr
    environment:
      SOLR_HEAP: {{ solr_heap_size }}
      SOLR_JAVA_MEM: "-Xms{{ solr_heap_size }} -Xmx{{ solr_heap_size }}"
      SOLR_LOG_LEVEL: {{ solr_log_level }}
    networks:
      - {{ solr_network_name }}
    restart: unless-stopped
    healthcheck:
      # Uses /admin/ping which is allowed without authentication (see security.json)
      # This ensures health checks work even with BasicAuth enabled
      test: ["CMD-SHELL", "curl -f http://localhost:8983/solr/admin/ping?wt=json || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s 
    deploy:
      resources:
        limits:
          memory: {{ solr_memory_limit }}
        reservations:
          memory: {{ solr_heap_size }}

volumes:
  {{ solr_volume_name }}:
    name: {{ solr_volume_name }}

networks:
  {{ solr_network_name }}:
    name: {{ solr_network_name }}
    driver: bridge