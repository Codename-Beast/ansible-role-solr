# by {{ ansible_managed }}
# Version: 1.0.0

# Solr Proxy Configuration
<Location {{ solr_proxy_path | default('/__solr') }}>
    # Authentication (optional)
    {% if solr_proxy_auth_enabled | default(false) %}
    AuthType Basic
    AuthName "Solr Admin Access"
    AuthUserFile /etc/apache2/solr.htpasswd
    Require valid-user
    {% endif %}
    
    # Proxy settings
    ProxyPass http://127.0.0.1:{{ solr_port }}/solr
    ProxyPassReverse http://127.0.0.1:{{ solr_port }}/solr
    
    # Headers
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    RequestHeader set X-Forwarded-Host "{{ solr_app_domain | default(ansible_fqdn) }}"
    
    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    
    # Proxy timeout settings
    ProxyTimeout 300
    ProxyBadHeader Ignore
    
    # Allow methods
    <LimitExcept GET POST PUT DELETE HEAD OPTIONS>
        Require all denied
    </LimitExcept>
</Location>

# Redirect for trailing slash
<Location = {{ solr_proxy_path | default('/__solr') }}>
    RedirectMatch 301 ^{{ solr_proxy_path | default('/__solr') }}$ {{ solr_proxy_path | default('/__solr') }}/
</Location>

# Static resources
<LocationMatch "^{{ solr_proxy_path | default('/__solr') }}/(css|js|img)/">
    ProxyPass http://127.0.0.1:{{ solr_port }}/solr$1/
    ProxyPassReverse http://127.0.0.1:{{ solr_port }}/solr$1/
    
    # Cache static resources
    Header set Cache-Control "public, max-age=3600"
</LocationMatch>

# Admin interface
<Location {{ solr_proxy_path | default('/__solr') }}/admin>
    ProxyPass http://127.0.0.1:{{ solr_port }}/solr/admin
    ProxyPassReverse http://127.0.0.1:{{ solr_port }}/solr/admin
    
    {% if solr_restrict_admin | default(true) %}
    # Restrict admin access to specific IPs
    <RequireAll>
        Require ip 127.0.0.1
        Require ip ::1
        {% for ip in solr_admin_allowed_ips | default([]) %}
        Require ip {{ ip }}
        {% endfor %}
    </RequireAll>
    {% endif %}
</Location>

# Core-specific access
<Location {{ solr_proxy_path | default('/__solr') }}/{{ solr_core_name | default('default_core') }}>
    ProxyPass http://127.0.0.1:{{ solr_port }}/solr/{{ solr_core_name | default('default_core') }}
    ProxyPassReverse http://127.0.0.1:{{ solr_port }}/solr/{{ solr_core_name | default('default_core') }}
</Location>