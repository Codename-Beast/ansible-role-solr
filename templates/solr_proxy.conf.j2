# by {{ ansible_managed }}
# Version: 1.1.0
# Fixed: Correct ProxyPass for subpath, added HTTPS support

# Solr Proxy Configuration
<Location {{ solr_proxy_path | default('/solr-admin') }}>
    # Authentication (optional)
    {% if solr_proxy_auth_enabled | default(false) %}
    AuthType Basic
    AuthName "Solr Admin Access"
    AuthUserFile /etc/apache2/solr.htpasswd
    Require valid-user
    {% endif %}

    # Proxy settings - CRITICAL: nocanon prevents path encoding issues
    ProxyPass http://127.0.0.1:{{ solr_port }}/solr nocanon
    ProxyPassReverse http://127.0.0.1:{{ solr_port }}/solr

    # Headers
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    RequestHeader set X-Forwarded-Host "{{ solr_app_domain | default(ansible_fqdn) }}"

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Proxy timeout settings
    ProxyTimeout 300
    ProxyBadHeader Ignore

    # Allow methods
    <LimitExcept GET POST PUT DELETE HEAD OPTIONS>
        Require all denied
    </LimitExcept>
</Location>

# Redirect for trailing slash
RedirectMatch 301 ^{{ solr_proxy_path | default('/solr-admin') }}$ {{ solr_proxy_path | default('/solr-admin') }}/

# Admin interface - Restrict access
<Location {{ solr_proxy_path | default('/solr-admin') }}/admin>
    {% if solr_restrict_admin | default(true) %}
    # Restrict admin access to specific IPs
    <RequireAll>
        Require ip 127.0.0.1
        Require ip ::1
        {% for ip in solr_admin_allowed_ips | default([]) %}
        Require ip {{ ip }}
        {% endfor %}
    </RequireAll>
    {% endif %}
</Location>