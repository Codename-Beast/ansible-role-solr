#!/bin/bash
# Solr Backup Script for {{ customer_name }}
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

set -euo pipefail

# Configuration
CONTAINER_NAME="{{ solr_container_name }}"
CORE_NAME="{{ solr_core_name }}"
BACKUP_PATH="{{ solr_backup_path }}"
RETENTION_DAYS="{{ solr_backup_retention }}"
COMPRESS="{{ 'true' if solr_backup_compress else 'false' }}"

# Functions
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1" >&2
    exit 1
}

# Check if container is running
if ! docker ps | grep -q "$CONTAINER_NAME"; then
    error "Container $CONTAINER_NAME is not running"
fi

# Generate timestamp
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="backup_${TIMESTAMP}"

log "Starting backup of core $CORE_NAME to $BACKUP_NAME"

# Prepare backup command
BACKUP_CMD="solr backup -c $CORE_NAME -d $BACKUP_PATH -name $BACKUP_NAME"
if [ "$COMPRESS" = "true" ]; then
    BACKUP_CMD="$BACKUP_CMD -z"
fi

# Execute backup
if docker exec "$CONTAINER_NAME" $BACKUP_CMD; then
    log "âœ… Backup completed successfully: $BACKUP_NAME"
    
    # Cleanup old backups
    log "Cleaning up backups older than $RETENTION_DAYS days"
    find "$BACKUP_PATH" -name "backup_*" -type d -mtime +$RETENTION_DAYS -exec rm -rf {} \; 2>/dev/null || true
    
    # Show backup status
    BACKUP_COUNT=$(find "$BACKUP_PATH" -name "backup_*" -type d | wc -l)
    log "Total backups available: $BACKUP_COUNT"
    
    exit 0
else
    error "Backup failed for core $CORE_NAME"
fi