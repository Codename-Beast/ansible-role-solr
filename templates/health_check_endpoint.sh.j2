#!/bin/bash
# Version: 1.1.0
# Description: Solr health check endpoint for Rundeck integration
# Generated by Ansible: {{ ansible_date_time.iso8601 }}

set -euo pipefail

CONTAINER="{{ solr_container_name }}"
PORT="{{ solr_port }}"
OUTPUT_FORMAT="${1:-json}"

check_container() {
    if ! docker ps --format "{% raw %}{{.Names}}{% endraw %}" | grep -q "^${CONTAINER}$"; then
        return 1
    fi
    return 0
}

check_health_status() {
    local status
    status=$(docker inspect "${CONTAINER}" --format '{% raw %}{{.State.Health.Status}}{% endraw %}' 2>/dev/null || echo "unknown")
    echo "${status}"
}

check_http_endpoint() {
    local http_code
    http_code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${PORT}/solr/admin/ping" 2>/dev/null || echo "000")
    echo "${http_code}"
}

check_auth_active() {
    local auth_code
    auth_code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:${PORT}/solr/admin/info/system" 2>/dev/null || echo "000")
    echo "${auth_code}"
}

main() {
    local container_running health_status http_status auth_status overall_status
    
    if check_container; then
        container_running="true"
    else
        container_running="false"
    fi
    
    health_status=$(check_health_status)
    http_status=$(check_http_endpoint)
    auth_status=$(check_auth_active)
    
    if [[ "${container_running}" == "true" ]] && [[ "${health_status}" == "healthy" ]] && [[ "${http_status}" =~ ^(200|401)$ ]]; then
        overall_status="healthy"
        exit_code=0
    else
        overall_status="unhealthy"
        exit_code=1
    fi
    
    if [[ "${OUTPUT_FORMAT}" == "json" ]]; then
        cat <<EOF
{
  "status": "${overall_status}",
  "timestamp": "$(date -Iseconds)",
  "container": {
    "name": "${CONTAINER}",
    "running": ${container_running},
    "health": "${health_status}"
  },
  "http": {
    "port": ${PORT},
    "ping_status": "${http_status}",
    "auth_active": $([ "${auth_status}" == "401" ] && echo "true" || echo "false")
  }
}
EOF
    else
        echo "Solr Health Check - ${overall_status}"
        echo "Container: ${CONTAINER} (running: ${container_running})"
        echo "Health Status: ${health_status}"
        echo "HTTP Ping: ${http_status}"
        echo "Auth Active: $([ "${auth_status}" == "401" ] && echo "YES" || echo "NO")"
    fi
    
    exit ${exit_code}
}

main "$@"
