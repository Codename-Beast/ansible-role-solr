# {{ ansible_managed }}
# Version: 2.0.0
# Apache VirtualHost Configuration for Solr
# Domain: {{ solr_app_domain | default(ansible_fqdn) }}

{% if solr_ssl_enabled | default(false) %}
# HTTP to HTTPS Redirect
<VirtualHost *:80>
    ServerName {{ solr_app_domain | default(ansible_fqdn) }}

    # Let's Encrypt ACME Challenge
    Alias /.well-known/acme-challenge/ /var/www/html/.well-known/acme-challenge/
    <Directory "/var/www/html/.well-known/acme-challenge/">
        Options None
        AllowOverride None
        Require all granted
    </Directory>

    # Redirect alle anderen Anfragen zu HTTPS
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

# HTTPS VirtualHost
<VirtualHost *:443>
    ServerName {{ solr_app_domain | default(ansible_fqdn) }}

    # SSL Konfiguration
    SSLEngine on
    SSLCertificateFile {{ solr_ssl_cert_path }}/fullchain.pem
    SSLCertificateKeyFile {{ solr_ssl_cert_path }}/privkey.pem

    # SSL Protokolle und Cipher Suites (Modern)
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off

    # OCSP Stapling
    SSLUseStapling on
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off

    # HTTP Strict Transport Security
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
{% else %}
# HTTP VirtualHost
<VirtualHost *:80>
    ServerName {{ solr_app_domain | default(ansible_fqdn) }}
{% endif %}

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/solr-{{ solr_app_domain | default('default') }}-error.log
    CustomLog ${APACHE_LOG_DIR}/solr-{{ solr_app_domain | default('default') }}-access.log combined

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Proxy Settings
    ProxyRequests Off
    ProxyPreserveHost On
    ProxyTimeout 300
    ProxyBadHeader Ignore

    # Fix for Solr Admin UI bug - Redirect SolrCloud API to Standalone API
    # The Solr 9.9.0 Admin UI incorrectly tries to use SolrCloud endpoints
    # even when running in Standalone mode. This rewrites those calls.
    RewriteEngine On
    RewriteRule ^/api/cluster/security/(.*)$ {{ solr_proxy_path | default('/solr-admin') }}/admin/$1 [PT,QSA]

    # Solr Proxy Location
    <Location {{ solr_proxy_path | default('/solr-admin') }}>
        {% if solr_proxy_auth_enabled | default(false) %}
        # Basic Authentication
        AuthType Basic
        AuthName "Solr Admin Access"
        AuthUserFile /etc/apache2/solr.htpasswd
        Require valid-user
        {% endif %}

        {% if solr_restrict_admin | default(true) %}
        # IP Access Control
        <RequireAll>
            Require ip 127.0.0.1
            Require ip ::1
            {% for ip in solr_admin_allowed_ips | default([]) %}
            Require ip {{ ip }}
            {% endfor %}
        </RequireAll>
        {% endif %}

        # Proxy Pass - CRITICAL: nocanon prevents path encoding issues
        ProxyPass http://127.0.0.1:{{ solr_port }}/solr nocanon
        ProxyPassReverse http://127.0.0.1:{{ solr_port }}/solr

        # Forwarded Headers
        RequestHeader set X-Forwarded-Proto "{% if solr_ssl_enabled | default(false) %}https{% else %}http{% endif %}"
        RequestHeader set X-Forwarded-Port "{% if solr_ssl_enabled | default(false) %}443{% else %}80{% endif %}"
        RequestHeader set X-Forwarded-Host "{{ solr_app_domain | default(ansible_fqdn) }}"

        # Allow HTTP Methods
        <LimitExcept GET POST PUT DELETE HEAD OPTIONS>
            Require all denied
        </LimitExcept>
    </Location>

    # Redirect for trailing slash
    RedirectMatch 301 ^{{ solr_proxy_path | default('/solr-admin') }}$ {{ solr_proxy_path | default('/solr-admin') }}/

    # Admin Interface - Additional Restrictions
    <Location {{ solr_proxy_path | default('/solr-admin') }}/admin>
        {% if solr_restrict_admin | default(true) %}
        # Stricter admin access
        <RequireAll>
            Require ip 127.0.0.1
            Require ip ::1
            {% for ip in solr_admin_allowed_ips | default([]) %}
            Require ip {{ ip }}
            {% endfor %}
        </RequireAll>
        {% endif %}
    </Location>

    # Health Check Endpoint (Public)
    <Location {{ solr_proxy_path | default('/solr-admin') }}/admin/ping>
        Require all granted
    </Location>

    # Root Redirect (optional)
    RedirectMatch ^/$ {{ solr_proxy_path | default('/solr-admin') }}/

</VirtualHost>

{% if solr_ssl_enabled | default(false) %}
# SSL Stapling Cache (global)
SSLStaplingCache shmcb:/var/run/ocsp(128000)
{% endif %}
