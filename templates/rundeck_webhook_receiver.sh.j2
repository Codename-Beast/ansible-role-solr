#!/bin/bash
# Version: 1.1.0
# Description: Webhook receiver for Rundeck triggers
# Generated by Ansible: {{ ansible_date_time.iso8601 }}

set -euo pipefail

WEBHOOK_SECRET="{{ rundeck_webhook_secret | default('') }}"
CONTAINER="{{ solr_container_name }}"
COMPOSE_FILE="{{ solr_compose_dir }}/docker-compose.yml"
LOG_FILE="/var/log/solr/webhook.log"

log_message() {
    echo "[$(date -Iseconds)] $1" | tee -a "${LOG_FILE}"
}

verify_secret() {
    local provided_secret="$1"
    if [[ -n "${WEBHOOK_SECRET}" ]] && [[ "${provided_secret}" != "${WEBHOOK_SECRET}" ]]; then
        log_message "ERROR: Invalid webhook secret"
        echo '{"status":"error","message":"unauthorized"}'
        exit 1
    fi
}

execute_action() {
    local action="$1"
    local result
    
    case "${action}" in
        "restart")
            log_message "Executing restart action"
            if docker compose -f "${COMPOSE_FILE}" restart; then
                result='{"status":"success","action":"restart","timestamp":"'$(date -Iseconds)'"}'
            else
                result='{"status":"error","action":"restart","message":"restart failed"}'
            fi
            ;;
        "health")
            log_message "Executing health check"
            result=$(/usr/local/bin/solr_health_check json)
            ;;
        "backup")
            log_message "Executing backup action"
            if docker exec "${CONTAINER}" solr backup -c {{ solr_core_name }} -d /var/solr/backup -name webhook_backup_$(date +%Y%m%d_%H%M%S); then
                result='{"status":"success","action":"backup","timestamp":"'$(date -Iseconds)'"}'
            else
                result='{"status":"error","action":"backup","message":"backup failed"}'
            fi
            ;;
        *)
            log_message "ERROR: Unknown action: ${action}"
            result='{"status":"error","message":"unknown action"}'
            ;;
    esac
    
    echo "${result}"
}

main() {
    local secret="${1:-}"
    local action="${2:-health}"
    
    log_message "Webhook received: action=${action}"
    
    if [[ -n "${WEBHOOK_SECRET}" ]]; then
        verify_secret "${secret}"
    fi
    
    execute_action "${action}"
}

main "$@"
