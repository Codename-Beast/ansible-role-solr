---
# Version: 1.4.0
# Description: Test Moodle document indexing and search (Multi-Core compatible)
# Changelog v1.4.0:
#   - SIMPLIFIED: Use admin credentials for all tests
#   - Admin has global permissions in both Single and Multi-Core modes
#   - Eliminates permission issues across all core configurations
#   - Tests document indexing, search, and Solr functionality
# Changelog v1.3.0:
#   - FIXED: Multi-Core Mode support - uses test_core_name from integration_tests
#   - IMPROVED: Automatically detects core name based on mode

# ============================================================================
# DETERMINE TEST CORE
# ============================================================================

- name: moodle-test - Set test core name (Single-Core Mode)
  set_fact:
    test_core_name: "{{ solr_core_name }}"
  when: 
    - not multi_core_mode_active | default(false)
    - test_core_name is not defined
  changed_when: false

- name: moodle-test - Set test core name (Multi-Core Mode)
  set_fact:
    test_core_name: "{{ solr_cores[0].name }}_core"
  when: 
    - multi_core_mode_active | default(false)
    - solr_cores is defined
    - solr_cores | length > 0
    - test_core_name is not defined
  changed_when: false

- name: moodle-test - Display test configuration
  debug:
    msg:
      - "Moodle Document Test Configuration:"
      - "Mode: {{ 'Multi-Core' if multi_core_mode_active | default(false) else 'Single-Core' }}"
      - "Test core: {{ test_core_name }}"
      - "Test user: {{ solr_admin_user }} (admin)"
      - "Note: Using admin for all tests (has global permissions)"

# ============================================================================
# WAIT FOR CORE TO BE READY
# ============================================================================

- name: test-docs - Wait for Solr core to be ready
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/admin/ping"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
  register: core_ready
  until: core_ready.status == 200
  retries: 6
  delay: 5
  changed_when: false

# ============================================================================
# INDEX TEST DOCUMENTS
# ============================================================================

- name: test-docs - Index Moodle test document - Forum Post
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/update/json/docs"
    method: POST
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      id: "forum_post_1_{{ ansible_date_time.epoch }}"
      title: "Einführung in die Mathematik"
      content: "Dies ist ein Testbeitrag für das Mathematik-Forum. Hier diskutieren wir über lineare Algebra und Analysis."
      description1: "Forum-Beitrag im Kurs Mathematik Grundlagen"
      contextid: 101
      courseid: 5
      owneruserid: 2
      modified: "{{ ansible_date_time.iso8601 }}"
      type: 0
      areaid: "mod_forum-post"
      itemid: 1234
    status_code: 200
  register: test_doc1

- name: test-docs - Index Moodle test document - Wiki Page
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/update/json/docs"
    method: POST
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      id: "wiki_page_1_{{ ansible_date_time.epoch }}"
      title: "Projektmanagement Methoden"
      content: "Agile Methoden wie Scrum und Kanban sind moderne Ansätze im Projektmanagement. Sie ermöglichen flexible Anpassungen während des Projektverlaufs."
      intro: "Eine Übersicht über agile Projektmanagement-Methoden"
      contextid: 102
      courseid: 7
      owneruserid: 3
      modified: "{{ ansible_date_time.iso8601 }}"
      type: 1
      areaid: "mod_wiki-page"
      itemid: 5678
    status_code: 200
  register: test_doc2

- name: test-docs - Index Moodle test document - Course Module
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/update/json/docs"
    method: POST
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      id: "course_module_1_{{ ansible_date_time.epoch }}"
      title: "Einführung in Python Programmierung"
      content: "Lerne die Grundlagen der Python Programmierung. Von Variablen über Funktionen bis zu objektorientierten Konzepten."
      description1: "Dieser Kurs behandelt alle wichtigen Python-Grundlagen für Anfänger"
      contextid: 103
      courseid: 12
      owneruserid: 1
      modified: "{{ ansible_date_time.iso8601 }}"
      type: 2
      areaid: "core_course-course"
      itemid: 9012
    status_code: 200
  register: test_doc3

- name: test-docs - Index Moodle test document - Assignment
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/update/json/docs"
    method: POST
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      id: "assignment_1_{{ ansible_date_time.epoch }}"
      title: "Hausaufgabe: Datenbankdesign"
      content: "Erstellen Sie ein ER-Diagramm für eine Bibliotheksverwaltung mit Büchern, Autoren und Ausleihvorgängen."
      intro: "Praktische Übung zum Thema relationale Datenbanken"
      contextid: 104
      courseid: 8
      owneruserid: 4
      modified: "{{ ansible_date_time.iso8601 }}"
      type: 3
      areaid: "mod_assign-activity"
      itemid: 3456
    status_code: 200
  register: test_doc4

- name: test-docs - Index Moodle test document - Page Resource
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/update/json/docs"
    method: POST
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      id: "page_resource_1_{{ ansible_date_time.epoch }}"
      title: "Lernmaterialien: HTML und CSS"
      content: "HTML ist die Struktur-Sprache des Webs. CSS ermöglicht das Styling. Zusammen bilden sie die Grundlage moderner Webseiten. Responsive Design und Flexbox sind wichtige Konzepte."
      description1: "Einführung in Webentwicklung mit HTML5 und CSS3"
      contextid: 105
      courseid: 15
      owneruserid: 2
      modified: "{{ ansible_date_time.iso8601 }}"
      type: 4
      areaid: "mod_page-activity"
      itemid: 7890
    status_code: 200
  register: test_doc5

# ============================================================================
# COMMIT DOCUMENTS
# ============================================================================

- name: test-docs - Commit all test documents
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/update?commit=true"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
  register: commit_result

# ============================================================================
# SEARCH TESTS
# ============================================================================

- name: test-docs - Test search for "Mathematik"
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/select?q=title:Mathematik&wt=json"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    return_content: yes
  register: search_math
  changed_when: false

- name: test-docs - Test search for "Python"
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/select?q=content:Python&wt=json"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    return_content: yes
  register: search_python
  changed_when: false

- name: test-docs - Test search by course ID
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/select?q=courseid:5&wt=json"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    return_content: yes
  register: search_course
  changed_when: false

- name: test-docs - Test search by type
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/select?q=type:0&wt=json"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    return_content: yes
  register: search_type
  changed_when: false

- name: test-docs - Test facet search by type
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/select?q=*:*&facet=true&facet.field=type&wt=json"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    return_content: yes
  register: search_facet
  changed_when: false

# ============================================================================
# TEST RESULTS SUMMARY
# ============================================================================

- name: test-docs - Calculate test results
  set_fact:
    moodle_tests_passed: >-
      {{
        (test_doc1.status == 200) | int +
        (test_doc2.status == 200) | int +
        (test_doc3.status == 200) | int +
        (test_doc4.status == 200) | int +
        (test_doc5.status == 200) | int +
        (commit_result.status == 200) | int +
        (search_math.json.response.numFound >= 1) | int +
        (search_python.json.response.numFound >= 1) | int +
        (search_course.json.response.numFound >= 1) | int +
        (search_type.json.response.numFound >= 1) | int
      }}
    moodle_tests_total: 10

- name: test-docs - Create Rundeck-compatible output
  set_fact:
    moodle_test_result:
      status: "{{ 'success' if moodle_tests_passed | int == moodle_tests_total | int else 'warning' }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
      message: "Moodle document tests completed"
      core_tested: "{{ test_core_name }}"
      mode: "{{ 'Multi-Core' if multi_core_mode_active | default(false) else 'Single-Core' }}"
      test_user: "{{ solr_admin_user }}"
      summary:
        tests_total: "{{ moodle_tests_total }}"
        tests_passed: "{{ moodle_tests_passed }}"
        tests_failed: "{{ moodle_tests_total | int - moodle_tests_passed | int }}"
        success_rate: "{{ ((moodle_tests_passed | int / moodle_tests_total | int) * 100) | round(2) }}%"
      test_results:
        forum_post_indexed: "{{ 'PASSED' if test_doc1.status == 200 else 'FAILED' }}"
        wiki_page_indexed: "{{ 'PASSED' if test_doc2.status == 200 else 'FAILED' }}"
        course_module_indexed: "{{ 'PASSED' if test_doc3.status == 200 else 'FAILED' }}"
        assignment_indexed: "{{ 'PASSED' if test_doc4.status == 200 else 'FAILED' }}"
        page_resource_indexed: "{{ 'PASSED' if test_doc5.status == 200 else 'FAILED' }}"
        commit_successful: "{{ 'PASSED' if commit_result.status == 200 else 'FAILED' }}"
        search_by_title: "{{ 'PASSED (' + (search_math.json.response.numFound | string) + ' results)' if search_math.json.response.numFound >= 1 else 'FAILED' }}"
        search_by_content: "{{ 'PASSED (' + (search_python.json.response.numFound | string) + ' results)' if search_python.json.response.numFound >= 1 else 'FAILED' }}"
        search_by_courseid: "{{ 'PASSED (' + (search_course.json.response.numFound | string) + ' results)' if search_course.json.response.numFound >= 1 else 'FAILED' }}"
        search_by_type: "{{ 'PASSED (' + (search_type.json.response.numFound | string) + ' results)' if search_type.json.response.numFound >= 1 else 'FAILED' }}"
      indexed_documents:
        - "forum_post: Einführung in die Mathematik"
        - "wiki_page: Projektmanagement Methoden"
        - "course_module: Python Programmierung"
        - "assignment: Hausaufgabe Datenbankdesign"
        - "page: HTML und CSS Lernmaterialien"

- name: test-docs - Display Rundeck output
  debug:
    msg: "{{ moodle_test_result | to_nice_json }}"
  when: rundeck_integration_enabled | default(false)

- name: test-docs - Display standard summary
  debug:
    msg:
      - "╔════════════════════════════════════════════════════════════════╗"
      - "║           MOODLE DOCUMENT TESTS COMPLETED                      ║"
      - "╠════════════════════════════════════════════════════════════════╣"
      - "║ Mode:        {{ 'Multi-Core' if multi_core_mode_active | default(false) else 'Single-Core' }}"
      - "║ Core:        {{ test_core_name }}"
      - "║ Test User:   {{ solr_admin_user }} (admin)"
      - "║ Results:     {{ moodle_tests_passed }}/{{ moodle_tests_total }} tests passed ({{ ((moodle_tests_passed | int / moodle_tests_total | int) * 100) | round(2) }}%)"
      - "╠════════════════════════════════════════════════════════════════╣"
      - "║ INDEXING TESTS:"
      - "║   Forum Post:      {{ 'PASSED ✅' if test_doc1.status == 200 else 'FAILED ❌' }}"
      - "║   Wiki Page:       {{ 'PASSED ✅' if test_doc2.status == 200 else 'FAILED ❌' }}"
      - "║   Course Module:   {{ 'PASSED ✅' if test_doc3.status == 200 else 'FAILED ❌' }}"
      - "║   Assignment:      {{ 'PASSED ✅' if test_doc4.status == 200 else 'FAILED ❌' }}"
      - "║   Page Resource:   {{ 'PASSED ✅' if test_doc5.status == 200 else 'FAILED ❌' }}"
      - "║   Commit:          {{ 'PASSED ✅' if commit_result.status == 200 else 'FAILED ❌' }}"
      - "╠════════════════════════════════════════════════════════════════╣"
      - "║ SEARCH TESTS:"
      - "║   By Title (Mathematik):  {{ 'PASSED ✅ (' + (search_math.json.response.numFound | string) + ' results)' if search_math.json.response.numFound >= 1 else 'FAILED ❌' }}"
      - "║   By Content (Python):    {{ 'PASSED ✅ (' + (search_python.json.response.numFound | string) + ' results)' if search_python.json.response.numFound >= 1 else 'FAILED ❌' }}"
      - "║   By Course ID:           {{ 'PASSED ✅ (' + (search_course.json.response.numFound | string) + ' results)' if search_course.json.response.numFound >= 1 else 'FAILED ❌' }}"
      - "║   By Type:                {{ 'PASSED ✅ (' + (search_type.json.response.numFound | string) + ' results)' if search_type.json.response.numFound >= 1 else 'FAILED ❌' }}"
      - "╚════════════════════════════════════════════════════════════════╝"
  when: not rundeck_integration_enabled | default(false)

# ============================================================================
# CLEANUP: Remove test documents from index
# ============================================================================

- name: moodle-test - Delete all test documents (cleanup)
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/update?commit=true"
    method: POST
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      delete:
        query: "id:forum_post_* OR id:wiki_page_* OR id:course_* OR id:assignment_* OR id:page_*"
    status_code: 200
  register: cleanup_result
  changed_when: false
  failed_when: false

- name: moodle-test - Verify cleanup
  debug:
    msg: "Test documents cleanup: {{ 'COMPLETED ✅' if cleanup_result.status | default(0) == 200 else 'FAILED ❌ (non-critical)' }}"