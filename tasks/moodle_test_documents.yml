---
# Version: 1.2.0
# Description: Test Moodle document indexing and search
# Creates sample Moodle documents for testing

- name: test-docs - Wait for Solr core to be ready
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/admin/ping"
    method: GET
    user: "{{ solr_customer_user }}"
    password: "{{ customer_password }}"
    force_basic_auth: yes
    status_code: 200
  register: core_ready
  until: core_ready.status == 200
  retries: 6
  delay: 5
  changed_when: false

- name: test-docs - Index Moodle test document - Forum Post
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/update/json/docs"
    method: POST
    user: "{{ solr_customer_user }}"
    password: "{{ customer_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      id: "forum_post_1_{{ ansible_date_time.epoch }}"
      title: "Einführung in die Mathematik"
      content: "Dies ist ein Testbeitrag für das Mathematik-Forum. Hier diskutieren wir über lineare Algebra und Analysis."
      description: "Forum-Beitrag im Kurs Mathematik Grundlagen"
      contextid: 101
      courseid: 5
      owneruserid: 2
      modified: "{{ ansible_date_time.iso8601 }}"
      type: "forum_post"
      areaid: "mod_forum-post"
      itemid: 1234
      modname: "forum"
      username: "Max Mustermann"
      categoryid: 1
    status_code: 200
  register: test_doc1

- name: test-docs - Index Moodle test document - Wiki Page
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/update/json/docs"
    method: POST
    user: "{{ solr_customer_user }}"
    password: "{{ customer_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      id: "wiki_page_1_{{ ansible_date_time.epoch }}"
      title: "Projektmanagement Methoden"
      content: "Agile Methoden wie Scrum und Kanban sind moderne Ansätze im Projektmanagement. Sie ermöglichen flexible Anpassungen während des Projektverlaufs."
      intro: "Eine Übersicht über agile Projektmanagement-Methoden"
      contextid: 102
      courseid: 7
      owneruserid: 3
      modified: "{{ ansible_date_time.iso8601 }}"
      type: "wiki_page"
      areaid: "mod_wiki-page"
      itemid: 5678
      modname: "wiki"
      username: "Anna Schmidt"
      categoryid: 2
    status_code: 200
  register: test_doc2

- name: test-docs - Index Moodle test document - Course Module
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/update/json/docs"
    method: POST
    user: "{{ solr_customer_user }}"
    password: "{{ customer_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      id: "course_module_1_{{ ansible_date_time.epoch }}"
      title: "Einführung in Python Programmierung"
      content: "Lerne die Grundlagen der Python Programmierung. Von Variablen über Funktionen bis zu objektorientierten Konzepten."
      description: "Dieser Kurs behandelt alle wichtigen Python-Grundlagen für Anfänger"
      contextid: 103
      courseid: 12
      owneruserid: 1
      modified: "{{ ansible_date_time.iso8601 }}"
      type: "course_module"
      areaid: "core_course-course"
      itemid: 9012
      username: "Admin User"
      categoryid: 3
    status_code: 200
  register: test_doc3

- name: test-docs - Index Moodle test document - Assignment
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/update/json/docs"
    method: POST
    user: "{{ solr_customer_user }}"
    password: "{{ customer_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      id: "assignment_1_{{ ansible_date_time.epoch }}"
      title: "Hausaufgabe: Datenbankdesign"
      content: "Erstellen Sie ein ER-Diagramm für eine Bibliotheksverwaltung mit Büchern, Autoren und Ausleihvorgängen."
      intro: "Praktische Übung zum Thema relationale Datenbanken"
      contextid: 104
      courseid: 8
      owneruserid: 4
      modified: "{{ ansible_date_time.iso8601 }}"
      type: "assignment"
      areaid: "mod_assign-activity"
      itemid: 3456
      modname: "assign"
      username: "Prof. Dr. Meier"
      categoryid: 2
    status_code: 200
  register: test_doc4

- name: test-docs - Index Moodle test document - Page Resource
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/update/json/docs"
    method: POST
    user: "{{ solr_customer_user }}"
    password: "{{ customer_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      id: "page_resource_1_{{ ansible_date_time.epoch }}"
      title: "Lernmaterialien: HTML und CSS"
      content: "HTML ist die Struktur-Sprache des Webs. CSS ermöglicht das Styling. Zusammen bilden sie die Grundlage moderner Webseiten. Responsive Design und Flexbox sind wichtige Konzepte."
      description: "Einführung in Webentwicklung mit HTML5 und CSS3"
      contextid: 105
      courseid: 15
      owneruserid: 2
      modified: "{{ ansible_date_time.iso8601 }}"
      type: "page"
      areaid: "mod_page-activity"
      itemid: 7890
      modname: "page"
      username: "Max Mustermann"
      categoryid: 4
    status_code: 200
  register: test_doc5

- name: test-docs - Commit all test documents
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/update?commit=true"
    method: GET
    user: "{{ solr_customer_user }}"
    password: "{{ customer_password }}"
    force_basic_auth: yes
    status_code: 200
  register: commit_result

- name: install-solr - Test search for "Mathematik"
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/select?q=title:Mathematik&wt=json"
    method: GET
    user: "{{ solr_customer_user }}"
    password: "{{ customer_password }}"
    force_basic_auth: yes
    return_content: yes
  register: search_math
  changed_when: false

- name: install-solr - Test search for "Python"
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/select?q=content:Python&wt=json"
    method: GET
    user: "{{ solr_customer_user }}"
    password: "{{ customer_password }}"
    force_basic_auth: yes
    return_content: yes
  register: search_python
  changed_when: false

- name: install-solr - Test search by course ID
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/select?q=courseid:5&wt=json"
    method: GET
    user: "{{ solr_customer_user }}"
    password: "{{ customer_password }}"
    force_basic_auth: yes
    return_content: yes
  register: search_course
  changed_when: false

- name: install-solr - Test search by type
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/select?q=type:forum_post&wt=json"
    method: GET
    user: "{{ solr_customer_user }}"
    password: "{{ customer_password }}"
    force_basic_auth: yes
    return_content: yes
  register: search_type
  changed_when: false

- name: install-solr - Test facet search by modname
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/select?q=*:*&facet=true&facet.field=modname&wt=json"
    method: GET
    user: "{{ solr_customer_user }}"
    password: "{{ customer_password }}"
    force_basic_auth: yes
    return_content: yes
  register: search_facet
  changed_when: false

- name: install-solr - Calculate test results
  set_fact:
    moodle_tests_passed: "{{ [
      test_doc1.status == 200,
      test_doc2.status == 200,
      test_doc3.status == 200,
      test_doc4.status == 200,
      test_doc5.status == 200,
      commit_result.status == 200,
      search_math.json.response.numFound >= 1,
      search_python.json.response.numFound >= 1,
      search_course.json.response.numFound >= 1,
      search_type.json.response.numFound >= 1
    ] | select('true') | list | length }}"
    moodle_tests_total: 10

- name: install-solr - Create Rundeck-compatible output
  set_fact:
    moodle_test_result:
      status: "{{ 'success' if moodle_tests_passed | int == moodle_tests_total | int else 'warning' }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
      message: "Moodle document tests completed"
      summary:
        tests_total: "{{ moodle_tests_total }}"
        tests_passed: "{{ moodle_tests_passed }}"
        tests_failed: "{{ moodle_tests_total | int - moodle_tests_passed | int }}"
        success_rate: "{{ ((moodle_tests_passed | int / moodle_tests_total | int) * 100) | round(2) }}%"
      test_results:
        forum_post_indexed: "{{ 'PASSED' if test_doc1.status == 200 else 'FAILED' }}"
        wiki_page_indexed: "{{ 'PASSED' if test_doc2.status == 200 else 'FAILED' }}"
        course_module_indexed: "{{ 'PASSED' if test_doc3.status == 200 else 'FAILED' }}"
        assignment_indexed: "{{ 'PASSED' if test_doc4.status == 200 else 'FAILED' }}"
        page_resource_indexed: "{{ 'PASSED' if test_doc5.status == 200 else 'FAILED' }}"
        commit_successful: "{{ 'PASSED' if commit_result.status == 200 else 'FAILED' }}"
        search_by_title: "{{ 'PASSED (' + (search_math.json.response.numFound | string) + ' results)' if search_math.json.response.numFound >= 1 else 'FAILED' }}"
        search_by_content: "{{ 'PASSED (' + (search_python.json.response.numFound | string) + ' results)' if search_python.json.response.numFound >= 1 else 'FAILED' }}"
        search_by_courseid: "{{ 'PASSED (' + (search_course.json.response.numFound | string) + ' results)' if search_course.json.response.numFound >= 1 else 'FAILED' }}"
        search_by_type: "{{ 'PASSED (' + (search_type.json.response.numFound | string) + ' results)' if search_type.json.response.numFound >= 1 else 'FAILED' }}"
      indexed_documents:
        - "forum_post: Einführung in die Mathematik"
        - "wiki_page: Projektmanagement Methoden"
        - "course_module: Python Programmierung"
        - "assignment: Hausaufgabe Datenbankdesign"
        - "page: HTML und CSS Lernmaterialien"

- name: install-solr - Display Rundeck output
  debug:
    msg: "{{ moodle_test_result | to_nice_json }}"
  when: rundeck_integration_enabled | default(false)

- name: install-solr - Display standard summary
  debug:
    msg:
      - "MOODLE DOCUMENT TESTS COMPLETED"
      - "Tests passed: {{ moodle_tests_passed }}/{{ moodle_tests_total }} ({{ ((moodle_tests_passed | int / moodle_tests_total | int) * 100) | round(2) }}%)"
      - "---"
      - "Indexing Tests:"
      - "  Forum Post: {{ 'PASSED' if test_doc1.status == 200 else 'FAILED' }}"
      - "  Wiki Page: {{ 'PASSED' if test_doc2.status == 200 else 'FAILED' }}"
      - "  Course Module: {{ 'PASSED' if test_doc3.status == 200 else 'FAILED' }}"
      - "  Assignment: {{ 'PASSED' if test_doc4.status == 200 else 'FAILED' }}"
      - "  Page Resource: {{ 'PASSED' if test_doc5.status == 200 else 'FAILED' }}"
      - "  Commit: {{ 'PASSED' if commit_result.status == 200 else 'FAILED' }}"
      - "---"
      - "Search Tests:"
      - "  Search by title (Mathematik): {{ 'PASSED (' + (search_math.json.response.numFound | string) + ' results)' if search_math.json.response.numFound >= 1 else 'FAILED' }}"
      - "  Search by content (Python): {{ 'PASSED (' + (search_python.json.response.numFound | string) + ' results)' if search_python.json.response.numFound >= 1 else 'FAILED' }}"
      - "  Search by courseid: {{ 'PASSED (' + (search_course.json.response.numFound | string) + ' results)' if search_course.json.response.numFound >= 1 else 'FAILED' }}"
      - "  Search by type: {{ 'PASSED (' + (search_type.json.response.numFound | string) + ' results)' if search_type.json.response.numFound >= 1 else 'FAILED' }}"
  when: not rundeck_integration_enabled | default(false)

  ##Cleanup Maybe? Timeissue