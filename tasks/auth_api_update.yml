---
# Version: 1.3.1
# Description: Update Solr authentication via API without container restart
# Use case: Password-only changes that don't require full container restart
# Reduction: Eliminates unnecessary downtime for password updates

- name: auth-api-update - Verify password hashes are defined
  assert:
    that:
      - admin_password_hash is defined
      - support_password_hash is defined
      - moodle_password_hash is defined
    fail_msg: |
      CRITICAL: Cannot update credentials via API - password hashes not defined.
      This means auth_management.yml did not generate new hashes.
      Possible causes:
        1. security.json was manually edited without running auth_management
        2. skip_auth was true but security.json changed externally
      Solution: Set solr_force_reconfigure_auth=true and re-run playbook.
    success_msg: "Password hashes available for API update"
  when: needs_api_update | default(false)

# When passwords change, container will be restarted instead
# This ensures consistent state without needing old password storage

- name: auth-api-update - Disable API update (use container restart instead)
  debug:
    msg: |
      API password updates are disabled for security reasons.
      Container will be restarted with new passwords.
      This provides better security (no password files on Control Node).
  when: needs_api_update | default(false)

- name: auth-api-update - Force container restart for password changes
  set_fact:
    needs_restart: true
    can_skip: false
    needs_api_update: false
  when: needs_api_update | default(false)

# API Update tasks removed - password changes now trigger container restart
# This is more secure as it doesn't require storing old passwords
