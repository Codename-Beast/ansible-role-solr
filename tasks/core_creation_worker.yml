---
# Version: 2.0.0
# Description: Worker task for creating individual cores (Multi-Core Mode)
# Changelog v2.0.0:
#   - NEW: Worker task for Multi-Core Mode
#   - Receives core_config from parent loop
#   - Creates one core at a time
#   - Fully idempotent

# ============================================================================
# CORE CONFIGURATION FROM LOOP
# ============================================================================

- name: core-worker - Set core variables from config
  set_fact:
    current_core_name: "{{ core_config.name }}_core"
    current_core_domain: "{{ core_config.domain | default(solr_app_domain) }}"
    current_core_config: "moodle_configs"
  changed_when: false

- name: core-worker - Display current core
  debug:
    msg:
      - "=========================================="
      - "PROCESSING CORE: {{ current_core_name }}"
      - "=========================================="
      - "Domain: {{ current_core_domain }}"
      - "ConfigSet: {{ current_core_config }}"
      - "=========================================="

# ============================================================================
# CORE STATUS CHECK
# ============================================================================

- name: core-worker - Check core registration via API
  uri:
    url: "http://localhost:{{ solr_port }}/solr/admin/cores?action=STATUS&core={{ current_core_name }}"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    return_content: yes
  register: core_status
  changed_when: false
  failed_when: false

- name: core-worker - Parse core status JSON
  set_fact:
    core_status_json: "{{ core_status.content | default('{}') | from_json }}"
  when: core_status.content is defined
  changed_when: false

- name: core-worker - Determine if core is registered (API)
  set_fact:
    core_registered: "{{ (core_status_json.status is defined) and (core_status_json.status[current_core_name] is defined) }}"
  changed_when: false

- name: core-worker - Check instance core.properties in container
  command: docker exec {{ solr_container_name }} test -f /var/solr/data/{{ current_core_name }}/core.properties
  register: core_dir_check
  failed_when: false
  changed_when: false
  become: true

- name: core-worker - Set instance present flag
  set_fact:
    core_instance_present: "{{ core_dir_check.rc == 0 }}"
  changed_when: false

- name: core-worker - Display core status
  debug:
    msg:
      - "Core name: {{ current_core_name }}"
      - "API registered: {{ core_registered }}"
      - "Instance exists: {{ core_instance_present }}"
      - "Action: {{ 'SKIP (already exists)' if core_instance_present else 'CREATE' }}"

# ============================================================================
# CONFIGSET DEPLOYMENT
# NOTE: Config files are already deployed by Init-Container to /var/solr/data/configs/
# We copy from there to the new configSet instead of using external files/conf/
# ============================================================================

- name: core-worker - Ensure configSet dir exists in container
  command: docker exec {{ solr_container_name }} sh -c 'mkdir -p /var/solr/data/configsets/{{ current_core_config }}/conf'
  register: mk_cfg_dir
  changed_when: mk_cfg_dir.rc == 0
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: core-worker - Copy configs from Init-Container deployed location
  command: >
    docker exec {{ solr_container_name }} sh -c '
    if [ -f /var/solr/data/configs/solrconfig.xml ]; then
      cp /var/solr/data/configs/solrconfig.xml /var/solr/data/configsets/{{ current_core_config }}/conf/solrconfig.xml;
    fi;
    if [ -f /var/solr/data/configs/moodle_schema.xml ]; then
      cp /var/solr/data/configs/moodle_schema.xml /var/solr/data/configsets/{{ current_core_config }}/conf/moodle_schema.xml;
    fi;
    if [ -f /var/solr/data/configs/synonyms.txt ]; then
      cp /var/solr/data/configs/synonyms.txt /var/solr/data/configsets/{{ current_core_config }}/conf/synonyms.txt;
    fi;
    if [ -f /var/solr/data/configs/protwords.txt ]; then
      cp /var/solr/data/configs/protwords.txt /var/solr/data/configsets/{{ current_core_config }}/conf/protwords.txt;
    fi
    '
  register: cfg_copy
  changed_when: cfg_copy.rc == 0
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: core-worker - Handle schema deployment based on core configuration
  block:
    # For empty cores (Moodle API mode): Deploy minimal schema with required field types
    # Moodle creates fields via Schema API (POST /schema with add-field)
    # Required field types based on Moodle search/classes/document.php:
    #   - text -> text_general (title, content, description1, description2)
    #   - int -> pint (itemid, contextid, type, courseid, owneruserid, userid, groupid)
    #   - tdate -> pdate (modified)
    #   - string (id, areaid)
    - name: core-worker - Create minimal managed-schema.xml for empty/API cores
      command: >
        docker exec {{ solr_container_name }} sh -c
        'cat > /var/solr/data/configsets/{{ current_core_config }}/conf/managed-schema.xml << "SCHEMA"
        <?xml version="1.0" encoding="UTF-8" ?>
        <schema name="moodle-managed" version="1.6">
          <!-- Field types required by Moodle search_solr plugin -->
          <fieldType name="string" class="solr.StrField" sortMissingLast="true" docValues="true"/>
          <fieldType name="plong" class="solr.LongPointField" docValues="true"/>
          <fieldType name="pint" class="solr.IntPointField" docValues="true"/>
          <fieldType name="pdate" class="solr.DatePointField" docValues="true"/>
          <fieldType name="text_general" class="solr.TextField" positionIncrementGap="100" multiValued="true">
            <analyzer type="index">
              <tokenizer class="solr.StandardTokenizerFactory"/>
              <filter class="solr.LowerCaseFilterFactory"/>
            </analyzer>
            <analyzer type="query">
              <tokenizer class="solr.StandardTokenizerFactory"/>
              <filter class="solr.LowerCaseFilterFactory"/>
            </analyzer>
          </fieldType>
          <!-- Required fields - id is mandatory, _version_ for optimistic locking -->
          <field name="id" type="string" indexed="true" stored="true" required="true" multiValued="false"/>
          <field name="_version_" type="plong" indexed="false" stored="false"/>
          <uniqueKey>id</uniqueKey>
        </schema>
        SCHEMA'
      when: core_config.empty_core | default(false)

    # For predefined schema cores: Copy moodle_schema.xml as managed-schema.xml
    - name: core-worker - Create managed-schema.xml from moodle_schema.xml for predefined cores
      command: >
        docker exec {{ solr_container_name }} sh -c
        'if [ -f /var/solr/data/configsets/{{ current_core_config }}/conf/moodle_schema.xml ] && [ ! -f /var/solr/data/configsets/{{ current_core_config }}/conf/managed-schema.xml ]; then
          cp /var/solr/data/configsets/{{ current_core_config }}/conf/moodle_schema.xml /var/solr/data/configsets/{{ current_core_config }}/conf/managed-schema.xml;
        fi'
      when: not (core_config.empty_core | default(false))
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: core-worker - Remove classic schema.xml (use managed-schema.xml only)
  command: >
    docker exec {{ solr_container_name }} sh -c
    'rm -f /var/solr/data/configsets/{{ current_core_config }}/conf/schema.xml || true'
  changed_when: false
  failed_when: false
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: core-worker - Set ownership for configSet (root inside container)
  command: >
    docker exec --user 0 {{ solr_container_name }} sh -c
    'chown -R 8983:8983 /var/solr/data/configsets/{{ current_core_config }}/conf &&
    find /var/solr/data/configsets/{{ current_core_config }}/conf -type d -exec chmod 0755 {} \; &&
    find /var/solr/data/configsets/{{ current_core_config }}/conf -type f -exec chmod 0644 {} \;'
  register: cfg_chown
  changed_when: cfg_chown.rc == 0
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: core-worker - Check configSet files in container
  command: docker exec {{ solr_container_name }} sh -c 'test -f /var/solr/data/configsets/{{ current_core_config }}/conf/solrconfig.xml && test -f /var/solr/data/configsets/{{ current_core_config }}/conf/managed-schema.xml'
  register: configset_files_check
  failed_when: configset_files_check.rc != 0
  changed_when: false
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: core-worker - Ensure lang directory exists in configSet
  command: docker exec {{ solr_container_name }} sh -c 'mkdir -p /var/solr/data/configsets/{{ current_core_config }}/conf/lang'
  changed_when: true
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: core-worker - Copy lang files from deployed location to configSet
  command: >
    docker exec {{ solr_container_name }} sh -c
    'for f in /var/solr/data/lang/*; do
      if [ -f "$f" ]; then
        cp "$f" /var/solr/data/configsets/{{ current_core_config }}/conf/lang/;
      fi;
    done'
  changed_when: true
  when: not core_instance_present or solr_force_recreate_core | default(false)

# ============================================================================
# CORE CREATION
# ============================================================================

- name: core-worker - Create Solr core via API
  uri:
    url: "http://localhost:{{ solr_port }}/solr/admin/cores?action=CREATE&name={{ current_core_name }}&configSet={{ current_core_config }}"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
  register: core_creation_result
  when: not core_instance_present
  retries: "{{ solr_core_creation_retries }}"
  delay: "{{ solr_core_creation_delay }}"
  until: core_creation_result.status == 200

- name: core-worker - Verify core creation
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ current_core_name }}/admin/ping"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
  register: core_ping
  retries: 5
  delay: 3
  until: core_ping.status == 200
  when: not core_instance_present

- name: core-worker - Display creation result
  debug:
    msg:
      - "=========================================="
      - "CORE CREATED: {{ current_core_name }}"
      - "=========================================="
      - "Status: {{ 'SUCCESS âœ…' if not core_instance_present else 'ALREADY EXISTS (SKIPPED)' }}"
      - "Domain: {{ current_core_domain }}"
      - "URL: http://localhost:{{ solr_port }}/solr/{{ current_core_name }}/"
      - "=========================================="