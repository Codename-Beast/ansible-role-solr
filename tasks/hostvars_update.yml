---
# Version: 1.0.0
# Description: Automatically update hostvars with generated passwords
# This task creates a YAML file with generated passwords that can be
# included in hostvars or manually copied

- name: hostvars-update - Create directory for generated credentials
  file:
    path: "{{ solr_config_dir }}"
    state: directory
    mode: '0750'
    owner: root
    group: root
  become: true
  when: has_generated_passwords | bool

- name: hostvars-update - Generate hostvars YAML snippet
  copy:
    content: |
      # Auto-generated passwords from Solr deployment
      # Generated: {{ ansible_date_time.iso8601 }}
      # IMPORTANT: Copy these values to your host_vars file to persist them

      # Global passwords
      {% if generate_admin_password | default(false) %}
      solr_admin_password: "{{ solr_admin_password_final }}"
      {% endif %}
      {% if generate_support_password | default(false) %}
      solr_support_password: "{{ solr_support_password_final }}"
      {% endif %}
      {% if generate_moodle_password | default(false) %}
      solr_moodle_password: "{{ solr_moodle_password_final }}"
      {% endif %}

      # Core-specific passwords
      {% if deployment_mode == 'multi-core' and generated_credentials | default([]) | length > 0 %}
      solr_cores:
      {% for core_data in solr_cores %}
        - name: "{{ core_data.name }}"
          domain: "{{ core_data.domain }}"
          users:
      {% for user in generated_credentials | selectattr('core', 'equalto', core_data.name) %}
            - username: "{{ user.username }}"
              password: "{{ user.password }}"
              role: "{{ 'admin' if 'admin' in user.username else ('moodle' if 'moodle' in user.username else 'readonly') }}"
      {% endfor %}
      {% endfor %}
      {% endif %}
    dest: "{{ solr_config_dir }}/generated_passwords.yml"
    mode: '0600'
    owner: root
    group: root
  become: true
  when: has_generated_passwords | bool

- name: hostvars-update - Display instructions
  debug:
    msg:
      - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
      - "â•‘  ğŸ“ AUTOMATISCHE HOSTVARS-AKTUALISIERUNG                              â•‘"
      - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
      - "â•‘                                                                       â•‘"
      - "â•‘  Die generierten PasswÃ¶rter wurden gespeichert in:                   â•‘"
      - "â•‘  {{ solr_config_dir }}/generated_passwords.yml"
      - "â•‘                                                                       â•‘"
      - "â•‘  OPTION 1: Include in hostvars (empfohlen):                           â•‘"
      - "â•‘  -----------------------------------------                            â•‘"
      - "â•‘  FÃ¼ge in deine host_vars Datei hinzu:                                 â•‘"
      - "â•‘                                                                       â•‘"
      - "â•‘  # Include generated passwords                                        â•‘"
      - "â•‘  ansible_include_vars: {{ solr_config_dir }}/generated_passwords.yml"
      - "â•‘                                                                       â•‘"
      - "â•‘  OPTION 2: Manuell kopieren:                                          â•‘"
      - "â•‘  -----------------------                                              â•‘"
      - "â•‘  cat {{ solr_config_dir }}/generated_passwords.yml                   â•‘"
      - "â•‘                                                                       â•‘"
      - "â•‘  Dann kopiere den Inhalt in deine host_vars Datei.                   â•‘"
      - "â•‘                                                                       â•‘"
      - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
  when: has_generated_passwords | bool
