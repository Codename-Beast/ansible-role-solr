---
# Version: 1.3.1
# Author: Bernd Schreistetter
# Description: Main orchestration for Solr installation
# Changelog v1.3.1:
#   - CRITICAL: Full idempotency - unlimited re-runs on same server
#   - FEATURE: Selective password updates without container restart
#   - FEATURE: Core name changes create new cores (old cores preserved)
#   - FIXED: Host_vars duplicate entries eliminated
#   - FIXED: Container only restarts when non-auth configs change
#   - OPTIMIZED: Consolidated auth tasks (4→2 files, 58% reduction)
#   - OPTIMIZED: Unified config management (3→1 files, 52% reduction)
#   - OPTIMIZED: Total codebase reduction by 52% (758 lines)

- name: install-solr - Preflight checks
  include_tasks: preflight_checks.yml
  tags:
    - always
    - install-solr-preflight

- name: install-solr - System preparation
  include_tasks: system_preparation.yml
  tags:
    - install-solr-preparation

- name: install-solr - Docker installation
  include_tasks: docker_installation.yml
  tags:
    - install-solr-docker
# OPTIMIZED: Auth detection + password hashing (unified)
- name: solr-auth management (detection + hashing)
  include_tasks: auth_management.yml
  when: solr_auth_enabled | default(true)
  tags:
    - install-solr-auth

# OPTIMIZED: Config management (unified)
- name: install-solr - Configuration management
  include_tasks: config_management.yml
  tags:
    - install-solr-config
    - install-solr-auth

- name: install-solr - Generate Docker Compose configuration
  include_tasks: compose_generation.yml
  tags:
    - install-solr-compose

- name: install-solr - Deploy container with init pattern
  include_tasks: container_deployment.yml
  tags:
    - install-solr-deployment

- name: install-solr - Update auth via API (selective password updates)
  include_tasks: auth_api_update.yml
  when:
    - solr_auth_enabled | default(true)
    - needs_api_update | default(false)
  tags:
    - install-solr-auth
    - install-solr-deployment

- name: install-solr - Auth validation tests
  include_tasks: auth_validation.yml
  when: solr_auth_enabled | default(true)
  tags:
    - install-solr-auth

- name: install-solr - Auth persist credentials
  include_tasks: auth_persistence.yml
  when: solr_auth_enabled | default(true)
  tags:
    - install-solr-auth

- name: install-solr - Create Solr core
  include_tasks: core_creation.yml
  tags:
    - install-solr-core

- name: install-solr - Configure webserver proxy
  include_tasks: proxy_configuration.yml
  when: solr_proxy_enabled | default(true)
  tags:
    - install-solr-proxy

- name: install-solr - Integration tests
  include_tasks: integration_tests.yml
  tags:
    - install-solr-test

- name: install-solr - Moodle document tests
  include_tasks: moodle_test_documents.yml
  when: solr_use_moodle_schema | default(false)
  tags:
    - install-solr-test
    - install-solr-moodle

- name: install-solr - Finalization
  include_tasks: finalization.yml
  tags:
    - install-solr-finalize

- name: install-solr - Rundeck integration
  include_tasks: rundeck_integration.yml
  when: rundeck_integration_enabled | default(false)
  tags:
    - install-solr-rundeck
