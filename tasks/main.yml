---
# Version: 1.3.2
# Author: Bernd Schreistetter
# Description: Main orchestration for Solr installation
# Changelog v1.3.2:
#   - CRITICAL: Added rollback mechanism with block/rescue/always
#   - CRITICAL: Fixed docker-compose template shell escaping bug
#   - IMPROVED: Enhanced error handling with detailed logging
#   - IMPROVED: Expanded handlers (core reload, API updates, health checks)
#   - FIXED: Checksum comparison loop data structure validation
#   - FIXED: auth_api_update only runs when hashes are defined
#   - FIXED: Better healthcheck in docker-compose (tests actual API)
#   - ADDED: Deployment attempt logging for debugging
# Changelog v1.3.1:
#   - CRITICAL: Full idempotency - unlimited re-runs on same server
#   - FIXED: Host_vars duplicate entries eliminated
#   - FIXED: Container only restarts when non-auth configs change


- name: install-solr - Preflight checks
  include_tasks: preflight_checks.yml
  tags:
    - always
    - install-solr-preflight

- name: install-solr - System preparation
  include_tasks: system_preparation.yml
  tags:
    - install-solr-preparation

- name: install-solr - Docker installation
  include_tasks: docker_installation.yml
  tags:
    - install-solr-docker

- name: solr-auth management (detection + hashing)
  include_tasks: auth_management.yml
  when: solr_auth_enabled | default(true)
  tags:
    - install-solr-auth

- name: install-solr - Additional user management
  include_tasks: user_management.yml
  when:
    - solr_auth_enabled | default(true)
    - (solr_additional_users is defined and solr_additional_users | length > 0) or
      (solr_cores is defined and solr_cores | length > 0)
  tags:
    - install-solr-auth
    - install-solr-users
    - solr-users-deploy

- name: install-solr - Hot-reload auth updates (zero-downtime user changes)
  include_tasks: user_update_live.yml
  when:
    - solr_auth_enabled | default(true)
    - solr_additional_users is defined
    - solr_additional_users | length > 0
  tags:
    - never  # Only run when explicitly requested
    - solr-auth-reload
    - solr-users-hotupdate

- name: install-solr - Configuration management
  include_tasks: config_management.yml
  tags:
    - install-solr-config
    - install-solr-auth

- name: install-solr - Generate Docker Compose configuration
  include_tasks: compose_generation.yml
  tags:
    - install-solr-compose

- name: install-solr - Deploy container with init pattern
  include_tasks: container_deployment.yml
  tags:
    - install-solr-deployment

- name: install-solr - Update auth via API (selective password updates)
  include_tasks: auth_api_update.yml
  when:
    - solr_auth_enabled | default(true)
    - needs_api_update | default(false)
    - admin_password_hash is defined
    - support_password_hash is defined
    - moodle_password_hash is defined
  tags:
    - install-solr-auth
    - install-solr-deployment

- name: install-solr - Auth validation tests
  include_tasks: auth_validation.yml
  when: solr_auth_enabled | default(true)
  tags:
    - install-solr-auth

- name: install-solr - Validate passwords before persistence
  assert:
    that:
      - solr_admin_password is defined and solr_admin_password | length > 0
      - solr_support_password is defined and solr_support_password | length > 0
      - solr_moodle_password is defined and solr_moodle_password | length > 0
    fail_msg: |
      Cannot persist undefined or empty passwords to host_vars.
      This indicates a bug in auth_management.yml.
    success_msg: "All passwords validated before persistence"
  when: solr_auth_enabled | default(true)
  tags:
    - install-solr-auth

- name: install-solr - Auth persist credentials
  include_tasks: auth_persistence.yml
  when:
    - solr_auth_enabled | default(true)
    - (not skip_auth | default(false)) or
      (solr_cores is defined and solr_cores | length > 0) or
      (solr_additional_users is defined and solr_additional_users | length > 0)
  tags:
    - install-solr-auth

- name: install-solr - Create Solr core
  include_tasks: core_creation.yml
  tags:
    - install-solr-core

- name: install-solr - Reload cores to pick up config changes
  include_tasks: core_reload.yml
  tags:
    - install-solr-core
    - install-solr-config

- name: install-solr - Configure webserver proxy
  include_tasks: proxy_configuration.yml
  when: solr_proxy_enabled | default(false)
  tags:
    - install-solr-proxy

- name: install-solr - Integration tests
  include_tasks: integration_tests.yml
  tags:
    - install-solr-test

- name: install-solr - Moodle document tests
  include_tasks: moodle_test_documents.yml
  when: solr_use_moodle_schema | default(false)
  tags:
    - install-solr-test
    - install-solr-moodle

- name: install-solr - Finalization
  include_tasks: finalization.yml
  tags:
    - install-solr-finalize

- name: install-solr - Rundeck integration
  include_tasks: rundeck_integration.yml
  when: rundeck_integration_enabled | default(false)
  tags:
    - install-solr-rundeck
