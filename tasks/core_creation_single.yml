---
# Version: 1.3.1
# Description: Create Solr core with full idempotency
# Changelog v1.3.1:
#   - IDEMPOTENT: Skip creation if core already exists
#   - MULTIPLE CORES: Old cores remain when creating new ones
#   - DETECTION: Check both API registration and file system
#   - OPTIMIZATION: Only create when truly needed

- name: install-solr - Check core registration via API
  uri:
    url: "http://localhost:{{ solr_port }}/solr/admin/cores?action=STATUS&core={{ solr_core_name }}"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    return_content: yes
  register: core_status
  changed_when: false
  failed_when: false

- name: install-solr - Parse core status JSON
  set_fact:
    core_status_json: "{{ core_status.content | default('{}') | from_json }}"
  when: core_status.content is defined
  changed_when: false

- name: install-solr - Determine if core is registered (API)
  set_fact:
    core_registered: "{{ (core_status_json.status is defined) and (core_status_json.status[solr_core_name] is defined) }}"
  changed_when: false

- name: install-solr - Check instance core.properties in container
  community.docker.docker_container_exec:
    container: "{{ solr_container_name }}"
    command: "test -f /var/solr/data/{{ solr_core_name }}/core.properties"
  register: core_dir_check
  failed_when: false
  changed_when: false

- name: install-solr - Set instance present flag
  set_fact:
    core_instance_present: "{{ core_dir_check.rc == 0 }}"
  changed_when: false

- name: install-solr - Display core status
  debug:
    msg:
      - "========================================"
      - "CORE STATUS CHECK"
      - "========================================"
      - "Core name: {{ solr_core_name }}"
      - "API registered: {{ core_registered }}"
      - "Instance exists: {{ core_instance_present }}"
      - "Action: {{ 'SKIP (already exists)' if core_instance_present else 'CREATE' }}"
      - "========================================"

# ---------------- ConfigSet staging & push (schema.xml only) ----------------
# NOTE: Skip if core exists unless force_recreate_core is set
# This prevents unnecessary changes to running configSets

- name: install-solr - Prepare remote temp dir for configSet staging
  file:
    path: "/tmp/solr_conf_{{ solr_core_config }}"
    state: directory
    owner: root
    group: root
    mode: "0700"
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: install-solr - Stage configSet files to remote tmp
  copy:
    src: "files/conf/"
    dest: "/tmp/solr_conf_{{ solr_core_config }}/"
    owner: root
    group: root
    mode: "0644"
  changed_when: false
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: install-solr - Ensure configSet dir exists in container
  community.docker.docker_container_exec:
    container: "{{ solr_container_name }}"
    command: "sh -lc 'mkdir -p /var/solr/data/configsets/{{ solr_core_config }}/conf'"
  register: mk_cfg_dir
  changed_when: mk_cfg_dir.rc == 0
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: install-solr - Push configSet into container via docker cp
  command: >
    docker cp /tmp/solr_conf_{{ solr_core_config }}/.
    {{ solr_container_name }}:/var/solr/data/configsets/{{ solr_core_config }}/conf/
  register: cfg_copy
  changed_when: cfg_copy.rc == 0
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: install-solr - Handle schema deployment based on empty_core setting
  block:
    # For empty cores (Moodle API mode): Only deploy minimal schema, Moodle creates fields via API
    - name: install-solr - Create minimal managed-schema for empty/API cores
      community.docker.docker_container_exec:
        container: "{{ solr_container_name }}"
        command: |
          sh -lc 'cat > /var/solr/data/configsets/{{ solr_core_config }}/conf/managed-schema << "SCHEMA"
          <?xml version="1.0" encoding="UTF-8" ?>
          <schema name="moodle-managed" version="1.6">
            <fieldType name="string" class="solr.StrField" sortMissingLast="true" docValues="true"/>
            <fieldType name="plong" class="solr.LongPointField" docValues="true"/>
            <field name="id" type="string" indexed="true" stored="true" required="true" multiValued="false"/>
            <field name="_version_" type="plong" indexed="false" stored="false"/>
            <uniqueKey>id</uniqueKey>
          </schema>
          SCHEMA'
      when: solr_empty_core | default(false)

    # For predefined schema cores: Copy moodle_schema.xml as managed-schema
    - name: install-solr - Create managed-schema from moodle_schema.xml for predefined cores
      community.docker.docker_container_exec:
        container: "{{ solr_container_name }}"
        command: >
          sh -lc 'if [ -f /var/solr/data/configsets/{{ solr_core_config }}/conf/moodle_schema.xml ] && [ ! -f /var/solr/data/configsets/{{ solr_core_config }}/conf/managed-schema ]; then
                    cp /var/solr/data/configsets/{{ solr_core_config }}/conf/moodle_schema.xml /var/solr/data/configsets/{{ solr_core_config }}/conf/managed-schema;
                  fi'
      when: not (solr_empty_core | default(false))
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: install-solr - Remove classic schema.xml (use managed-schema only)
  community.docker.docker_container_exec:
    container: "{{ solr_container_name }}"
    command: "sh -lc 'rm -f /var/solr/data/configsets/{{ solr_core_config }}/conf/schema.xml || true'"
  changed_when: false
  failed_when: false
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: install-solr - Set ownership for configSet (root inside container)
  community.docker.docker_container_exec:
    container: "{{ solr_container_name }}"
    user: "0"
    command: >
      sh -lc 'chown -R 8983:8983 /var/solr/data/configsets/{{ solr_core_config }}/conf &&
              find /var/solr/data/configsets/{{ solr_core_config }}/conf -type d -exec chmod 0755 {} \; &&
              find /var/solr/data/configsets/{{ solr_core_config }}/conf -type f -exec chmod 0644 {} \;'
  register: cfg_chown
  changed_when: cfg_chown.rc == 0
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: install-solr - Check configSet files in container (must have solrconfig.xml + managed-schema)
  community.docker.docker_container_exec:
    container: "{{ solr_container_name }}"
    command: "sh -lc 'test -f /var/solr/data/configsets/{{ solr_core_config }}/conf/solrconfig.xml && test -f /var/solr/data/configsets/{{ solr_core_config }}/conf/managed-schema'"
  register: configset_files_check
  failed_when: configset_files_check.rc != 0
  changed_when: false
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: install-solr - Ensure lang directory exists in configSet
  community.docker.docker_container_exec:
    container: "{{ solr_container_name }}"
    command: "sh -lc 'mkdir -p /var/solr/data/configsets/{{ solr_core_config }}/conf/lang'"
  changed_when: true
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: install-solr - Copy lang files from deployed location to configSet
  community.docker.docker_container_exec:
    container: "{{ solr_container_name }}"
    command: >
      sh -lc 'for f in /var/solr/data/lang/*; do
                if [ -f "$f" ]; then
                  cp "$f" /var/solr/data/configsets/{{ solr_core_config }}/conf/lang/;
                fi;
              done'
  changed_when: true
  when: not core_instance_present or solr_force_recreate_core | default(false)

- name: install-solr - Place stopword files under lang/ as referenced by schema.xml
  community.docker.docker_container_exec:
    container: "{{ solr_container_name }}"
    command: >
      sh -lc '
      for f in stopwords_en.txt stopwords_de.txt; do
        if [ -f /var/solr/data/configsets/{{ solr_core_config }}/conf/$f ]; then
          cp -f /var/solr/data/configsets/{{ solr_core_config }}/conf/$f /var/solr/data/configsets/{{ solr_core_config }}/conf/lang/;
        fi;
      done &&
      chown -R 8983:8983 /var/solr/data/configsets/{{ solr_core_config }}/conf/lang &&
      find /var/solr/data/configsets/{{ solr_core_config }}/conf/lang -type d -exec chmod 0755 {} \; &&
      find /var/solr/data/configsets/{{ solr_core_config }}/conf/lang -type f -exec chmod 0644 {} \;'
  changed_when: true
  when: not core_instance_present or solr_force_recreate_core | default(false)

# ---------------- Handle ghost registration ----------------

- name: install-solr - UNLOAD ghost registration when instance missing
  uri:
    url: "http://localhost:{{ solr_port }}/solr/admin/cores?action=UNLOAD&core={{ solr_core_name }}&deleteIndex=false&deleteInstanceDir=false"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
  register: core_unload
  failed_when: false
  when: core_registered and not core_instance_present

- name: install-solr - Mark as unregistered after unload
  set_fact:
    core_registered: false
  when: core_registered and not core_instance_present and (core_unload is defined)

# ---------------- API CREATE (schema.xml via configset) ----------------

- name: install-solr - Try API core CREATE (uses configSet)
  uri:
    url: "http://localhost:{{ solr_port }}/solr/admin/cores?action=CREATE&name={{ solr_core_name }}&configSet={{ solr_core_config }}"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
  register: core_creation
  failed_when: false
  when: not core_instance_present

- name: install-solr - Ping core if API CREATE succeeded
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/admin/ping"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
  register: core_ping
  retries: 10
  delay: 3
  until: core_ping.status == 200
  when:
    - not core_instance_present | default(false)
    - core_creation is defined
    - (core_creation.status | default(0)) == 200


# ---------------- Fallback: lay down core in volume (incl. schema.xml) ----------------

- name: install-solr - Fallback lay down core instance into volume (with correct UID)
  community.docker.docker_container:
    name: "solr_busybox_{{ ansible_date_time.epoch }}"
    image: busybox
    state: started
    detach: false
    cleanup: true
    user: "8983:8983"
    volumes:
      - "{{ solr_volume_name }}:/data"
      - "/tmp/solr_conf_{{ solr_core_config }}:/tmp/conf:ro"
    command: >
      sh -c "
      mkdir -p /data/{{ solr_core_name }}/conf &&
      cp -r /tmp/conf/* /data/{{ solr_core_name }}/conf/ &&
      printf 'name={{ solr_core_name }}\nconfigSet={{ solr_core_config }}\n' > /data/{{ solr_core_name }}/core.properties &&
      chmod 0644 /data/{{ solr_core_name }}/core.properties &&
      chmod 0755 /data/{{ solr_core_name }}/conf &&
      ls -la /data/{{ solr_core_name }}/conf"
  register: copy_conf
  when: not core_instance_present and not (core_creation is defined and core_creation.status == 200)

- name: install-solr - Restart Solr to pick up new core (fallback path)
  community.docker.docker_container:
    name: "{{ solr_container_name }}"
    state: started
    restart: yes
  when: copy_conf is defined and copy_conf.changed

- name: install-solr - Wait for Solr to be reachable (fallback path)
  wait_for:
    host: 127.0.0.1
    port: "{{ solr_port }}"
    state: started
    timeout: 60
  when: copy_conf is defined and copy_conf.changed

# ---------------- Final checks ----------------

- name: install-solr - Re-check instance after create/copy
  community.docker.docker_container_exec:
    container: "{{ solr_container_name }}"
    command: "test -f /var/solr/data/{{ solr_core_name }}/core.properties"
  register: core_dir_check_after
  failed_when: false
  changed_when: false

- name: install-solr - Update flags from final check
  set_fact:
    core_instance_present: "{{ core_dir_check_after.rc == 0 }}"
    core_exists: "{{ core_dir_check_after.rc == 0 }}"
  changed_when: false

- name: install-solr - Fail if core missing after all attempts
  fail:
    msg: |
      CRITICAL: Solr core {{ solr_core_name }} could not be created.
      Hints:
        - docker logs {{ solr_container_name }}
        - docker exec {{ solr_container_name }} ls -la /var/solr/data/configsets/{{ solr_core_config }}/conf/
        - docker exec {{ solr_container_name }} ls -la /var/solr/data/{{ solr_core_name }}/
        - Try: docker exec {{ solr_container_name }} solr create_core -c {{ solr_core_name }} -d {{ solr_core_config }}
  when: not core_instance_present

# ---------------- Post-config (runtime tuning, no schema copies) ----------------

- name: install-solr - Apply core config (maxBooleanClauses)
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/config"
    method: POST
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      set-property:
        query.maxBooleanClauses: "{{ solr_max_boolean_clauses }}"
    status_code: 200
  when: core_exists

- name: install-solr - Apply autoCommit settings
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/config"
    method: POST
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    body_format: json
    body:
      set-property:
        updateHandler.autoCommit.maxTime: "{{ solr_auto_commit_time }}"
        updateHandler.autoSoftCommit.maxTime: "{{ solr_auto_soft_commit_time }}"
    status_code: 200
  when: core_exists

- name: install-solr - Smoke test with Admin-Authorization role
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ solr_core_name }}/select?q=*:*"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
  register: core_query_test
  changed_when: false
  when: core_exists
