---
# Version: 2.0.0
# Description: Multi-Core and Single-Core dispatcher
# Changelog v2.0.0:
#   - NEW: Multi-Core Mode support
#   - NEW: Automatic mode detection
#   - NEW: Loop over solr_cores for multi-tenant setups
#   - BACKWARD COMPATIBLE: Single-core mode still works

# ============================================================================
# MODE DETECTION
# ============================================================================

- name: core-creation - Detect deployment mode
  set_fact:
    multi_core_mode_active: "{{ (solr_cores | default([]) | length) > 0 }}"
    cores_to_create: "{{ solr_cores | default([]) | length }}"
  changed_when: false

- name: core-creation - Display mode
  debug:
    msg:
      - "=========================================="
      - "CORE CREATION MODE"
      - "=========================================="
      - "Mode: {{ 'MULTI-CORE' if multi_core_mode_active else 'SINGLE-CORE (Legacy)' }}"
      - "Cores to process: {{ cores_to_create if multi_core_mode_active else 1 }}"
      - "=========================================="

# ============================================================================
# MULTI-CORE MODE
# ============================================================================

- name: core-creation - Process cores in Multi-Core mode
  include_tasks: core_creation_worker.yml
  loop: "{{ solr_cores }}"
  loop_control:
    loop_var: core_config
    label: "{{ core_config.name }}_core"
  when: multi_core_mode_active

# ============================================================================
# SINGLE-CORE MODE (Legacy/Backward Compatibility)
# ============================================================================

- name: core-creation - Process single core (legacy mode)
  include_tasks: core_creation_single.yml
  when: not multi_core_mode_active

- name: core-creation - Display completion summary
  debug:
    msg:
      - "=========================================="
      - "CORE CREATION COMPLETED"
      - "=========================================="
      - "Mode: {{ 'MULTI-CORE' if multi_core_mode_active else 'SINGLE-CORE' }}"
      - "Cores created/verified: {{ cores_to_create if multi_core_mode_active else 1 }}"
      - "=========================================="
