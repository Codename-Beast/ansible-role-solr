---
# Version: 2.0.0
# Description: Authentication tests for Solr installation
# Changelog v2.0.0:
#   - SIMPLIFIED: Removed document indexing tests (managed-schema = Moodle builds schema)
#   - SIMPLIFIED: Auth-only tests for all users (admin, support, moodle)
#   - KEPT: Infrastructure tests (container, security.json)
# Changelog v1.3.0:
#   - FIXED: Multi-Core Mode support - tests now use first core from config

# ============================================================================
# DETERMINE TEST CORE
# ============================================================================

- name: auth-test - Set test core name (Single-Core Mode)
  set_fact:
    test_core_name: "{{ solr_core_name }}"
  when: not multi_core_mode_active | default(false)
  changed_when: false

- name: auth-test - Set test core name (Multi-Core Mode)
  set_fact:
    test_core_name: "{{ solr_cores[0].name }}_core"
  when:
    - multi_core_mode_active | default(false)
    - solr_cores is defined
    - solr_cores | length > 0
  changed_when: false

- name: auth-test - Display test configuration
  debug:
    msg:
      - "Authentication Test Configuration:"
      - "Mode: {{ 'Multi-Core' if multi_core_mode_active | default(false) else 'Single-Core' }}"
      - "Test core: {{ test_core_name }}"

# ============================================================================
# AUTHENTICATION TESTS - ALL USERS
# ============================================================================

- name: auth-test - Test admin user authentication
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/admin/ping"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
  register: admin_auth_test
  changed_when: false

- name: auth-test - Test support user authentication
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/admin/ping"
    method: GET
    user: "{{ solr_support_user }}"
    password: "{{ solr_support_password }}"
    force_basic_auth: yes
    status_code: 200
  register: support_auth_test
  changed_when: false

- name: auth-test - Test moodle user authentication
  uri:
    url: "http://localhost:{{ solr_port }}/solr/{{ test_core_name }}/admin/ping"
    method: GET
    user: "{{ solr_moodle_user }}"
    password: "{{ solr_moodle_password }}"
    force_basic_auth: yes
    status_code: 200
  register: moodle_auth_test
  changed_when: false

# ============================================================================
# SECURITY TESTS - REJECTION & ISOLATION
# ============================================================================

- name: auth-test - Test rejection without credentials
  uri:
    url: "http://localhost:{{ solr_port }}/solr/admin/ping"
    method: GET
    status_code: 401
  register: auth_reject_test
  changed_when: false
  failed_when: auth_reject_test.status != 401

- name: auth-test - Test rejection with wrong credentials
  uri:
    url: "http://localhost:{{ solr_port }}/solr/admin/ping"
    method: GET
    user: "invalid_user"
    password: "invalid_password"
    force_basic_auth: yes
    status_code: 401
  register: auth_wrong_test
  changed_when: false
  failed_when: auth_wrong_test.status != 401

- name: auth-test - Test permission isolation (moodle cannot access admin API)
  uri:
    url: "http://localhost:{{ solr_port }}/solr/admin/cores"
    method: GET
    user: "{{ solr_moodle_user }}"
    password: "{{ solr_moodle_password }}"
    force_basic_auth: yes
    status_code: 403
  register: permission_test
  changed_when: false
  failed_when: permission_test.status != 403

# ============================================================================
# INFRASTRUCTURE TESTS
# ============================================================================

- name: auth-test - Check Docker container status
  command: "docker inspect --format='{{ '{{' }}.State.Status{{ '}}' }}' {{ solr_container_name }}"
  register: container_status
  changed_when: false

- name: auth-test - Check Docker container health
  command: "docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' {{ solr_container_name }}"
  register: container_health
  changed_when: false
  failed_when: false

- name: auth-test - Test security.json is present in container
  command: docker exec {{ solr_container_name }} ls -la /var/solr/data/security.json
  register: security_json_check
  changed_when: false

# ============================================================================
# TEST RESULTS SUMMARY
# ============================================================================

- name: auth-test - Calculate test results
  set_fact:
    tests_passed: "{{ [
      admin_auth_test.status == 200,
      support_auth_test.status == 200,
      moodle_auth_test.status == 200,
      auth_reject_test.status == 401,
      auth_wrong_test.status == 401,
      permission_test.status == 403,
      container_status.stdout | trim == 'running',
      security_json_check.rc == 0
      ] | select('true') | list | length }}"
    tests_total: 8

- name: auth-test - Create Rundeck-compatible output
  set_fact:
    auth_tests_result:
      status: "{{ 'success' if tests_passed | int == tests_total | int else 'warning' }}"
      timestamp: "{{ ansible_date_time.iso8601 }}"
      message: "Authentication tests completed"
      summary:
        tests_total: "{{ tests_total }}"
        tests_passed: "{{ tests_passed }}"
        tests_failed: "{{ tests_total | int - tests_passed | int }}"
        success_rate: "{{ ((tests_passed | int / tests_total | int) * 100) | round(2) }}%"
      test_results:
        admin_auth: "{{ 'PASSED' if admin_auth_test.status == 200 else 'FAILED' }}"
        support_auth: "{{ 'PASSED' if support_auth_test.status == 200 else 'FAILED' }}"
        moodle_auth: "{{ 'PASSED' if moodle_auth_test.status == 200 else 'FAILED' }}"
        reject_no_creds: "{{ 'PASSED' if auth_reject_test.status == 401 else 'FAILED' }}"
        reject_wrong_creds: "{{ 'PASSED' if auth_wrong_test.status == 401 else 'FAILED' }}"
        permission_isolation: "{{ 'PASSED' if permission_test.status == 403 else 'FAILED' }}"
        container_running: "{{ 'PASSED' if container_status.stdout | trim == 'running' else 'FAILED' }}"
        security_json: "{{ 'PASSED' if security_json_check.rc == 0 else 'FAILED' }}"

- name: auth-test - Display Rundeck output
  debug:
    msg: "{{ auth_tests_result | to_nice_json }}"
  when: rundeck_integration_enabled | default(false)

- name: auth-test - Display standard summary
  debug:
    msg:
      - "============================================"
      - "       AUTHENTICATION TESTS COMPLETED       "
      - "============================================"
      - "Mode: {{ 'Multi-Core' if multi_core_mode_active | default(false) else 'Single-Core' }}"
      - "Core: {{ test_core_name }}"
      - "Results: {{ tests_passed }}/{{ tests_total }} ({{ ((tests_passed | int / tests_total | int) * 100) | round(2) }}%)"
      - "--------------------------------------------"
      - "USER AUTHENTICATION:"
      - "  Admin ({{ solr_admin_user }}):     {{ 'PASSED' if admin_auth_test.status == 200 else 'FAILED' }}"
      - "  Support ({{ solr_support_user }}): {{ 'PASSED' if support_auth_test.status == 200 else 'FAILED' }}"
      - "  Moodle ({{ solr_moodle_user }}):   {{ 'PASSED' if moodle_auth_test.status == 200 else 'FAILED' }}"
      - "--------------------------------------------"
      - "SECURITY:"
      - "  Reject (no creds):    {{ 'PASSED' if auth_reject_test.status == 401 else 'FAILED' }}"
      - "  Reject (wrong creds): {{ 'PASSED' if auth_wrong_test.status == 401 else 'FAILED' }}"
      - "  Permission isolation: {{ 'PASSED' if permission_test.status == 403 else 'FAILED' }}"
      - "--------------------------------------------"
      - "INFRASTRUCTURE:"
      - "  Container running:    {{ 'PASSED' if container_status.stdout | trim == 'running' else 'FAILED' }}"
      - "  Container health:     {{ container_health.stdout if container_health.rc == 0 else 'N/A' }}"
      - "  security.json:        {{ 'PASSED' if security_json_check.rc == 0 else 'FAILED' }}"
      - "============================================"
  when: not rundeck_integration_enabled | default(false)

- name: auth-test - Fail if critical tests failed
  fail:
    msg: "Critical authentication tests failed. Please review the test results above."
  when:
    - admin_auth_test.status != 200 or container_status.stdout | trim != 'running'
