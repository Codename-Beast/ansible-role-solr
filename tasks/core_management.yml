---
# Version: 3.0.0
# Description: Unified core creation and reload management
# Changelog v3.0.0:
#   - CONSOLIDATED: Merged core_creation.yml + core_reload.yml
#   - REDUCTION: 146 lines → single orchestration file
#   - REASON: Both files are simple orchestrators, easier to maintain together

# ============================================================================
# CORE CREATION - MODE DETECTION
# ============================================================================

- name: core-mgmt - Detect deployment mode
  set_fact:
    multi_core_mode_active: "{{ (solr_cores | default([]) | length) > 0 }}"
    cores_to_create: "{{ solr_cores | default([]) | length }}"
  changed_when: false

- name: core-mgmt - Display mode
  debug:
    msg:
      - "=========================================="
      - "CORE CREATION MODE"
      - "=========================================="
      - "Mode: {{ 'MULTI-CORE' if multi_core_mode_active else 'SINGLE-CORE (Legacy)' }}"
      - "Cores to process: {{ cores_to_create if multi_core_mode_active else 1 }}"
      - "=========================================="

# ============================================================================
# CORE CREATION - MULTI-CORE MODE
# ============================================================================

- name: core-mgmt - Process cores in Multi-Core mode
  include_tasks: core_creation_worker.yml
  loop: "{{ solr_cores }}"
  loop_control:
    loop_var: core_config
    label: "{{ core_config.name }}_core"
  when: multi_core_mode_active

# ============================================================================
# CORE CREATION - SINGLE-CORE MODE (Legacy/Backward Compatibility)
# ============================================================================

- name: core-mgmt - Process single core (legacy mode)
  include_tasks: core_creation_single.yml
  when: not multi_core_mode_active

- name: core-mgmt - Display creation completion summary
  debug:
    msg:
      - "=========================================="
      - "CORE CREATION COMPLETED"
      - "=========================================="
      - "Mode: {{ 'MULTI-CORE' if multi_core_mode_active else 'SINGLE-CORE' }}"
      - "Cores created/verified: {{ cores_to_create if multi_core_mode_active else 1 }}"
      - "=========================================="

# ============================================================================
# CORE RELOAD - Reload all cores to pick up config changes
# ============================================================================

- name: core-mgmt - Wait for Solr to be fully ready
  uri:
    url: "http://localhost:{{ solr_port }}/solr/admin/cores?action=STATUS"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
  register: solr_health
  until: solr_health.status == 200
  retries: 10
  delay: 3
  changed_when: false

- name: core-mgmt - Get list of all cores
  uri:
    url: "http://localhost:{{ solr_port }}/solr/admin/cores?action=STATUS"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    return_content: yes
  register: cores_status
  changed_when: false

- name: core-mgmt - Parse cores list
  set_fact:
    core_names: "{{ cores_status.json.status.keys() | list }}"
  changed_when: false

- name: core-mgmt - Display cores to reload
  debug:
    msg:
      - "=========================================="
      - "RELOADING CORES TO PICK UP CONFIG CHANGES"
      - "=========================================="
      - "Cores found: {{ core_names | length }}"
      - "Core list: {{ core_names | join(', ') }}"
      - "=========================================="

- name: core-mgmt - Reload each core via API
  uri:
    url: "http://localhost:{{ solr_port }}/solr/admin/cores?action=RELOAD&core={{ item }}"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
  loop: "{{ core_names }}"
  register: reload_results
  when: core_names | length > 0
  changed_when: true

- name: core-mgmt - Display reload summary
  debug:
    msg:
      - "=========================================="
      - "CORE RELOAD COMPLETED"
      - "=========================================="
      - "Cores reloaded: {{ core_names | length }}"
      - "Status: ✅ All cores now using updated configs"
      - "Note: Deprecated warnings should be gone now"
      - "=========================================="
  when: core_names | length > 0

- name: core-mgmt - No cores to reload
  debug:
    msg:
      - "=========================================="
      - "CORE RELOAD SKIPPED"
      - "=========================================="
      - "Reason: No cores found"
      - "=========================================="
  when: core_names | length == 0
