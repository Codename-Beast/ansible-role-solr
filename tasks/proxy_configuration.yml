---
# Version: 2.0.0
# Description: Webserver proxy configuration for Solr (Apache + Nginx)
# Changelog v2.0:
#   - NEW: Nginx support (solr_webserver: "apache" | "nginx")
#   - NEW: Domain-based config naming (domain.de.conf)
#   - NEW: HTTPS availability testing (up to 10 retries)
#   - IMPROVED: Standalone VirtualHost/Server configs
#   - IMPROVED: Let's Encrypt integration hints

# ============================================================================
# WEBSERVER DETECTION
# ============================================================================

- name: proxy_config - Detect webserver type
  set_fact:
    detected_webserver: "{{ solr_webserver | default('apache') }}"

- name: proxy_config - Display webserver type
  debug:
    msg: "Configuring proxy for webserver: {{ detected_webserver }}"

# ============================================================================
# APACHE CONFIGURATION
# ============================================================================

- name: proxy_config - Check if Apache is installed and running
  command: systemctl is-active apache2
  register: apache_check
  changed_when: false
  failed_when: false
  when: detected_webserver == "apache"

- name: proxy_config - Fail if Apache not running and required
  fail:
    msg: "Apache is not running. Please start Apache (systemctl start apache2) or set solr_webserver='nginx'"
  when:
    - detected_webserver == "apache"
    - apache_check.rc != 0
    - solr_proxy_enabled | default(true)

- name: proxy_config - Get Apache version for display
  command: apache2 -v
  register: apache_version
  changed_when: false
  failed_when: false
  when:
    - detected_webserver == "apache"
    - apache_check.rc == 0

- name: proxy_config - Enable required Apache modules
  apache2_module:
    name: "{{ item }}"
    state: present
  loop:
    - proxy
    - proxy_http
    - headers
    - rewrite
  become: true
  notify: restart apache
  when: detected_webserver == "apache"

- name: proxy_config - Enable SSL module if SSL is enabled (Apache)
  apache2_module:
    name: ssl
    state: present
  become: true
  when:
    - detected_webserver == "apache"
    - solr_ssl_enabled | default(false)
  notify: restart apache

# ============================================================================
# NGINX CONFIGURATION
# ============================================================================

- name: proxy_config - Check if Nginx is installed and running
  command: systemctl is-active nginx
  register: nginx_check
  changed_when: false
  failed_when: false
  when: detected_webserver == "nginx"

- name: proxy_config - Fail if Nginx not running and required
  fail:
    msg: "Nginx is not running. Please start Nginx (systemctl start nginx) or set solr_webserver='apache'"
  when:
    - detected_webserver == "nginx"
    - nginx_check.rc != 0
    - solr_proxy_enabled | default(true)

- name: proxy_config - Get Nginx version for display
  command: nginx -v
  register: nginx_version
  changed_when: false
  failed_when: false
  when:
    - detected_webserver == "nginx"
    - nginx_check.rc == 0

# ============================================================================
# SSL CERTIFICATE CHECK
# ============================================================================

- name: proxy_config - Check if SSL certificate exists
  stat:
    path: "{{ solr_ssl_cert_path }}/fullchain.pem"
  register: ssl_cert_check
  when: solr_ssl_enabled | default(false)

- name: proxy_config - Warn if SSL certificate not found
  debug:
    msg:
      - "⚠️  WARNING: SSL certificate not found at {{ solr_ssl_cert_path }}"
      - "Please install Let's Encrypt certificates first:"
      - "  sudo certbot certonly --webroot -w /var/www/html -d {{ solr_app_domain }}"
      - "  OR for Apache: sudo certbot --apache -d {{ solr_app_domain }}"
      - "  OR for Nginx: sudo certbot --nginx -d {{ solr_app_domain }}"
      - "Continuing without SSL - configuration will be HTTP only"
  when:
    - solr_ssl_enabled | default(false)
    - not ssl_cert_check.stat.exists | default(false)

# ============================================================================
# DOMAIN-BASED CONFIG NAMING
# ============================================================================

- name: proxy_config - Set domain-based config filename
  set_fact:
    solr_proxy_config_file: "solr.{{ solr_app_domain | default('localhost') }}.conf"

- name: proxy_config - Display config filename
  debug:
    msg: "Config file will be: {{ solr_proxy_config_file }}"

# ============================================================================
# APACHE PROXY CONFIGURATION
# ============================================================================

- name: proxy_config - Create Solr proxy configuration for Apache
  template:
    src: solr_proxy_apache.conf.j2
    dest: "/etc/apache2/sites-available/{{ solr_proxy_config_file }}"
    owner: root
    group: root
    mode: '0644'
  become: true
  register: apache_config
  when:
    - detected_webserver == "apache"
    - ansible_os_family == "Debian"

- name: proxy_config - Enable Solr site configuration (Apache)
  command: a2ensite {{ solr_proxy_config_file }}
  become: true
  register: site_enabled
  changed_when: "'Enabling site' in site_enabled.stdout"
  notify: reload apache
  when:
    - detected_webserver == "apache"
    - ansible_os_family == "Debian"

- name: proxy_config - Test Apache configuration syntax
  command: apache2ctl configtest
  register: apache_test
  changed_when: false
  failed_when: false
  become: true
  when: detected_webserver == "apache"

- name: proxy_config - Display Apache config test result
  debug:
    msg:
      - "Apache configuration test: {{ 'PASSED ✅' if 'Syntax OK' in apache_test.stderr else 'WARNING ⚠️' }}"
      - "{{ apache_test.stderr }}"
  when: detected_webserver == "apache"

- name: proxy_config - Reload Apache if configuration changed
  systemd:
    name: apache2
    state: reloaded
  become: true
  when:
    - detected_webserver == "apache"
    - apache_config.changed | default(false) or site_enabled.changed | default(false)

# ============================================================================
# NGINX PROXY CONFIGURATION
# ============================================================================

- name: proxy_config - Create Solr proxy configuration for Nginx
  template:
    src: solr_proxy_nginx.conf.j2
    dest: "/etc/nginx/sites-available/{{ solr_proxy_config_file }}"
    owner: root
    group: root
    mode: '0644'
  become: true
  register: nginx_config
  when:
    - detected_webserver == "nginx"
    - ansible_os_family == "Debian"

- name: proxy_config - Enable Solr site configuration (Nginx)
  file:
    src: "/etc/nginx/sites-available/{{ solr_proxy_config_file }}"
    dest: "/etc/nginx/sites-enabled/{{ solr_proxy_config_file }}"
    state: link
  become: true
  register: nginx_site_enabled
  when:
    - detected_webserver == "nginx"
    - ansible_os_family == "Debian"

- name: proxy_config - Test Nginx configuration syntax
  command: nginx -t
  register: nginx_test
  changed_when: false
  failed_when: false
  become: true
  when: detected_webserver == "nginx"

- name: proxy_config - Display Nginx config test result
  debug:
    msg:
      - "Nginx configuration test: {{ 'PASSED ✅' if nginx_test.rc == 0 else 'WARNING ⚠️' }}"
      - "{{ nginx_test.stderr }}"
  when: detected_webserver == "nginx"

- name: proxy_config - Reload Nginx if configuration changed
  systemd:
    name: nginx
    state: reloaded
  become: true
  when:
    - detected_webserver == "nginx"
    - nginx_config.changed | default(false) or nginx_site_enabled.changed | default(false)

# ============================================================================
# HTTPS AVAILABILITY TESTING (up to 10 retries)
# ============================================================================

- name: proxy_config - Test HTTPS availability
  uri:
    url: "https://{{ solr_app_domain }}{{ solr_proxy_path | default('/solr-admin') }}/admin/ping"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
    validate_certs: yes
    timeout: 10
  register: https_test
  until: https_test.status == 200
  retries: 10
  delay: 3
  changed_when: false
  failed_when: false
  when: solr_ssl_enabled | default(false)

- name: proxy_config - Display HTTPS test result
  debug:
    msg:
      - "HTTPS availability test: {{ 'PASSED ✅' if https_test.status == 200 else 'FAILED ❌' }}"
      - "URL: https://{{ solr_app_domain }}{{ solr_proxy_path | default('/solr-admin') }}/"
      - "Retries needed: {{ https_test.attempts | default(0) }}"
  when: solr_ssl_enabled | default(false)

# ============================================================================
# HTTP FALLBACK TESTING
# ============================================================================

- name: proxy_config - Test HTTP proxy endpoint (fallback)
  uri:
    url: "http://localhost{{ solr_proxy_path | default('/solr-admin') }}/admin/ping"
    method: GET
    user: "{{ solr_admin_user }}"
    password: "{{ solr_admin_password }}"
    force_basic_auth: yes
    status_code: 200
    timeout: 10
  register: http_test
  until: http_test.status == 200
  retries: 5
  delay: 3
  changed_when: false
  failed_when: false
  when: not solr_ssl_enabled | default(false)

- name: proxy_config - Display HTTP test result
  debug:
    msg:
      - "HTTP availability test: {{ 'PASSED ✅' if http_test.status == 200 else 'FAILED ❌' }}"
      - "URL: http://{{ solr_app_domain }}{{ solr_proxy_path | default('/solr-admin') }}/"
  when: not solr_ssl_enabled | default(false)

# ============================================================================
# RUNDECK OUTPUT
# ============================================================================

- name: proxy_config - Create Rundeck output
  set_fact:
    proxy_configuration_result:
      status: "success"
      timestamp: "{{ ansible_date_time.iso8601 }}"
      message: "Proxy configuration completed"
      details:
        webserver: "{{ detected_webserver }}"
        config_file: "{{ solr_proxy_config_file }}"
        proxy_path: "{{ solr_proxy_path | default('/solr-admin') }}"
        proxy_target: "http://localhost:{{ solr_port }}/solr"
        webserver_version: "{{ apache_version.stdout if detected_webserver == 'apache' else nginx_version.stderr }}"
        ssl_enabled: "{{ solr_ssl_enabled | default(false) }}"
        ssl_cert_exists: "{{ ssl_cert_check.stat.exists if solr_ssl_enabled | default(false) else false }}"
        config_test: "{{ 'PASSED' if (detected_webserver == 'apache' and 'Syntax OK' in apache_test.stderr) or (detected_webserver == 'nginx' and nginx_test.rc == 0) else 'WARNING' }}"
        https_test: "{{ 'PASSED' if https_test.status | default(0) == 200 else 'NOT_TESTED' }}"
        http_test: "{{ 'PASSED' if http_test.status | default(0) == 200 else 'NOT_TESTED' }}"
        proxy_url: "{{ 'https' if solr_ssl_enabled | default(false) else 'http' }}://{{ solr_app_domain }}{{ solr_proxy_path | default('/solr-admin') }}"

- name: proxy_config - Display Rundeck output
  debug:
    msg: "{{ proxy_configuration_result | to_nice_json }}"
  when: rundeck_integration_enabled | default(false)

# ============================================================================
# STANDARD SUMMARY
# ============================================================================

- name: proxy_config - Display summary
  debug:
    msg:
      - "╔════════════════════════════════════════════════════════════════╗"
      - "║            PROXY CONFIGURATION COMPLETED                       ║"
      - "╠════════════════════════════════════════════════════════════════╣"
      - "║ Webserver:     {{ detected_webserver | upper }}"
      - "║ Config file:   {{ solr_proxy_config_file }}"
      - "║ Proxy path:    {{ solr_proxy_path | default('/solr-admin') }}"
      - "║ Proxy target:  http://localhost:{{ solr_port }}/solr"
      - "║ SSL enabled:   {{ 'YES ✅' if solr_ssl_enabled | default(false) else 'NO' }}"
      - "║ SSL cert:      {{ 'FOUND ✅' if ssl_cert_check.stat.exists | default(false) else 'NOT FOUND ⚠️' }}"
      - "║ Config test:   {{ 'PASSED ✅' if (detected_webserver == 'apache' and 'Syntax OK' in apache_test.stderr | default('')) or (detected_webserver == 'nginx' and nginx_test.rc | default(1) == 0) else 'WARNING ⚠️' }}"
      - "║ HTTPS test:    {{ 'PASSED ✅' if https_test.status | default(0) == 200 else 'NOT TESTED' }}"
      - "║ HTTP test:     {{ 'PASSED ✅' if http_test.status | default(0) == 200 else 'NOT TESTED' }}"
      - "╠════════════════════════════════════════════════════════════════╣"
      - "║ Proxy URL:     {{ 'https' if solr_ssl_enabled | default(false) else 'http' }}://{{ solr_app_domain }}{{ solr_proxy_path | default('/solr-admin') }}/"
      - "╚════════════════════════════════════════════════════════════════╝"
  when: not rundeck_integration_enabled | default(false)
