---
# Description: Generate secure password for a single core user if missing/weak
# Included by auth_management.yml for each core user

- name: auth-pwd-gen - Extract user config
  set_fact:
    pwd_core_name: "{{ core_user_item.0.name }}"
    pwd_user: "{{ core_user_item.1 }}"
  no_log: true

- name: auth-pwd-gen - Check if password is missing or weak
  set_fact:
    need_password_generation: "{{ pwd_user.password | default('') | length < 12 }}"

- name: auth-pwd-gen - Generate secure password for {{ pwd_user.username }}
  shell: openssl rand -base64 24 | tr -d '/+=' | head -c 24
  register: generated_password
  changed_when: false
  when: need_password_generation | bool
  no_log: true

- name: auth-pwd-gen - Use generated or provided password
  set_fact:
    final_password: "{{ generated_password.stdout if need_password_generation | bool else pwd_user.password }}"
  no_log: true

- name: auth-pwd-gen - Update user password in core config
  set_fact:
    updated_user: "{{ pwd_user | combine({'password': final_password, 'password_was_generated': need_password_generation | bool}) }}"
  no_log: true

- name: auth-pwd-gen - Track generated credential
  set_fact:
    generated_credentials: "{{ generated_credentials + [{'core': pwd_core_name, 'username': pwd_user.username, 'password': final_password, 'was_generated': need_password_generation | bool}] }}"
  when: need_password_generation | bool
  no_log: false  # We want to track this!
