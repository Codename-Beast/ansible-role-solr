---
# Version: 1.3.2
# Description: Persist Solr credentials with idempotency and selective updates
# Changelog v1.3.2:
#   - FIXED: Support for dynamic inventory 
# Changelog v1.3.1:
#   - FIXED: No more duplicate entries in host_vars (proper marker usage)
#   - FIXED: Idempotent backup (no timestamp in filename)
#   - ADDED: Selective updates (only changed values)
#   - OPTIMIZED: Can run unlimited times without side effects

- name: auth-persist - Determine host_vars directory
  set_fact:
    host_vars_dir: >-
      {{
        inventory_dir | default(playbook_dir + '/host_vars_generated')
        if (inventory_dir is defined and inventory_dir | length > 0 and inventory_dir != '/')
        else playbook_dir + '/host_vars_generated'
      }}
  delegate_to: localhost

- name: auth-persist - Check if host_vars directory is usable
  set_fact:
    can_persist_to_inventory: "{{ host_vars_dir != playbook_dir + '/host_vars_generated' }}"
  delegate_to: localhost

- name: auth-persist - Warn if using fallback directory
  debug:
    msg:
      - "WARNING: inventory_dir is not available (dynamic inventory or localhost)"
      - "Using fallback directory: {{ host_vars_dir }}"
      - "Credentials will be saved but may not persist across runs"
  when: not can_persist_to_inventory
  delegate_to: localhost

- name: auth-persist - Read current host_vars if exists
  stat:
    path: "{{ host_vars_dir }}/{{ inventory_hostname }}"
  register: host_vars_file
  delegate_to: localhost

- name: auth-persist - Update credentials in host_vars
  blockinfile:
    path: "{{ host_vars_dir }}/{{ inventory_hostname }}"
    create: yes
    marker: "# {mark} ANSIBLE MANAGED BLOCK - SOLR CREDENTIALS"
    marker_begin: "BEGIN"
    marker_end: "END"
    block: |
      # Solr Authentication Configuration
      # Host: {{ inventory_hostname }}
      # Customer: {{ customer_name | default('default') }}

      # IMPORTANT: Only change these values if you want to update credentials
      # After changing, run the playbook to apply changes

      solr_admin_password: "{{ solr_admin_password }}"
      solr_support_password: "{{ solr_support_password }}"
      solr_customer_password: "{{ solr_customer_password }}"

      solr_admin_user: "{{ solr_admin_user | default('admin') }}"
      solr_support_user: "{{ solr_support_user | default('support') }}"
      solr_customer_user: "{{ solr_customer_user | default('customer') }}"

      solr_core_name_override: "{{ solr_core_name }}"
      solr_port: {{ solr_port }}
  delegate_to: localhost
  run_once: true

- name: auth-persist - Display persistence summary
  debug:
    msg:
      - "========================================"
      - "CREDENTIALS PERSISTED"
      - "========================================"
      - "Host vars: {{ host_vars_dir }}/{{ inventory_hostname }}"
      - "Control Node: $HOME/.ansible-solr-passwords/{{ inventory_hostname }}/"
      - "Container: /var/solr/data/security.json (hashes only)"
      - ""
      - "IDEMPOTENCY:"
      - "  - Multiple runs: No duplicates"
      - "  - Only updates: Changed values"
      - ""
      - "SECURITY:"
      - "  - Container: Hashes only (SHA256 double-hash)"
      - ""
      - "========================================"
