---
# Version: 1.5.0
# Description: Default variables for Solr installation
# Changelog v1.5.0:
#   - ADDED: Config file management for init-container
#   - ADDED: Core name sanitization (max 10 chars)
#   - ADDED: Checksum-based config updates
#   - ADDED: Config backup settings
# Changelog v1.4.0:
#   - FIXED: Variable naming consistency (removed confusing mappings)
#   - FIXED: Hardcoded values moved to defaults
#   - ADDED: Retry and timeout configurations

# ============================================================================
# AUTHENTICATION CONFIGURATION
# ============================================================================
# IMPORTANT: Use these names in host_vars:
#   solr_admin_password: "your_password"
#   solr_support_password: "your_password"  
#   solr_customer_password: "your_password"

solr_admin_user: "admin"
solr_admin_password: ""  # Auto-generated if empty
solr_admin_password_hash: ""

solr_support_user: "support"
solr_support_password: ""  # Auto-generated if empty
solr_support_password_hash: ""

solr_customer_user: "customer"
solr_customer_password: ""  # Auto-generated if empty
solr_customer_password_hash: ""

solr_auth_enabled: true
solr_auth_type: "basic"
solr_auth_realm: "Solr Eledia"
solr_forward_credentials: false
# ============================================================================
# HASH CONFIGURATION
# ============================================================================
solr_hash_salt_bytes: 32  # SHA256 requires 32 bytes
solr_hash_algorithm: "sha256"
# ============================================================================
# RETRY & TIMEOUT CONFIGURATION
# ============================================================================
# Container deployment
solr_container_start_retries: 5
solr_container_start_delay: 5  # seconds
# Authentication validation
solr_auth_validation_retries: 5
solr_auth_validation_delay: 3  # seconds
# Core creation
solr_core_creation_retries: 5
solr_core_creation_delay: 3  # seconds
# Health checks
solr_health_check_timeout: 30
solr_startup_wait_time: 60
solr_init_container_timeout: 60
solr_init_container_retries: 5
# ============================================================================
# DOCKER CONFIGURATION
# ============================================================================
solr_version: "9.9.0"
solr_major_version: "{{ solr_version.split('.')[0] }}"
solr_container_name: "solr_{{ customer_name | default('default_eledia') }}"
solr_volume_name: "solr_data_{{ customer_name | default('default_eledia') }}"
solr_network_name: "solr_network"
solr_create_systemd_service: false
solr_port: 8983
solr_jmx_port: 18983
# ============================================================================
# DIRECTORY CONFIGURATION
# ============================================================================
solr_compose_dir: "/opt/solr"
solr_config_dir: "{{ solr_compose_dir }}/config"
solr_data_dir: "/var/solr/data"
solr_backup_dir: "/var/solr/backup"
solr_backup_configs_dir: "{{ solr_backup_dir }}/configs"
solr_log_dir: "/var/log/eledia/solr"

# Config files to be deployed by init-container
solr_config_files:
  - name: "security.json"
    template: "security.json.j2"
    dest_path: "/var/solr/data"
    validate_json: true
  - name: "solrconfig.xml"
    template: "solrconfig.xml.j2"
    dest_path: "/var/solr/data/configs"
    validate_xml: true
  - name: "stopwords.txt"
    template: "stopwords.txt.j2"
    dest_path: "/var/solr/data/configs"
    validate_json: false
  - name: "stopwords_de.txt"
    template: "stopwords_de.txt.j2"
    dest_path: "/var/solr/data/configs"
    validate_json: false
  - name: "stopwords_en.txt"
    template: "stopwords_en.txt.j2"
    dest_path: "/var/solr/data/configs"
    validate_json: false
  - name: "synonyms.txt"
    template: "synonyms.txt.j2"
    dest_path: "/var/solr/data/configs"
    validate_json: false
  - name: "protwords.txt"
    template: "protwords.txt.j2"
    dest_path: "/var/solr/data/configs"
    validate_json: false
  - name: "moodle_schema.xml"
    template: "moodle_schema.xml.j2"
    dest_path: "/var/solr/data/configs"
    validate_xml: true

# Config backup settings
solr_backup_configs_enabled: true
solr_backup_configs_before_update: true
# ============================================================================
# CORE CONFIGURATION
# ============================================================================
# Core name sanitization (max 10 chars total: 6 chars + "_core" suffix = 11 chars, but Solr allows up to 255)
# For strict 10 char limit, use [:6] before adding "_core" (6+5=11), or [:10] without suffix
solr_core_name_raw: "{{ moodle_app_domain.split('.')[0] if moodle_app_domain is defined else customer_name | default('default') }}"
solr_core_name_sanitized: "{{ solr_core_name_raw[:20] | regex_replace('[^a-zA-Z0-9_]', '_') | lower }}"
# Only add _core suffix if not already present and total length <= 50 chars (Solr supports up to 255)
solr_core_name: "{{ solr_core_name_sanitized if solr_core_name_sanitized.endswith('_core') else (solr_core_name_sanitized[:45] + '_core') if solr_core_name_sanitized|length > 45 else solr_core_name_sanitized + '_core' }}"
solr_core_config: "moodle_configs"
# ============================================================================
# MEMORY CONFIGURATION
# ============================================================================
solr_heap_size: "2g"
solr_memory_limit: "2g"
solr_memory_swap: "2g"
solr_cpu_quota: 100000
solr_cpu_period: 100000
# ============================================================================
# PROXY CONFIGURATION
# ============================================================================
solr_proxy_enabled: false
solr_proxy_path: "/solr-admin"
solr_webserver: "apache"
# ============================================================================
# SSL CONFIGURATION
# ============================================================================
solr_ssl_enabled: false
solr_ssl_cert_path: "/etc/letsencrypt/live/{{ moodle_app_domain | default('localhost') }}"
# ============================================================================
# SOLR SETTINGS
# ============================================================================
solr_max_boolean_clauses: 1024
solr_auto_commit_time: 15000  # milliseconds
solr_auto_soft_commit_time: 1000  # milliseconds
solr_log_level: "INFO"
# ============================================================================
# MOODLE CONFIGURATION
# ============================================================================
solr_multi_version_cores: true
solr_single_core_name: "{{ customer_name | default('default') }}_core"

solr_moodle_versions_config:
  "4.1":
    max_field_length: 32766
    use_legacy_date: false
    features: ["basic_search", "file_indexing"]
  "4.2":
    max_field_length: 32766
    use_legacy_date: false
    features: ["basic_search", "file_indexing", "multilang"]
  "4.3":
    max_field_length: 32766
    use_legacy_date: false
    features: ["basic_search", "file_indexing", "multilang", "categories"]
  "4.4":
    max_field_length: 65536
    use_legacy_date: false
    features: ["basic_search", "file_indexing", "multilang", "categories", "completion"]
  "5.0":
    max_field_length: 65536
    use_legacy_date: false
    features: ["basic_search", "file_indexing", "multilang", "categories", "completion", "competencies", "outcomes", "tags"]
  "5.0.x":
    max_field_length: 65536
    use_legacy_date: false
    features: ["basic_search", "file_indexing", "multilang", "categories", "completion", "competencies", "outcomes", "tags"]

solr_moodle_performance:
  "4.1": { heap: "1g", cache_size: 1024 }
  "4.2": { heap: "1g", cache_size: 1024 }
  "4.3": { heap: "1g", cache_size: 1024 }
  "4.4": { heap: "1g", cache_size: 1024 }
  "5.0": { heap: "2g", cache_size: 2048 }
  "5.0.x": { heap: "2g", cache_size: 2048 }

solr_use_moodle_schema: true
solr_moodle_test_docs: true
solr_moodle_versions: ["4.1", "4.2", "4.3", "4.4", "5.0.x"]
# ============================================================================
# BACKUP CONFIGURATION
# ============================================================================
solr_backup_enabled: false
solr_backup_retention: 7  # days
solr_backup_credentials: false
# ============================================================================
# DEPLOYMENT FLAGS
# ============================================================================
solr_force_recreate: false
solr_force_pull: false
solr_force_reconfigure_auth: true
solr_validate_deployment: true
solr_start_command: "solr-foreground"
# ============================================================================
# SYSTEM REQUIREMENTS
# ============================================================================
solr_min_disk_space_gb: 5
solr_min_memory_gb: 2
# ============================================================================
# DOCKER API
# ============================================================================
docker_api_version: "1.41"
docker_timeout: 60
docker_compose_version: "2.0"
# ============================================================================
# AUTOMATIC CUSTOMER NAME
# ============================================================================
customer_name: "{{ moodle_app_domain.split('.')[0] if moodle_app_domain is defined else 'default_core' }}"
# ============================================================================
# MOODLE PATHS
# ============================================================================
moodle_solr_host: "localhost"
moodle_solr_port: "{{ solr_port }}"
moodle_solr_secure: false
moodle_solr_username: "{{ solr_customer_user }}"
moodle_env: "public_html"
moodle_eledia_path: "/home/vhosts/moodle"
moodle_config_path: "{{ moodle_eledia_path }}/{{ moodle_app_domain }}/{{ moodle_env }}/config.php"
# ============================================================================
# RUNDECK INTEGRATION
# ============================================================================
rundeck_integration_enabled: false
rundeck_api_url: ""
rundeck_api_token: ""
rundeck_api_version: "40"
rundeck_project_name: ""
rundeck_webhook_enabled: false
rundeck_webhook_secret: ""
# ============================================================================
# NOTIFICATION
# ============================================================================
notification_enabled: false
admin_email: ""
