---
#######################################################################
# Default variable definitions for Solr role enhancements.
# Fixes/Improvements:
# 1. Added ``solr_additional_users`` to allow provisioning of extra Solr users.
# 2. Added ``solr_core_admin_role_prefix`` to configure per-core administrator role names.
# 3. Provided documentation comments for each variable to aid understanding.
# 4. Ensured sensible defaults (empty list and "core-admin") for backward compatibility.
# 5. Maintains existing behaviour for pre-defined users while enabling extensibility.
#######################################################################
# Version: 1.6.0
# Description: Default variables for Solr installation
# Changelog v1.6.0:
#   - ADDED: Dynamic user management via solr_additional_users
#   - ADDED: Per-core admin role prefix configuration
#   - ADDED: Support for multi-tenant user provisioning
# Changelog v1.5.0:
#   - ADDED: Config file management for init-container
#   - ADDED: Core name sanitization (max 10 chars)
#   - ADDED: Checksum-based config updates
#   - ADDED: Config backup settings
# Changelog v1.4.0:
#   - FIXED: Variable naming consistency (removed confusing mappings)
#   - FIXED: Hardcoded values moved to defaults
#   - ADDED: Retry and timeout configurations

# ============================================================================
# AUTHENTICATION CONFIGURATION
# ============================================================================
# IMPORTANT: Use these names in host_vars:
#   solr_admin_password: "your_password"
#   solr_support_password: "your_password"
#   solr_moodle_password: "your_password"

solr_admin_user: "admin"
solr_admin_password: ""  # Auto-generated if empty

solr_support_user: "support"
solr_support_password: ""  # Auto-generated if empty

solr_moodle_user: "moodle"
solr_moodle_password: ""  # Auto-generated if empty

solr_auth_enabled: true
solr_auth_type: "basic"
solr_auth_realm: "Solr Eledia"
solr_forward_credentials: false
# ============================================================================
# HASH CONFIGURATION
# ============================================================================
solr_hash_salt_bytes: 32  # SHA256 requires 32 bytes
# ============================================================================
# RETRY & TIMEOUT CONFIGURATION
# ============================================================================
# Container deployment
solr_container_start_retries: 5
solr_container_start_delay: 5  # seconds
# Authentication validation
solr_auth_validation_retries: 5
solr_auth_validation_delay: 3  # seconds
# Core creation
solr_core_creation_retries: 5
solr_core_creation_delay: 3  # seconds
# Docker init-container timeout
solr_init_container_timeout: 60
# ============================================================================
# SOLR INTERNAL HEALTH CHECK CONFIGURATION (Solr 9.9.0 built-in)
# ============================================================================
# Enable/disable Solr's internal health check handler
# Endpoints: /admin/health (detailed) and /admin/healthcheck (simple)
solr_health_check_enabled: true

# Health check mode: basic, standard, comprehensive
# - basic:        Disk space only (minimal overhead)
# - standard:     Disk + Memory + Index health (RECOMMENDED)
# - comprehensive: All checks + Cache statistics + detailed metrics
solr_health_check_mode: "standard"

# Health check thresholds
solr_health_disk_threshold: 10       # Warn if less than X% disk space free
solr_health_memory_threshold: 90     # Warn if more than X% heap memory used
solr_health_cache_threshold: 75      # Warn if cache hit ratio below X% (comprehensive mode only)
# ============================================================================
# AUTOMATIC CUSTOMER NAME (must be defined BEFORE container/volume names)
# ============================================================================
customer_name: "{{ solr_app_domain.split('.')[0] if solr_app_domain is defined else 'default' }}"

# ============================================================================
# DOCKER CONFIGURATION
# ============================================================================
solr_version: "9.9.0"  # Upgrade to 9.10.0 validated and ready (100% compatible)
solr_major_version: "{{ solr_version.split('.')[0] }}"
solr_container_name: "solr_{{ customer_name }}"
solr_volume_name: "solr_data_{{ customer_name }}"
solr_network_name: "solr_network"
solr_create_systemd_service: false
solr_port: 8983
solr_jmx_port: 18983
# ============================================================================
# DIRECTORY CONFIGURATION
# ============================================================================
solr_compose_dir: "/opt/solr"
solr_config_dir: "{{ solr_compose_dir }}/config"
solr_data_dir: "/var/solr/data"
solr_backup_dir: "/var/solr/backup"
solr_backup_configs_dir: "{{ solr_backup_dir }}/configs"
solr_log_dir: "/var/log/eledia/solr"

# Config files to be deployed by init-container
solr_config_files:
  - name: "security.json"
    template: "security.json.j2"
    dest_path: "/var/solr/data"
    validate_json: true
  - name: "solrconfig.xml"
    template: "solrconfig.xml.j2"
    dest_path: "/var/solr/data/configs"
    validate_xml: true
  - name: "stopwords.txt"
    template: "stopwords.txt.j2"
    dest_path: "/var/solr/data/configs"
    validate_json: false
  - name: "stopwords_de.txt"
    template: "stopwords_de.txt.j2"
    dest_path: "/var/solr/data/configs"
    validate_json: false
  - name: "stopwords_en.txt"
    template: "stopwords_en.txt.j2"
    dest_path: "/var/solr/data/configs"
    validate_json: false
  - name: "synonyms.txt"
    template: "synonyms.txt.j2"
    dest_path: "/var/solr/data/configs"
    validate_json: false
  - name: "protwords.txt"
    template: "protwords.txt.j2"
    dest_path: "/var/solr/data/configs"
    validate_json: false
  - name: "moodle_schema.xml"
    template: "moodle_schema.xml.j2"
    dest_path: "/var/solr/data/configs"
    validate_xml: true

# Config backup settings
solr_backup_configs_enabled: true
solr_backup_configs_before_update: true
# ============================================================================
# CORE CONFIGURATION
# ============================================================================
# SINGLE-CORE MODE (Legacy/Default)
# Core name sanitization (max 50 chars including "_core" suffix, Solr allows up to 255)
# Logic: Take first 45 chars of domain/customer_name, sanitize, add "_core" suffix
solr_core_name_raw: "{{ solr_app_domain.split('.')[0] if solr_app_domain is defined else customer_name | default('default') }}"
solr_core_name_base: "{{ solr_core_name_raw[:45] | regex_replace('[^a-zA-Z0-9_]', '_') | lower }}"
solr_core_name: "{{ solr_core_name_base }}_core"
solr_core_config: "moodle_configs"

# ============================================================================
# MULTI-CORE MODE (v3.9.0+)
# ============================================================================
# Define multiple cores for multi-tenant Moodle setups
# Each core is isolated with its own index and can have dedicated users
# Cores share the same Solr JVM heap (dynamically allocated)
#
# WICHTIG: RAM-Kalkulation für Moodle mit File-Indexing:
# Basierend auf Apache Solr Best Practices 2024/2025:
#
# 16GB Server (solr_heap_size: "8g"):
# ├── JVM Heap:      8GB  (für Solr/Lucene)
# ├── OS Disk Cache: 6GB  (MMapDirectory - KRITISCH!)
# ├── System:        2GB  (Docker, OS)
# └── Per Core:      ~1.5-2GB effektiv (nach Cache-Overhead)
#     ├── ramBufferSizeMB: 100MB × Cores
#     ├── filterCache:     ~50MB × Cores (512 entries @ 12.5MB max)
#     ├── queryCache:      ~50MB × Cores
#     ├── documentCache:   ~50MB × Cores
#     ├── Misc/Temp:       4-6GB (global)
#     └── Working Memory:  Rest verfügbar
#
# EMPFEHLUNG 16GB Server: Max 4-5 Cores (sicher)
# EMPFEHLUNG 32GB Server: Max 10 Cores mit 20GB Heap
#
# Quelle: Apache Solr Memory Tuning (Cloudera), Moodle.org Forums,
#         Lucidworks Best Practices, Solr 9.x Performance Guide
#
# Example Configuration:
# solr_cores:
#   - name: "moodle_prod"
#     domain: "moodle-prod.kunde.de"
#     users:
#       - username: "moodle_prod_rw"
#         password: "{{ vault_prod_rw_password }}"  # Or "" for auto-generate
#         roles: ["core-admin-moodle_prod_core"]
#       - username: "moodle_prod_ro"
#         password: "{{ vault_prod_ro_password }}"
#         roles: ["support"]  # Read-only
#   - name: "moodle_test"
#     domain: "moodle-test.kunde.de"
#     users:
#       - username: "moodle_test"
#         password: ""  # Auto-generate secure password
#         roles: ["core-admin-moodle_test_core"]

# Multi-Core Liste (leer = Single-Core Mode)
solr_cores: []

# Multi-Core Mode Detection (automatisch gesetzt)
solr_multi_core_mode: "{{ (solr_cores | default([]) | length) > 0 }}"

# RAM Warning Thresholds (basierend auf Best Practices)
# 16GB Server mit 8GB Heap:
solr_max_cores_recommended: 4    # Sicher für 16GB RAM (8GB Heap)
solr_max_cores_limit: 6           # Absolutes Limit für 16GB RAM
solr_min_heap_per_core_mb: 1500  # Realistischer Mindestbedarf inkl. Caches

# 32GB Server mit 20GB Heap (für 10 Cores):
# solr_max_cores_recommended: 10
# solr_heap_size: "20g"
# solr_memory_limit: "28g"
# ============================================================================
# MONITORING & METRICS CONFIGURATION
# ============================================================================
solr_metrics_enabled: true
solr_health_check_interval: 30  # seconds
# Note: solr_health_check_timeout defined in retry section above
solr_metrics_path: "/admin/metrics"
solr_log_level: "INFO"  # DEBUG, INFO, WARN, ERROR

# ============================================================================
# BACKUP CONFIGURATION (UPDATED)
# ============================================================================
# Note: Diese Werte überschreiben die ursprünglichen weiter unten
solr_backup_enabled: true
solr_backup_schedule: "0 2 * * *"  # Daily at 2 AM
solr_backup_retention: 7  # days
solr_backup_path: "/var/solr/backup"
solr_backup_compress: true
solr_backup_credentials: false

# ============================================================================
# MEMORY CONFIGURATION (Optimized for 16GB Server, v3.9.0 Corrected)
# ============================================================================
# Server RAM: 16GB total
#
# KORRIGIERT basierend auf Best Practices 2024/2025:
# - Apache Solr Memory Tuning Guide (Cloudera)
# - Moodle.org: 10-20GB Heap für File-Indexing empfohlen
# - Regel: OS braucht 2× JVM Heap (8GB Heap = 16GB total minimum)
#
# Docker Container: 14GB (allocated to Solr)
#   ├── JVM Heap: 8GB (Solr application + caches)
#   └── OS File Cache: 6GB (Lucene MMapDirectory - KRITISCH!)
#
# Host OS: 2GB (outside container - system processes, Docker overhead)
#
# Memory Split Strategy:
# - Heap: 8GB (50% of total) - JVM für Solr/Lucene + Per-Core Caches
# - File Cache: 6GB (37.5%) - Memory-mapped Lucene index segments
# - OS Buffer: 2GB (12.5%) - System processes, Docker
#
# Why this configuration?
# 1. Lucene segments sind memory-mapped (off-heap) via MMapDirectory
# 2. Caches sind PER-CORE: filterCache, queryCache, documentCache
# 3. ramBufferSizeMB ist PER-CORE: 100MB × Cores
# 4. Multi-Core braucht mehr Heap: 4 Cores × ~2GB = 8GB minimum
# 5. OS File Cache kritisch für Query Performance (30%+ Verbesserung)
#
# Multi-Core Impact (WICHTIG!):
# Single-Core:  8GB Heap = ~7GB verfügbar für Arbeit
# 4 Cores:      8GB Heap = ~1.5GB pro Core (nach Cache-Overhead)
# 6 Cores:      8GB Heap = ~1GB pro Core (LIMIT!)
#
# Performance Tuning für mehr Cores:
# - Für 10 Cores: 32GB Server, 20GB Heap, 8GB File Cache
# - Monitor: docker stats, /admin/metrics, GC logs
#
# IMPORTANT: Default values are conservative (2GB heap) to work on most systems.
# For production with sufficient RAM, override in host_vars:
#   solr_heap_size: "8g"
#   solr_memory_limit: "14g"
#   solr_memory_reservation: "12g"

solr_heap_size: "2g"
solr_memory_limit: "4g"  # Container limit: Heap (2g) + Off-heap (2g)
solr_memory_swap: "4g"   # Swap limit matches memory limit
solr_memory_reservation: "3g"  # Soft limit to prevent OOM

# GC & Performance Optimizations (Default: 2GB Heap, tune for larger heaps)
# G1GC is recommended for Solr 9.x with heaps 2GB+ (Stop-the-world <1s goal)
solr_gc_options: >-
  -XX:+UseG1GC
  -XX:+ParallelRefProcEnabled
  -XX:G1HeapRegionSize=16m
  -XX:MaxGCPauseMillis=200
  -XX:InitiatingHeapOccupancyPercent=45
  -XX:G1ReservePercent=10
  -XX:+DisableExplicitGC
  -XX:+AlwaysPreTouch

# JVM Options (KORRIGIERT v3.9.0)
# ENTFERNT: autoCommit/autoSoftCommit (Konflikt mit solrconfig.xml!)
# Diese Werte werden in solrconfig.xml.j2 konfiguriert, NICHT hier
solr_jvm_opts: >-
  -server
  -Djava.awt.headless=true
  -Dfile.encoding=UTF-8
  -Djava.net.preferIPv4Stack=true

# CPU Configuration (100% = 1 core, 400% = 4 cores)
# Allocate 4 cores for Solr
solr_cpu_quota: 400000
solr_cpu_period: 100000
# ============================================================================
# PROXY CONFIGURATION (v3.8.1+)
# ============================================================================
solr_proxy_enabled: false
solr_proxy_path: "/solr-admin"
solr_webserver: "apache"  # Options: "apache" | "nginx"
solr_proxy_auth_enabled: false  # Additional Basic Auth on proxy level
solr_restrict_admin: true  # Restrict admin access to specific IPs
solr_admin_allowed_ips: []  # List of allowed IPs for admin access
# Config file naming: solr.{{ solr_app_domain }}.conf (e.g., solr.kunde.de.conf)
# ============================================================================
# SSL CONFIGURATION (Let's Encrypt)
# ============================================================================
solr_ssl_enabled: false
solr_ssl_cert_path: "/etc/letsencrypt/live/{{ solr_app_domain | default('localhost') }}"
# Install Let's Encrypt certificates with:
#   Apache: sudo certbot --apache -d {{ solr_app_domain }}
#   Nginx:  sudo certbot --nginx -d {{ solr_app_domain }}
# HTTPS availability tested with up to 10 retries
# ============================================================================
# SOLR SETTINGS (v3.9.0 Optimized)
# ============================================================================
# maxBooleanClauses: Solr 9.x default ist 1024, aber Moodle mit edismax
# und vielen qf/pf fields braucht höheren Wert (Best Practice: 2048-10000)
solr_max_boolean_clauses: 2048
solr_auto_commit_time: 15000  # milliseconds (Hard commit)
solr_auto_soft_commit_time: 1000  # milliseconds (NRT visibility)
# Note: solr_log_level defined in MONITORING section above
# ============================================================================
# MOODLE CONFIGURATION
# ============================================================================
solr_multi_version_cores: true

solr_moodle_versions_config:
  "4.1":
    max_field_length: 32766
    use_legacy_date: false
    features: ["basic_search", "file_indexing"]
  "4.2":
    max_field_length: 32766
    use_legacy_date: false
    features: ["basic_search", "file_indexing", "multilang"]
  "4.3":
    max_field_length: 32766
    use_legacy_date: false
    features: ["basic_search", "file_indexing", "multilang", "categories"]
  "4.4":
    max_field_length: 65536
    use_legacy_date: false
    features: ["basic_search", "file_indexing", "multilang", "categories", "completion"]
  "5.0":
    max_field_length: 65536
    use_legacy_date: false
    features: ["basic_search", "file_indexing", "multilang", "categories", "completion", "competencies", "outcomes", "tags"]
  "5.0.x":
    max_field_length: 65536
    use_legacy_date: false
    features: ["basic_search", "file_indexing", "multilang", "categories", "completion", "competencies", "outcomes", "tags"]

solr_use_moodle_schema: true
solr_moodle_test_docs: true
solr_moodle_versions: ["4.1", "4.2", "4.3", "4.4", "5.0.x"]
# ============================================================================
# DEPLOYMENT FLAGS
# ============================================================================
solr_force_recreate: false
solr_force_pull: false
solr_force_reconfigure_auth: true
solr_validate_deployment: true
# ============================================================================
# SYSTEM REQUIREMENTS
# ============================================================================
solr_min_disk_space_gb: 5
solr_min_memory_gb: 2
# ============================================================================
# DOCKER API
# ============================================================================
docker_api_version: "1.41"
docker_timeout: 60
docker_compose_version: "2.0"
# ============================================================================
# APPLICATION PATHS
# ============================================================================
# Note: customer_name moved to line 93 (before DOCKER CONFIGURATION)
moodle_solr_host: "localhost"
moodle_solr_port: "{{ solr_port }}"
moodle_solr_secure: false
moodle_solr_username: "{{ solr_moodle_user }}"
moodle_env: "public_html"
moodle_eledia_path: "/home/vhosts/moodle"
moodle_config_path: "{{ moodle_eledia_path }}/{{ solr_app_domain }}/{{ moodle_env }}/config.php"
# Note: customer_name moved to line 91 (before DOCKER CONFIGURATION)
# ============================================================================
# RUNDECK INTEGRATION
# ============================================================================
rundeck_integration_enabled: false
rundeck_api_url: ""
rundeck_api_token: ""
rundeck_api_version: "40"
rundeck_project_name: ""
rundeck_webhook_enabled: false
rundeck_webhook_secret: ""
# ============================================================================
# NOTIFICATION
# ============================================================================
notification_enabled: false
admin_email: ""
# ============================================================================
# USER MANAGEMENT
# ============================================================================
# Additional Solr users beyond the built-in admin/support/moodle
# Each user should have: username, password, and optionally roles
# If roles are not specified, user will receive the per-core admin role
solr_additional_users: []
# Example:
# solr_additional_users:
#   - username: "tenant1_admin"
#     password: "secure_password"
#     roles: ["core-admin-tenant1"]
#   - username: "tenant2_admin"
#     password: "secure_password"
#     # roles will default to ["core-admin-<core_name>"]

# Prefix for automatically generated per-core administrator roles
solr_core_admin_role_prefix: "core-admin"
