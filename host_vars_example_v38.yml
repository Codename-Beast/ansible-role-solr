---
#######################################################################
# Solr Host Variables - v38 (Production Ready)
# Server: srh-ecampus.de.solr.elearning-home.de
# Purpose: Moodle Search Engine
# Memory: 16GB Server (6GB Heap + 6GB Off-Heap = 12GB Solr, 4GB OS)
#######################################################################

#######################################################################
# SYSTEM CLASSIFICATION
#######################################################################
system_type:
  - DBMS
  - Solr

#######################################################################
# CORE CONFIGURATION (PFLICHT)
#######################################################################
# Domain für Solr (KORRIGIERT von moodle_app_domain!)
solr_app_domain: "srh-ecampus.de.solr.elearning-home.de"

# Solr Port (Standard: 8983)
solr_port: 8983

# Core Name (nur Buchstaben, Zahlen, Unterstriche - max 10 Zeichen empfohlen)
solr_core_name: "srhecampus"

# Container Name (Prefix: hc- für "host container")
solr_container_name: "hc-srhecampus-solr"

# Solr Version (empfohlen: latest oder 9.9.0)
solr_version: "9.9.0"

#######################################################################
# AUTHENTICATION (PFLICHT - Security enabled)
#######################################################################
solr_auth_enabled: true

# Admin User (voller Zugriff)
solr_admin_user: "admin"
solr_admin_password: "!hj0iuoefeufhefuj!"  # TODO: Mit Ansible Vault verschlüsseln!

# Support User (Read-Only Zugriff)
solr_support_user: "support"
solr_support_password: "!hj0iuoefeufhefuj!"  # TODO: Mit Ansible Vault verschlüsseln!

# Moodle User (KORRIGIERT von solr_customer_password!)
solr_moodle_user: "moodle"
solr_moodle_password: "efr!ojF!feiXjfeFoj"  # TODO: Mit Ansible Vault verschlüsseln!

# Auth Realm (Anzeigename bei Login)
solr_auth_realm: "SRH eCampus Solr"

#######################################################################
# MULTI-TENANT USER MANAGEMENT (OPTIONAL - v38 Feature!)
#######################################################################
# Zusätzliche User für Multi-Tenancy
# Nutzen Sie: ansible-playbook site.yml --tags=solr-auth-reload (Zero-Downtime!)
solr_additional_users:
  # Beispiel: Developer/Test User
  - username: "dev_admin"
    password: "DevSecurePass123!"  # TODO: Vault nutzen!
    roles: ["core-admin-{{ solr_core_name }}"]

  # Beispiel: Read-Only User für Monitoring
  - username: "monitoring"
    password: "MonitorPass456!"
    roles: ["support"]

  # Beispiel: API User für externe Integration
  # - username: "api_integration"
  #   password: "ApiKey789!"
  #   roles: ["moodle"]

# Core Admin Role Prefix (Standard: "core-admin")
solr_core_admin_role_prefix: "core-admin"

#######################################################################
# MEMORY CONFIGURATION (16GB Server Optimierung)
#######################################################################
# JVM Heap Size (empfohlen: 50% von verfügbarem RAM für Solr)
solr_heap_size: "6g"

# Docker Memory Limit (Heap + Off-Heap für Lucene Index Cache)
solr_memory_limit: "12g"

# Memory Swap Limit (sollte = memory_limit sein)
solr_memory_swap: "12g"

# Memory Reservation (garantierte Mindestmenge)
solr_memory_reservation: "10g"

# CPU Configuration
solr_cpu_count: "4"           # Anzahl CPU Cores
solr_cpuset_cpus: "0-3"      # CPU Pinning (optional)

# Memory Swappiness (0-100, niedrig = weniger Swap-Nutzung)
solr_mem_swappiness: 10

#######################################################################
# GARBAGE COLLECTION (G1GC Tuning für 6GB Heap)
#######################################################################
solr_gc_options: >-
  -XX:+UseG1GC
  -XX:+ParallelRefProcEnabled
  -XX:G1HeapRegionSize=16m
  -XX:MaxGCPauseMillis=200
  -XX:InitiatingHeapOccupancyPercent=45
  -XX:G1ReservePercent=10
  -XX:+DisableExplicitGC
  -XX:+AlwaysPreTouch

# GC Logging
solr_gc_log_opts: "-Xlog:gc*:file=/var/solr/logs/solr_gc.log:time,uptime:filecount=9,filesize=20M"

#######################################################################
# MOODLE INTEGRATION
#######################################################################
# Moodle Schema verwenden (empfohlen für Moodle-Installation)
solr_use_moodle_schema: true

# Moodle Schema Datei (liegt in files/)
solr_moodle_schema_file: "moodle_schema.xml"

# Classic Schema Factory (WICHTIG für Moodle - Fixed Schema!)
solr_schema_factory: "ClassicIndexSchemaFactory"

#######################################################################
# APACHE REVERSE PROXY
#######################################################################
solr_proxy_enabled: true

# Proxy Path (URL-Pfad für externen Zugriff)
solr_proxy_path: "/solr-admin"

# Proxy Auth (zusätzliche Apache Basic Auth - optional)
solr_proxy_auth_enabled: false
# solr_proxy_htpasswd_users:
#   - username: "webadmin"
#     password: "WebAdminPass123!"

# Admin IP Restrictions (nur diese IPs dürfen auf /solr-admin/admin zugreifen)
solr_restrict_admin: true
solr_admin_allowed_ips:
  - "127.0.0.1"
  - "::1"
  # Fügen Sie hier Ihre Office-IPs hinzu:
  # - "203.0.113.0/24"    # Beispiel: Büro-Netzwerk
  # - "198.51.100.50"     # Beispiel: VPN-Gateway

#######################################################################
# SSL/TLS CONFIGURATION
#######################################################################
# SSL wird typischerweise vom Apache Reverse Proxy gehandhabt
# Solr selbst läuft auf localhost ohne SSL
solr_ssl_enabled: false

#######################################################################
# DIRECTORIES & PATHS
#######################################################################
# Basis-Verzeichnis für Solr-Daten
solr_base_dir: "/opt/solr"

# Data Directory (persistente Daten)
solr_data_dir: "{{ solr_base_dir }}/data"

# Config Directory (security.json, etc.)
solr_config_dir: "{{ solr_base_dir }}/config"

# Logs Directory
solr_log_dir: "{{ solr_base_dir }}/logs"

# Backup Directory
solr_backup_dir: "{{ solr_base_dir }}/backups"

# User/Group für Dateien
solr_user: "solr"
solr_group: "solr"
solr_uid: "8983"
solr_gid: "8983"

#######################################################################
# DOCKER COMPOSE CONFIGURATION
#######################################################################
# Docker Compose Projekt Name
solr_compose_project_name: "srhecampus-solr"

# Docker Compose Datei Pfad
solr_compose_file: "{{ solr_base_dir }}/docker-compose.yml"

# Docker Network
solr_docker_network: "solr_network"

# Restart Policy
solr_restart_policy: "unless-stopped"

#######################################################################
# HEALTH CHECKS
#######################################################################
# Health Check Interval
solr_healthcheck_interval: "30s"

# Health Check Timeout
solr_healthcheck_timeout: "10s"

# Health Check Retries
solr_healthcheck_retries: 3

# Health Check Start Period (Zeit bis erster Check)
solr_healthcheck_start_period: "60s"

#######################################################################
# LOGGING
#######################################################################
# Log Level (INFO, WARN, ERROR, DEBUG)
solr_log_level: "INFO"

# Log Rotation
solr_log_max_size: "100m"
solr_log_max_files: 10

#######################################################################
# PERFORMANCE TUNING
#######################################################################
# Cache Sizes (in MB oder als Prozent)
solr_query_result_cache_size: 512
solr_document_cache_size: 512
solr_filter_cache_size: 512

# Auto Commit Settings (Sekunden)
solr_autocommit_max_time: 15000     # 15 Sekunden
solr_autosoftcommit_max_time: 1000  # 1 Sekunde

# Max Boolean Clauses (für komplexe Queries)
solr_max_boolean_clauses: 1024

#######################################################################
# BACKUP CONFIGURATION (OPTIONAL - aktuell auskommentiert in main.yml)
#######################################################################
# solr_backup_enabled: true
# solr_backup_schedule: "0 2 * * *"  # Täglich um 2 Uhr
# solr_backup_retention_days: 7
# solr_backup_location: "{{ solr_backup_dir }}"

#######################################################################
# RUNDECK INTEGRATION (OPTIONAL)
#######################################################################
# Nur aktivieren wenn Rundeck vorhanden
rundeck_integration_enabled: false
# rundeck_project: "solr-automation"
# rundeck_job_group: "solr-maintenance"

#######################################################################
# TESTING & VALIDATION
#######################################################################
# Integration Tests aktivieren
solr_run_integration_tests: true

# Moodle Document Tests (nur wenn solr_use_moodle_schema: true)
solr_run_moodle_tests: true

# Test-Dokumente für Validierung
solr_test_documents:
  - title: "Test Document 1"
    content: "This is a test document for Solr"
  - title: "Test Document 2"
    content: "Another test document with different content"

#######################################################################
# ADVANCED SETTINGS (für Experten)
#######################################################################
# JVM Additional Options
solr_jvm_opts: >-
  -Dsolr.jetty.request.header.size=65536
  -Dsolr.jetty.threads.min=10
  -Dsolr.jetty.threads.max=10000
  -Dsolr.jetty.threads.idle.timeout=120000

# Solr Environment Variables (zusätzliche)
solr_env_vars:
  SOLR_TIMEZONE: "Europe/Berlin"
  # SOLR_SSL_ENABLED: "false"
  # SOLR_SSL_KEY_STORE: "/var/solr/keystore.jks"

# Config Template Overrides (falls Sie eigene Templates nutzen)
# solr_security_template: "custom_security.json.j2"
# solr_solrconfig_template: "custom_solrconfig.xml.j2"

#######################################################################
# FEATURE FLAGS
#######################################################################
# Auth Persistence (Passwörter in host_vars speichern)
skip_auth_persistence: false

# Skip Auth komplett (NUR für Entwicklung!)
skip_auth: false

# Force Container Rebuild
force_container_rebuild: false

#######################################################################
# MONITORING & METRICS (OPTIONAL)
#######################################################################
# Prometheus Exporter (falls vorhanden)
# solr_prometheus_enabled: false
# solr_prometheus_port: 9854

# Grafana Dashboard (falls vorhanden)
# solr_grafana_dashboard_enabled: false

#######################################################################
# SECURITY HARDENING
#######################################################################
# Forward Credentials (für Proxy-Chains)
solr_forward_credentials: false

# Block Unknown Users (Auth)
solr_block_unknown: true

# IP Whitelist für Container-Zugriff (optional)
# solr_allowed_ips:
#   - "10.0.0.0/8"
#   - "172.16.0.0/12"

#######################################################################
# DEPLOYMENT SETTINGS
#######################################################################
# Init Container Wait Time (Sekunden)
solr_init_wait_time: 30

# Container Start Timeout (Sekunden)
solr_container_start_timeout: 120

# Retry Settings
solr_task_retries: 3
solr_task_retry_delay: 10

#######################################################################
# DOCKER REGISTRY (falls private Registry)
#######################################################################
# solr_docker_registry: "registry.example.com"
# solr_docker_registry_username: "user"
# solr_docker_registry_password: "pass"

#######################################################################
# FINALIZATION
#######################################################################
# Cleanup after deployment
solr_cleanup_temp_files: true

# Display Summary
solr_display_summary: true

# Send Notifications (falls konfiguriert)
# solr_notify_on_completion: false
# solr_notification_webhook: "https://hooks.slack.com/services/..."

#######################################################################
# NOTIZEN / COMMENTS
#######################################################################
# TODO Liste für Production:
# 1. [ ] Alle Passwörter mit ansible-vault verschlüsseln
# 2. [ ] SSL-Zertifikate für Apache Proxy einrichten
# 3. [ ] Backup-Strategy aktivieren und testen
# 4. [ ] Monitoring (Prometheus/Grafana) einrichten
# 5. [ ] Admin-IP Whitelist mit echten Office-IPs füllen
# 6. [ ] Test-User (dev_admin, monitoring) entfernen oder Passwörter ändern
# 7. [ ] Log-Rotation in Logrotate einbinden
# 8. [ ] Disaster Recovery Plan dokumentieren

#######################################################################
# QUICK START
#######################################################################
# 1. Vollständige Installation:
#    ansible-playbook site.yml -e 'hosts=srh-ecampus-solr'
#
# 2. User hinzufügen (Zero-Downtime):
#    ansible-playbook site.yml -e 'hosts=srh-ecampus-solr' --tags=solr-auth-reload
#
# 3. Nur Tests:
#    ansible-playbook site.yml -e 'hosts=srh-ecampus-solr' --tags=install-solr-test
#
# 4. Mit Vault:
#    ansible-playbook site.yml -e 'hosts=srh-ecampus-solr' --ask-vault-pass
#######################################################################
